å¤§å®¶å¥½ï¼Œæ¬¢è¿æ¥åˆ°å°èœåŒå­¦çš„ä¸ªäºº **solo** å­¦å ‚ï¼ŒçŸ¥è¯†å…è´¹ï¼Œä¸åå¸æ”¶ï¼å…³æ³¨å…è´¹ï¼Œä¸ååŠ¨æ‰‹ï¼


![](https://user-gold-cdn.xitu.io/2020/4/11/17169c46045528af?w=240&h=224&f=jpeg&s=7529)


>æœ¬æ–‡ä¸»è¦ä»‹ç» `åˆ†å¸ƒå¼äº‹åŠ¡`
>
>å¦‚æœ‰éœ€è¦ï¼Œå¯ä»¥å‚è€ƒ
>
>å¦‚æœ‰å¸®åŠ©ï¼Œä¸å¿˜ **ç‚¹èµ** â¥
>
>
>å¾®ä¿¡å…¬ä¼—å·å·²å¼€å¯ï¼Œ**å°èœè‰¯è®°**ï¼Œæ²¡å…³æ³¨çš„åŒå­¦ä»¬è®°å¾—å…³æ³¨å“¦ï¼

`ç”Ÿæ´»å¯èƒ½å¯¹ä½ è€æ— èµ–ï¼Œä½†ç§‘æŠ€ä¸èƒ½`

æˆ‘å»å°å–éƒ¨ä¹°ä¸œè¥¿ï¼Œä»˜å®Œäº†é’±ï¼Œè€æ¿è½¬èº«æŠ½äº†å£çƒŸï¼Œå´å¿˜è®°äº†æˆ‘ä»˜å®Œé’±ï¼Ÿè¿™ç§æƒ…å†µæ€ä¹ˆåŠï¼Œå‘ç”Ÿåœ¨æ—¥å¸¸ç”Ÿæ´»å¹¶ä¸å¥‡æ€ªã€‚ä½†æ˜¯ä½ åœ¨ç½‘ä¸Šä¸‹å•ï¼Œä»˜å®Œäº†é’±ï¼Œåˆšè¦æŸ¥çœ‹è®¢å•ï¼Œå´æç¤ºä½ å¾…æ”¯ä»˜ï¼Œå¿ƒä¸­å‡ ä¸‡åªè‰æ³¥é©¬è·‘è¿‡ä¹Ÿä¸å¾—è€ŒçŸ¥ï¼æ‰€ä»¥é˜²æ­¢è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼Œåˆ†å¸ƒå¼äº‹åŠ¡ä¹Ÿå˜å¾—å°¤ä¸ºé‡è¦ã€‚

æœ‰äººçº³é—·äº†ï¼Œä»˜ä¸ä»˜é’±è·Ÿåˆ†å¸ƒå¼äº‹åŠ¡æœ‰ä»€ä¹ˆå…³ç³»ï¼Œè¿™ä¸æ˜¯ç¨‹åºè€æ— èµ–å—ï¼Ÿä½†æ˜¯è€æ— èµ–çš„èƒŒåå´æ˜¯å› ä¸ºåˆ†å¸ƒå¼äº‹åŠ¡åœ¨ä½œç¥Ÿï¼å¦‚æœè¿˜ä¸æ˜ç™½ï¼Œé‚£å¯èƒ½ä½ è¿˜æ²¡æ˜ç™½ä»€ä¹ˆæ˜¯äº‹åŠ¡ï¼Œä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡~

### åˆ†å¸ƒå¼äº‹åŠ¡

#### å®šä¹‰

äº‹åŠ¡æä¾›ä¸€ç§æœºåˆ¶å°†ä¸€ä¸ªæ´»åŠ¨æ¶‰åŠçš„æ‰€æœ‰æ“ä½œéƒ½çº³å…¥åˆ°ä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ‰§è¡Œå•å…ƒï¼Œç»„æˆäº‹åŠ¡çš„ç¥æ‰€æœ‰æ“ä½œåªæœ‰åœ¨æ“ä½œå‡æ­£å¸¸æ‰§è¡Œçš„æƒ…å†µä¸‹æ‰èƒ½æäº¤ï¼Œåªè¦å…¶ä¸­ä»»ä¸€æ“ä½œæ‰§è¡Œå¤±è´¥ï¼Œéƒ½ä¼šå¯¼è‡´æ•´ä¸ªäº‹åŠ¡çš„å›æ»šã€‚ç®€å•æ¥è¯´ï¼Œ`è¦ä¹ˆåšï¼Œè¦ä¹ˆä¸åš`ã€‚

å¬èµ·æ¥æœ‰ç‚¹ `man`ï¼Œä¸è¦è¿·æ‹ï¼Œå…ˆæ¥äº†è§£ä¸€ä¸‹äº‹åŠ¡çš„å››å¤§ç‰¹æ€§ï¼š`ACID`

- **Aï¼ˆAtomicï¼‰**ï¼šåŸå­æ€§ï¼Œæ„æˆäº‹ç‰©çš„æ‰€æœ‰æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œå®Œæˆï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œï¼Œä¸å¯èƒ½å‡ºç°éƒ¨åˆ†æˆåŠŸéƒ¨åˆ†å¤±è´¥çš„æƒ…å†µã€‚
- **Cï¼ˆConsistencyï¼‰**ï¼šä¸€è‡´æ€§ï¼Œåœ¨äº‹åŠ¡æ‰§è¡Œå‰åï¼Œæ•°æ®åº“çš„ä¸€è‡´æ€§çº¦æŸæ²¡æœ‰è¢«ç ´åã€‚ä¸€æ—¦æ‰€æœ‰äº‹åŠ¡åŠ¨ä½œå®Œæˆï¼Œäº‹åŠ¡å°±è¢«æäº¤ï¼Œæ•°æ®å’Œèµ„æºå¤„äºä¸€ç§æ»¡è¶³ä¸šåŠ¡è§„åˆ™çš„ä¸€è‡´æ€§çŠ¶æ€ä¸­ã€‚æ¯”å¦‚ä¸Šé¢è¯´çš„ï¼Œæˆ‘å‘å•†åº—è€æ¿ä»˜äº†é’±ï¼Œæˆ‘è¿™è¾¹æ‰£é™¤äº†100ï¼Œè€Œè€æ¿å¢åŠ äº†100ï¼Œè¿™ç§å°±ç§°ä¸ºä¸€è‡´æ€§ã€‚
- **Iï¼ˆIsolationï¼‰**ï¼šéš”ç¦»æ€§ï¼Œæ•°æ®åº“ä¸­çš„äº‹åŠ¡ä¸€èˆ¬éƒ½æ˜¯å¹¶å‘çš„ï¼Œéš”ç¦»æ€§æ˜¯æŒ‡å¹¶å‘çš„ä¸¤ä¸ªäº‹åŠ¡äº’ä¸å¹²æ‰°ï¼Œä¸€ä¸ªäº‹åŠ¡ä¸èƒ½çœ‹åˆ°å…¶ä»–äº‹åŠ¡è¿è¡Œè¿‡ç¨‹çš„ä¸­é—´çŠ¶æ€ï¼Œé€šè¿‡é…ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«å¯ä»¥é¿å…åœ¨è„è¯»ã€å¹»è¯»ã€ä¸å¯é‡å¤è¯»ç­‰é—®é¢˜ã€‚
- **Dï¼ˆDurabilityï¼‰**ï¼šæŒä¹…æ€§ï¼Œäº‹åŠ¡å®Œæˆä¹‹åï¼Œè¯¥äº‹åŠ¡å¯¹æ•°æ®çš„æ›´æ”¹ä¼šæŒä¹…åŒ–åˆ°æ•°æ®åº“ä¸­ï¼Œå¹¶ä¸”ä¸ä¼šè¢«å›æ»š

##### å•ä½“äº‹åŠ¡

æ—©æœŸæˆ‘ä»¬ä½¿ç”¨çš„è¿˜æ˜¯å•ä½“æ¶æ„ï¼Œåƒæ˜¯ä¸€ä¸ªå¤§å®¶æ—ï¼Œå…¶ä¹èèçš„ç”Ÿæ´»åœ¨ä¸€èµ·æ—¥å¤œè€•ä½œã€‚

![](https://gitee.com/cbuc/picture/raw/master/20210319124841.png)

æ—¶é—´ä¹…äº†ï¼Œå„ç§å„æ ·çš„é—®é¢˜è‡ªç„¶è€Œç„¶çš„ä¹Ÿå‡ºç°äº†ï¼š`å¤æ‚æ€§é«˜ï¼Œéƒ¨ç½²é¢‘ç‡ä½ï¼Œå¯é æ€§å·®ï¼Œæ‰©å±•èƒ½åŠ›å—é™...` æ‰¿å—äº†å¤ªå¤šä¸è¯¥æ‰¿å—çš„æµè¨€èœšè¯­ï¼Œè€Œå¤§å®¶ä¹Ÿé€æ¸æ‰¾å¯»æ–°çš„å‡ºè·¯ï¼Œ é‚£å¾®æœåŠ¡æ¶æ„ä¹Ÿä¾¿å—åº”å‡ºç°ï¼š`æ˜“äºå¼€å‘ã€æ‰©å±•ã€ç†è§£å’Œç»´æŠ¤ï¼Œä¸ä¼šå—é™äºä»»ä½•æŠ€æœ¯æ ˆï¼Œæ˜“äºå’Œç¬¬ä¸‰æ–¹åº”ç”¨ç³»ç»Ÿé›†æˆ...` å¤ªå¤šå¤ªå¤šçš„ä¼˜ç‚¹ï¼Œè®©å•ä½“ç³»ç»Ÿä¹Ÿé€æ¸æ·¡å‡ºäººä»¬çš„è§†è§’ï¼Œå¥½åƒå¦‚æœç°åœ¨ä¸ç”¨å¾®æœåŠ¡æ¶æ„å¼€å‘é¡¹ç›®ï¼Œå°±ä¸ç¤¾ä¼šè„±èŠ‚äº†~ å¥½å¤„å¾ˆå¤šï¼Œä½†æ˜¯é—®é¢˜ä¹Ÿä¼šå˜å¾—æ›´åŠ å¤æ‚ã€‚è¿™èŠ‚æˆ‘ä»¬ä¸è®²åˆ«çš„ï¼Œå°±æ¥çœ‹çœ‹åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯å’‹å›äº‹ã€‚

äº‹åŠ¡æ— è®ºåœ¨å•ä½“è¿˜æ˜¯å¾®æœåŠ¡ä¸­éƒ½è‚¯å®šæ˜¯å­˜åœ¨ï¼Œä½†æ˜¯åœ¨ **å•ä½“** æ¶æ„ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸æ˜¯æ€ä¹ˆè§£å†³äº‹åŠ¡çš„å‘¢ï¼Ÿ `@Transactional`ï¼Œå•é è¿™ä¸ªæ³¨è§£å°±å¯ä»¥å¼€å¯äº‹åŠ¡æ¥ä¿è¯æ•´ä¸ªæ“ä½œçš„ `åŸå­æ€§`ã€‚

##### åˆ†å¸ƒå¼äº‹åŠ¡

å¾®æœåŠ¡æ¶æ„ï¼Œå…¶å®å°±æ˜¯å°†ä¼ ç»Ÿçš„å•ä½“æ‹†åˆ†æˆå¤šä¸ªæœåŠ¡ï¼Œç„¶åå¤šä¸ªæœåŠ¡ä¹‹é—´ç›¸äº’é…åˆï¼Œæ¥å®Œæˆä¸šåŠ¡éœ€æ±‚ã€‚

![](https://gitee.com/cbuc/picture/raw/master/20210319130155.png)

åˆ†å¸ƒå¼äº‹åŠ¡å°±æ˜¯æŒ‡äº‹åŠ¡çš„å‚ä¸è€…ï¼Œæ”¯æŒäº‹åŠ¡çš„æœåŠ¡å™¨ï¼Œèµ„æºæœåŠ¡å™¨ä»¥åŠäº‹åŠ¡ç®¡ç†å™¨åˆ†åˆ«ä½äºä¸åŒçš„åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸åŒèŠ‚ç‚¹ä¹‹ä¸Šã€‚

æ—¢ç„¶è¯´åˆ°åˆ†å¸ƒå¼äº‹åŠ¡äº†ï¼Œæˆ‘ä»¬ä¸å¦¨ä¸€èµ·äº†è§£ä¸€ä¸‹å¾®æœåŠ¡ä¸­çš„ **CAPç†è®º**

- **Cï¼ˆConsistencyï¼‰**ï¼šä¸€è‡´æ€§ã€‚æœåŠ¡Aã€Bã€Cä¸‰ä¸ªèŠ‚ç‚¹éƒ½å­˜å‚¨äº†ç”¨æˆ·æ•°æ®ï¼Œä¸‰ä¸ªèŠ‚ç‚¹çš„æ•°æ®éƒ½éœ€è¦ä¿æŒåŒä¸€æ—¶åˆ»æ•°æ®ä¸€è‡´æ€§
- **Aï¼ˆAvailabilityï¼‰**ï¼šå¯ç”¨æ€§ã€‚æœåŠ¡Aã€Bã€Cä¸‰ä¸ªèŠ‚ç‚¹ï¼Œå…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹å¦‚æœå®•æœºäº†ï¼Œä¸èƒ½å½±å“æ•´ä¸ªé›†ç¾¤å¯¹å¤–æä¾›æœåŠ¡ã€‚
- **Pï¼ˆPartition Toleranceï¼‰**ï¼šåˆ†åŒºå®¹é”™æ€§å°±æ˜¯å…è®¸ç³»ç»Ÿé€šè¿‡ç½‘ç»œååŒå·¥ä½œï¼Œåˆ†åŒºå®¹é”™æ€§è¦è§£å†³ç”±äºç½‘ç»œåˆ†åŒºå¯¼è‡´æ•°æ®çš„ä¸å®Œæ•´åŠæ— æ³•è®¿é—®ç­‰é—®é¢˜ã€‚

æˆ‘ä»¬éƒ½çŸ¥é“é±¼å’Œç†ŠæŒä¸å¯å…¼å¾—ï¼Œä¸‰è€…ä¸èƒ½å…¼å¤‡æ‹©ä¸¤è€…æ˜¯ä¹Ÿï¼**CAP** ç›®å‰æ¥è¯´æ— æ³•éƒ½å…¼å¤‡ï¼Œå› æ­¤å½“å‰å¾®æœåŠ¡ç­–ç•¥ä¸­è¦ä¹ˆ `CA`ï¼Œè¦ä¹ˆ`CP`ï¼Œä¸ç„¶å°±æ˜¯`AP`ã€‚è€Œè¿™ä¸ªæ—¶å€™åˆæœ‰ä¸€ä¸ªç†è®ºå‡ºç°äº†ï¼Œé‚£å°±æ˜¯ **BASEç†è®º** ã€‚å®ƒæ˜¯ç”¨æ¥å¯¹ **CAPç†è®º** è¿›è¡Œä¸€äº›è¡¥å……ï¼Œå®ƒå€¼å¾—æ˜¯ï¼š

- **BAï¼ˆBasically Availableï¼‰**ï¼šåŸºæœ¬å¯ç”¨
- **Sï¼ˆSoft Stateï¼‰**ï¼šè½¯çŠ¶æ€
- **Eï¼ˆEventually Consistentï¼‰**ï¼šæœ€ç»ˆä¸€è‡´æ€§

è¿™ä¸ªç†è®ºçš„æ ¸å¿ƒæ€æƒ³ä¾¿æ˜¯ï¼šå¦‚æœæˆ‘ä»¬å¦‚æ³•åšåˆ°å¼ºä¸€è‡´æ€§ï¼Œé‚£ä¹ˆæ¯ä¸ªåº”ç”¨éƒ½åº”è¯¥æ ¹æ®è‡ªèº«çš„ä¸šåŠ¡ç‰¹ç‚¹ï¼Œé‡‡ç”¨é€‚å½“çš„æ–¹å¼æ¥ä½¿ç³»ç»Ÿè¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ã€‚

#### å‡ºç°åœºæ™¯

è®©æˆ‘ä»¬å›åˆ°åˆ†å¸ƒå¼äº‹åŠ¡ä¸­æ¥ï¼Œä»€ä¹ˆæ—¶å€™ä¼šå‡ºç°åˆ†å¸ƒå¼äº‹åŠ¡å‘¢ï¼Ÿ

**åœºæ™¯1ï¼š** è™½ç„¶æ—¶å•ä½“çš„æ¶æ„æœåŠ¡ï¼Œä½†ç”±äºåœ¨åˆ†åº“çš„æƒ…å†µä¸‹ï¼Œä¾ç„¶ä¼šå¯¼è‡´åˆ†å¸ƒå¼äº‹åŠ¡çš„æƒ…å†µï¼Œå› æ­¤å•ä½“æœåŠ¡ä¸ä¼šå‡ºç°åˆ†å¸ƒå¼äº‹åŠ¡çš„è¿™ç§è¯´æ³•ï¼Œ**ç ´**~

![](https://gitee.com/cbuc/picture/raw/master/typora/20210321213920.png)

**åœºæ™¯2ï¼š** åˆ†å¸ƒå¼æ¶æ„ä¸‹ï¼Œä¸¤ä¸ªæœåŠ¡ä¹‹é—´ç›¸äº’è°ƒç”¨ï¼Œè™½ç„¶ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªæ•°æ®åº“ï¼Œä½†æ˜¯è¿˜æ˜¯ä¼šå‡ºç°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚è°è®©ä½ ä½¿ç”¨çš„æ˜¯åˆ†å¸ƒå¼æ¶æ„å‘¢~

![](https://gitee.com/cbuc/picture/raw/master/typora/20210321214255.png)

**åœºæ™¯3ï¼š** åˆ†å¸ƒå¼æ¶æ„ä¸‹ï¼Œä¸¤ä¸ªæœåŠ¡ä¹‹é—´ç›¸äº’è°ƒç”¨ï¼Œä½¿ç”¨çš„æ˜¯ä¸ç”¨çš„æ•°æ®åº“ï¼Œè¿™ç§æƒ…å†µä¸‹è‚¯å®šä¼šå‡ºç°åˆ†å¸ƒå¼äº‹åŠ¡çš„é—®é¢˜ï¼Œæƒ³éƒ½ä¸ç”¨æƒ³ï¼

![](https://gitee.com/cbuc/picture/raw/master/typora/20210321214601.png)

#### è§£å†³æ–¹æ³•

æœ‰é—®é¢˜çš„åœ°æ–¹ä¾¿ä¼šæœ‰æ–¹æ³•ï¼Œå½“ç„¶ä¹Ÿä¸ä¸€å®šï¼Œä½†æ˜¯åœ¨è¿™é‡Œï¼Œåˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ç¡®å®æœ‰è§£å†³çš„æ–¹æ³•ï¼Œ å¦‚æœæ²¡æœ‰ï¼Œå°èœä¹Ÿä¸ä¼šå†™è¿™ç¯‡æ–‡ç« æ¥è‡ªè®¨è‹¦åƒäº†ï¼

##### æ–¹æ³•ä¸€ï¼šå…¨å±€äº‹åŠ¡

ä¸çŸ¥é“è¿™é‡Œè¯¥è¯´ **å…¨å±€äº‹åŠ¡** ä¼šè®©ä½ æ¯”è¾ƒç†Ÿæ‚‰ï¼Œè¿˜æ˜¯ **ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰** ä¼šè®©ä½ æ¯”è¾ƒç†Ÿæ‚‰ï¼Œè¿˜æ˜¯è¯´éƒ½ä¸ç†Ÿæ‚‰~ï¼Œä¸ç†Ÿæ‚‰ä¹Ÿæ²¡å…³ç³»ï¼Œå°èœå¸¦ä½ ç†Ÿæ‚‰ç†Ÿæ‚‰ï¼

å…¨å±€äº‹åŠ¡æ˜¯åŸºäºDTPæ¨¡å‹å®ç°çš„ï¼Œå®ƒè§„å®šäº†è¦å®ç°åˆ†å¸ƒå¼äº‹åŠ¡éœ€è¦ä¸‰ç§è§’è‰²ï¼š

- **APï¼ˆApplicationï¼‰**ï¼šåº”ç”¨ç³»ç»Ÿï¼ˆå¾®æœåŠ¡ï¼‰
- **TMï¼ˆTransaction Managerï¼‰**ï¼šäº‹åŠ¡ç®¡ç†å™¨ï¼ˆå…¨å±€äº‹åŠ¡ç®¡ç†ï¼‰
- **RMï¼ˆResource Managerï¼‰**ï¼šèµ„æºç®¡ç†å™¨ï¼ˆæ•°æ®åº“ï¼‰

é™¤äº† **AP** è¿™ä¸ªè§’è‰²ï¼Œæˆ‘ä»¬å¤šè®¤è¯†äº†å…¶ä»–ä¸¤ä¸ªåŒå­¦åˆ†åˆ«æ˜¯`äº‹åŠ¡ç®¡ç†å™¨`å’Œ`èµ„æºç®¡ç†å™¨`ï¼Œé‚£ä¹ˆä»–ä»¬èµ·åˆ°ä»€ä¹ˆä½œç”¨å‘¢ï¼Œé‚£æˆ‘ä»¬å°±å¾—çœ‹ï¼Œè¿™ä¸ªä¸¤é˜¶æ®µæäº¤æ˜¯å“ªä¸¤é˜¶æ®µäº†ï¼

###### é˜¶æ®µ1 ï¼šè¡¨å†³é˜¶æ®µ

æ‰€æœ‰å‚ä¸è€…éƒ½å°†è‡ªå·±çš„äº‹åŠ¡è¿›è¡Œé¢„æäº¤ï¼Œå¹¶å°†èƒ½å¦æˆåŠŸçš„ä¿¡æ¯åé¦ˆç»™åè°ƒè€…

![](https://gitee.com/cbuc/picture/raw/master/20210322123418.png)

![](https://gitee.com/cbuc/picture/raw/master/20210322123621.png)

1. äº‹åŠ¡ç®¡ç†å™¨å‘ä¸€ä¸ª `prepare` æŒ‡ä»¤ç»™ A å’Œ B ä¸¤ä¸ªæœåŠ¡å™¨
2. A å’Œ B ä¸¤ä¸ªæœåŠ¡å™¨æ”¶åˆ°æ¶ˆæ¯åï¼Œæ ¹æ®è‡ªèº«æƒ…å†µï¼Œåˆ¤æ–­è‡ªå·±æ˜¯å¦å¯ä»¥æäº¤äº‹åŠ¡
3. å°†å¤„ç†ç»“æœè®°å½•åˆ°èµ„æºç®¡ç†å™¨ä¸­
4. å°†å¤„ç†ç»“æœè¿”å›ç»™äº‹åŠ¡ç®¡ç†å™¨

###### é˜¶æ®µ2 ï¼šæ‰§è¡Œé˜¶æ®µ

åè°ƒè€…æ ¹æ®æ‰€æœ‰å‚ä¸è€…çš„åé¦ˆï¼Œé€šçŸ¥æ‰€æœ‰å‚ä¸è€…ï¼Œæ­¥è°ƒä¸€è‡´åœ°æ‰§è¡Œæäº¤æˆ–è€…å›æ»š

![](https://gitee.com/cbuc/picture/raw/master/20210322124150.png)

![](https://gitee.com/cbuc/picture/raw/master/20210322124212.png)

1. äº‹åŠ¡ç®¡ç†å™¨å‘ A å’Œ B ä¸¤ä¸ªæœåŠ¡å™¨å‘é€æäº¤æŒ‡ä»¤
2. A å’Œ B ä¸¤ä¸ªæœåŠ¡å™¨æ”¶åˆ°æŒ‡ä»¤åï¼Œå°†è‡ªå·±æœ¬èº«äº‹åŠ¡æäº¤
3. å°†å¤„ç†ç»“æœè®°å½•åˆ°èµ„æºç®¡ç†å™¨
4. å°†å¤„ç†ç»“æœè¿”å›ç»™äº‹åŠ¡ç®¡ç†å™¨

è¿™å°±æ˜¯ä¸¤é˜¶æ®µæäº¤çš„å¤§è‡´è¿‡ç¨‹ï¼Œå®ƒæé«˜äº†æ•°æ®ä¸€è‡´æ€§çš„æ¦‚ç‡ï¼Œå®ç°æˆæœ¬è¾ƒä½ã€‚ä½†æ˜¯è¿™ç§å®ç°æ–¹å¼å¸¦æ¥çš„ç¼ºç‚¹ä¹Ÿæ˜¯å¾ˆæ˜æ˜¾çš„ï¼

- **å•ç‚¹æ•…éšœ**ï¼šå¦‚æœäº‹åŠ¡ç®¡ç†å™¨å‡ºç°äº†æ•…éšœï¼Œæ•´ä¸ªç³»ç»Ÿå°†ä¸å¯ç”¨
- **åŒæ­¥é˜»å¡**ï¼šå»¶è¿Ÿäº†æäº¤äº‹ä»¶ï¼ŒåŠ é•¿äº†èµ„æºé˜»å¡äº‹ä»¶ï¼Œä¸é€‚åˆé«˜å¹¶å‘çš„åœºæ™¯
- **æ•°æ®ä¸ä¸€è‡´**ï¼šå¦‚æœæ‰§è¡Œåˆ°ç¬¬äºŒé˜¶æ®µï¼Œä¾ç„¶å­˜åœ¨**commit**ç»“æœæœªçŸ¥çš„æƒ…å†µï¼Œåªæœ‰éƒ¨åˆ†å‚ä¸è€…æ¥æ”¶åˆ° **commit** æ¶ˆæ¯ï¼Œéƒ¨åˆ†æ²¡æœ‰æ”¶åˆ°ï¼Œé‚£ä¹Ÿåªæœ‰éƒ¨åˆ†å‚ä¸è€…æäº¤äº†äº‹åŠ¡ï¼Œä¾ç„¶ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´é—®é¢˜

##### æ–¹æ³•äºŒï¼šä¸‰é˜¶æ®µæäº¤

æ—¢ç„¶ä¸¤é˜¶æ®µæäº¤è§£å†³ä¸äº†é—®é¢˜ï¼Œé‚£æˆ‘ä»¬å°±æ¥ä¸‰é˜¶æ®µæäº¤ã€‚ä¸‰é˜¶æ®µæäº¤ç›¸å¯¹äºä¸¤é˜¶æ®µæäº¤æ¥è¯´å¢åŠ äº† `ConCommit` é˜¶æ®µå’Œè¶…æ—¶æœºåˆ¶ã€‚åœ¨ä¸€æ®µè§„å®šæ—¶é—´å†…ï¼Œå¦‚æœæœåŠ¡å™¨å‚ä¸è€…æ²¡æœ‰æ¥å—åˆ°æ¥è‡ªäº‹åŠ¡ç®¡ç†å™¨çš„æäº¤æ‰§è¡Œï¼Œé‚£ä»–ä»¬å°±ä¼šè‡ªå·±è‡ªåŠ¨æäº¤ï¼Œè¿™æ ·å­å°±èƒ½è§£å†³ä¸¤é˜¶æ®µä¸­å•ä½“æ•…éšœé—®é¢˜ã€‚

æˆ‘ä»¬æ¥çœ‹çœ‹ä¸‰é˜¶æ®µæäº¤æ˜¯å“ªä¸‰é˜¶æ®µï¼š

- **CanCommit**ï¼šå‡†å¤‡é˜¶æ®µã€‚è¿™ä¸ªé˜¶æ®µè¦åšçš„äº‹å°±å’Œä¸¤é˜¶æ®µæäº¤ä¸€æ ·ï¼Œå…ˆå»è¯¢é—®å‚ä¸è€…æ˜¯å¦æœ‰æ¡ä»¶æ¥æ”¶è¿™ä¸ªäº‹åŠ¡ï¼Œè¿™æ ·å­ä¸ä¼šå¤ªæš´åŠ›ï¼Œä¸€å¼€å§‹å°±ç›´æ¥å¹²æ´»é”æ­»èµ„æºã€‚

- **PreCommit**ï¼šè¿™ä¸ªé˜¶æ®µæ˜¯äº‹åŠ¡ç®¡ç†å™¨å‘å„ä¸ªå‚åŠ è€…å‘é€å‡†å¤‡æäº¤è¯·æ±‚ï¼Œå„ä¸ªå‚ä¸è€…æ¥åˆ°è¯·æ±‚æˆ–ï¼Œå°†å¤„ç†ç»“æœè®°å½•åˆ°è‡ªå·±çš„èµ„æºç®¡ç†å™¨ä¸­ï¼Œå¦‚æœå‡†å¤‡å¥½äº†ï¼Œå°±ä¼šæƒ³åè°ƒè€…åé¦ˆ`ACK`è¡¨ç¤ºæˆ‘å·²ç»å‡†å¤‡å¥½æäº¤äº†ã€‚
- **DoCommit**ï¼šè¿™ä¸ªå°±æ–­å°±æ˜¯ä» **é¢„æäº¤çŠ¶æ€** è½¬ä¸º **æäº¤**çŠ¶æ€ã€‚äº‹åŠ¡ç®¡ç†å™¨å‘å„ä¸ªå‚ä¸è€…å‘é€ **æäº¤** è¯·æ±‚ï¼Œå‚ä¸è€…æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå°±ä¼šå„è‡ªæ‰§è¡Œè‡ªå·±äº‹åŠ¡çš„æäº¤æ“ä½œã€‚å°†å¤„ç†ç»“æœè®°å½•åˆ°è‡ªå·±çš„èµ„æºç®¡ç†å™¨ä¸­ï¼Œå¹¶å‘åè°ƒè€…åé¦ˆ `ACK` è¡¨ç¤ºè‡ªå·±å·²ç»å®Œæˆäº‹åŠ¡ï¼Œå¦‚æœæœ‰ä¸€ä¸ªå‚ä¸è€…æœªå®Œæˆ**PreCommit**çš„åé¦ˆæˆ–è€…åé¦ˆè¶…æ—¶ï¼Œé‚£ä¹ˆåè°ƒè€…éƒ½ä¼šå‘æ‰€æœ‰çš„å‚ä¸è€…èŠ‚ç‚¹å‘é€abortè¯·æ±‚ï¼Œä»è€Œä¸­æ–­äº‹åŠ¡ã€‚

å…¶å®ä¸‰é˜¶æ®µæäº¤çœ‹èµ·æ¥å°±æ˜¯æŠŠä¸¤é˜¶æ®µæäº¤ä¸­çš„`æäº¤é˜¶æ®µ`å˜æˆäº† **é¢„æäº¤é˜¶æ®µ** å’Œ **æäº¤é˜¶æ®µ**ã€‚

![](https://gitee.com/cbuc/picture/raw/master/20210323135603.png)

é‚£å…¶å®ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œä¸‰é˜¶æ®µæäº¤è§£å†³çš„åªæ˜¯ä¸¤é˜¶æ®µæäº¤ä¸­ **å•ä½“æ•…éšœ** çš„é—®é¢˜ï¼Œå› ä¸ºåŠ å…¥äº†è¶…æ—¶æœºåˆ¶ï¼Œè¿™é‡Œçš„è¶…æ—¶çš„æœºåˆ¶ä½œç”¨äº **é¢„æäº¤é˜¶æ®µ** å’Œ **æäº¤é˜¶æ®µ**ã€‚å¦‚æœç­‰å¾… **é¢„æäº¤è¯·æ±‚** è¶…æ—¶ï¼Œé‚£å‚ä¸è€…ç›¸å½“äºè¯´å•¥éƒ½æ²¡å¹²ï¼Œç›´æ¥å›åˆ°å‡†å¤‡é˜¶æ®µä¹‹å‰ã€‚å¦‚æœç­‰åˆ°**æäº¤è¯·æ±‚**è¶…æ—¶ï¼Œé‚£å‚ä¸è€…å°±ä¼šæäº¤äº‹åŠ¡äº†ã€‚

æ‰€ä»¥å¯ä»¥çœ‹åˆ°å…¶å® ä¸‰é˜¶æ®µæäº¤è¿˜æ˜¯æ²¡æ ¹æœ¬è§£å†³é—®é¢˜ï¼Œè™½ç„¶æ¯”ä¸¤é˜¶æ®µæäº¤è¿›æ­¥äº†ä¸€ç‚¹ç‚¹~

##### æ–¹æ³•ä¸‰ï¼šTCC

**TCCï¼ˆTry Confirm Cancelï¼‰** ï¼Œå®ƒæ˜¯å±äºè¡¥å¿å‹åˆ†å¸ƒå¼äº‹åŠ¡ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ **é’ˆå¯¹æ¯ä¸ªæ“ä½œï¼Œéƒ½è¦æ³¨å†Œä¸€ä¸ªä¸å…¶å¯¹åº”çš„ç¡®è®¤å’Œè¡¥å¿ï¼ˆæ’¤é”€ï¼‰æ“ä½œ**ã€‚TCC å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ä¸€å…±æœ‰ä¸‰ä¸ªæ­¥éª¤ï¼š

- **Try**ï¼šå°è¯•å¾…æ‰§è¡Œçš„ä¸šåŠ¡

è¿™ä¸ªè¿‡ç¨‹å¹¶æœªæ‰§è¡Œä¸šåŠ¡ï¼Œåªæ˜¯å®Œæˆæ‰€æœ‰ä¸šåŠ¡çš„ä¸€è‡´æ€§æ£€æŸ¥ï¼Œå¹¶**é¢„ç•™**å¥½æ‰§è¡Œæ‰€éœ€çš„æ‰€æœ‰èµ„æº

- **Confirm**ï¼šç¡®è®¤æ‰§è¡Œä¸šåŠ¡

ç¡®è®¤æ‰§è¡Œä¸šåŠ¡çš„æ“ä½œï¼Œä¸åšä»»ä½•ä¸šåŠ¡æ£€æŸ¥ï¼Œåªä½¿ç”¨Tryé˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æºã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œé‡‡ç”¨TCCåˆ™ä¼šè®¤ä¸º Confirm é˜¶æ®µæ˜¯ä¸ä¼šå‡ºé”™çš„ã€‚åªè¦ Try æˆåŠŸï¼Œåˆ™ Confirm ä¸€å®šæˆåŠŸã€‚å¦‚æœ Confirm å‡ºé”™äº†ï¼Œåˆ™éœ€è¦å¼•å…¥é‡è¯•æœºåˆ¶æˆ–äººå·¥å¤„ç†

- **Cancel**ï¼šå–æ¶ˆå¾…æ‰§è¡Œçš„ä¸šåŠ¡

å–æ¶ˆ Try é˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æºã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œé‡‡ç”¨ TCC åˆ™è®¤ä¸º Cancel é˜¶æ®µä¹Ÿæ˜¯ä¸€å®šèƒ½æˆåŠŸçš„ï¼Œè‹¥ Cancel é˜¶æ®µçœŸçš„å‡ºé”™äº†ï¼Œä¹Ÿè¦å¼•å…¥é‡è¯•æœºåˆ¶æˆ–äººå·¥å¤„ç†

![](https://gitee.com/cbuc/picture/raw/master/20210324131258.png)

**TCC** æ˜¯ä¸šåŠ¡å±‚é¢çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œæœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸ä¼šä¸€ç›´æŒæœ‰èµ„æºçš„é”ã€‚å®ƒçš„ä¼˜ç¼ºç‚¹å¦‚ä¸‹ï¼š

**ä¼˜ç‚¹ï¼š** å§æ•°æ®åº“å±‚çš„äºŒé˜¶æ®µæäº¤ä¸Šæåˆ°äº†åº”ç”¨å±‚æ¥å®ç°ï¼Œè§„é¿äº†æ•°æ®åº“çš„ 2PC æ€§èƒ½ä½ä¸‹é—®é¢˜

**ç¼ºç‚¹**ï¼šTCC çš„ Tryã€Confirm å’Œ Cancel æ“ä½œåŠŸèƒ½éœ€ä¸šåŠ¡æä¾›ï¼Œå¼€å‘æˆæœ¬é«˜ã€‚TCC å¯¹ä¸šåŠ¡çš„ä¾µå…¥è¾ƒå¤§å’Œä¸šåŠ¡ç´§è€¦åˆï¼Œéœ€è¦æ ¹æ®ç‰¹å®šçš„åœºæ™¯å’Œä¸šåŠ¡é€»è¾‘æ¥è®¾è®¡ç›¸åº”çš„æ“ä½œ

##### æ–¹æ³•äº”ï¼šå¯é æ¶ˆæ¯äº‹åŠ¡

æ¶ˆæ¯äº‹åŠ¡çš„åŸç†æ˜¯ **å°†ä¸¤ä¸ªäº‹åŠ¡é€šè¿‡æ¶ˆæ¯ä¸­é—´ä»¶æ¥è¿›è¡Œå¼‚æ­¥è§£è€¦**ã€‚åŸºäºå¯é æ¶ˆæ¯æœåŠ¡çš„æ–¹æ¡ˆæ˜¯é€šè¿‡æ¶ˆæ¯ä¸­é—´ä»¶æ¥ä¿è¯ä¸Šã€ä¸‹æ¸¸åº”ç”¨æ•°æ®æ“ä½œçš„ä¸€è‡´æ€§ã€‚å‡è®¾æœ‰ Aã€Bä¸¤ä¸ªæœåŠ¡ï¼Œåˆ†å¸ƒå¯ä»¥å¤„ç† Aã€Bä¸¤ä¸ªä»»åŠ¡ï¼Œæ­¤æ—¶éœ€è¦å­˜åœ¨ä¸€ä¸ªä¸šåŠ¡æµç¨‹ï¼Œå°†ä»»åŠ¡ Aå’ŒB æ”¾åˆ°åŒä¸€ä¸ªäº‹ç‰©ä¸­å¤„ç†ï¼Œè¿™ç§æ–¹å¼å°±å¯ä»¥å€ŸåŠ©æ¶ˆæ¯ä¸­é—´ä»¶æ¥å®ç°ã€‚

![](https://gitee.com/cbuc/picture/raw/master/20210324141608.png)

æ•´ä½“ä¸Šå¯ä»¥åˆ†ä¸ºä¸¤ä¸ªå¤§çš„æ­¥éª¤ï¼š`AæœåŠ¡å‘æ¶ˆæ¯ä¸­é—´ä»¶å‘å¸ƒæ¶ˆæ¯` å’Œ `æ¶ˆæ¯å‘BæœåŠ¡æŠ•é€’æ¶ˆæ¯`

**æ­¥éª¤ä¸€ï¼š** A æœåŠ¡å‘æ¶ˆæ¯ä¸­é—´ä»¶å‘å¸ƒæ¶ˆæ¯

1. åœ¨æœåŠ¡Aå¤„ç†ä»»åŠ¡Aå‰ï¼Œé¦–å…ˆå‘æ¶ˆæ¯ä¸­é—´ä»¶å‘é€ä¸€æ¡åŠä¿¡æ¯
2. æ¶ˆæ¯ä¸­é—´ä»¶æ”¶åˆ°åå°†è¯¥æ¶ˆæ¯æŒä¹…åŒ–ï¼Œä½†ä¸è¿›è¡ŒæŠ•é€’ã€‚æŒä¹…åŒ–æˆåŠŸåï¼Œå‘AæœåŠ¡è¿”å›ç¡®è®¤åº”ç­”
3. æœåŠ¡Aæ”¶åˆ°ç¡®è®¤åº”ç­”åï¼Œä¾¿å¯ä»¥å¼€å§‹å¤„ç†ä»»åŠ¡A
4. ä»»åŠ¡Aå¤„ç†å®Œæˆåï¼ŒæœåŠ¡Aä¾¿ä¼šå‘æ¶ˆæ¯ä¸­é—´ä»¶å‘é€Commit æˆ–è€… Rollback è¯·æ±‚ï¼Œè¯¥è¯·æ±‚å‘é€å®Œæˆåï¼ŒæœåŠ¡Açš„å·¥ä½œä»»åŠ¡å°±ç»“æŸäº†ï¼Œè¯¥äº‹åŠ¡çš„å¤„ç†è¿‡ç¨‹ä¹Ÿå°±ç»“æŸäº†
5. åœ¨æ¶ˆæ¯ä¸­é—´ä»¶æ”¶åˆ° **Commit** åï¼Œä¾¿ä¼šå‘ B æœåŠ¡æŠ•é€’æ¶ˆæ¯ï¼Œå¦‚æœæ”¶åˆ° **Rollback** ä¾¿ä¼šç›´æ¥ä¸¢å¼ƒæ¶ˆæ¯

å¦‚æœæ¶ˆæ¯ä¸­é—´ä»¶åœ¨æœ€åçš„è¿‡ç¨‹ä¸­ï¼Œé•¿æ—¶é—´æ²¡æœ‰æ”¶åˆ°æœåŠ¡A å‘é€çš„ **Commit** æˆ– **Rollback** æŒ‡ä»¤ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ä¾é  **è¶…æ—¶è¯¢é—®æœºåˆ¶**

> **è¶…æ—¶è¯¢é—®æœºåˆ¶**ï¼š
>
> æœåŠ¡Aé™¤äº†å®ç°æ­£å¸¸çš„ä¸šåŠ¡æµç¨‹ä¹‹å¤–ï¼Œè¿˜æ˜¯éœ€è¦æä¾›ä¸€ä¸ªå¯ä¾›æ¶ˆæ¯ä¸­é—´ä»¶äº‹åŠ¡è¯¢é—®çš„æ¥å£ã€‚åœ¨æ¶ˆæ¯ä¸­é—´ä»¶ç¬¬ä¸€æ¬¡æ”¶åˆ°æ¶ˆæ¯åä¾¿ä¼šå¼€å§‹è®¡æ—¶ï¼Œå¦‚æœè¶…è¿‡è§„å®šçš„æ—¶é—´æ²¡æœ‰æ”¶åˆ°åç»­çš„æŒ‡ä»¤ï¼Œå°±ä¼šä¸»åŠ¨è°ƒç”¨æœåŠ¡Aæä¾›çš„äº‹åŠ¡è¯¢é—®æ¥å£ï¼Œè¯¢é—®å½“å‰æœåŠ¡çš„çŠ¶æ€ï¼Œé€šå¸¸æ¥è¯´è¯¥æ¥å£ä¼šè¿”å›ä¸‰ç§ç»“æœï¼Œä¸­é—´ä»¶éœ€è¦æ ¹æ®è¿™ä¸‰ç§ä¸åŒçš„ç»“æœåšå‡ºä¸åŒçš„å¤„ç†ï¼š
>
> - æäº¤ï¼šç›´æ¥å°†è¯¥æ¶ˆæ¯æŠ•é€’ç»™æœåŠ¡B
> - å›æ»šï¼šç›´æ¥å°†è¯¥æ¶ˆæ¯ä¸¢å¼ƒ
> - å¤„ç†ä¸­ï¼šç»§ç»­ç­‰å¾…ï¼Œé‡æ–°è®¡æ—¶

**æ­¥éª¤äºŒï¼š** æ¶ˆæ¯ä¸­é—´ä»¶å‘BæœåŠ¡æŠ•é€’æ¶ˆæ¯

æ¶ˆæ¯ä¸­é—´ä»¶æ”¶åˆ°AæœåŠ¡çš„æäº¤ **Commit**æŒ‡ä»¤åä¾¿ä¼šå°†è¯¥æ¶ˆæ¯æŠ•é€’ç»™BæœåŠ¡ï¼Œç„¶åå°†è‡ªå·±çš„çŠ¶æ€ç½®ä¸ºé˜»å¡ç­‰å¾…çŠ¶æ€ã€‚BæœåŠ¡æ”¶åˆ°æ¶ˆæ¯ä¸­é—´ä»¶å‘é€çš„æ¶ˆæ¯åä¾¿å¼€å§‹å¤„ç†ä»»åŠ¡Bï¼Œå¤„ç†å®Œæˆåä¾¿ä¼šå‘æ¶ˆæ¯ä¸­é—´ä»¶å‘å‡ºå›åº”ã€‚ä½†æ˜¯åœ¨æ¶ˆæ¯ä¸­é—´ä»¶é˜»å¡ç­‰å¾…çš„æ—¶å€™åŒæ ·ä¼šå‡ºç°é—®é¢˜

- æ­£å¸¸æƒ…å†µï¼šæ¶ˆæ¯ä¸­é—´ä»¶æŠ•é€’å®Œæ¶ˆæ¯åï¼Œè¿›å…¥é˜»å¡ç­‰å¾…çŠ¶æ€ï¼Œåœ¨æ”¶åˆ°ç¡®è®¤åº”ç­”åä¾¿è®¤ä¸ºäº‹åŠ¡å¤„ç†å®Œæˆï¼Œè¯¥æµç¨‹ç»“æŸ
- ç­‰å¾…è¶…æ—¶æƒ…å†µï¼šåœ¨ç­‰å¾…ç¡®è®¤åº”ç­”è¶…æ—¶ä¹‹åå°±ä¼šé‡æ–°è¿›è¡ŒæŠ•é€’ï¼Œç›´åˆ°BæœåŠ¡å™¨è¿”å›æ¶ˆè´¹æˆåŠŸå“åº”ä¸ºæ­¢ã€‚è€Œæ¶ˆæ¯é‡è¯•çš„æ¬¡æ•°å’Œæ—¶é—´é—´éš”éƒ½å¯ä»¥è®¾ç½®ï¼Œå¦‚æœæœ€ç»ˆè¿˜æ˜¯ä¸èƒ½æˆåŠŸè¿›è¡ŒæŠ•é€’ï¼Œåˆ™éœ€è¦äººå·¥å¹²é¢„ã€‚

å¯é æ¶ˆæ¯æœåŠ¡æ–¹æ¡ˆæ˜¯å®ç°äº† **æœ€ç»ˆä¸€è‡´æ€§**ã€‚å¯¹æ¯”æœ¬åœ°æ¶ˆæ¯è¡¨å®ç°æ–¹æ¡ˆï¼Œä¸éœ€è¦å†å»ºç«‹æ¶ˆæ¯è¡¨ã€‚**ä¸ç”¨ä¾èµ–æœ¬åœ°æ•°æ®åº“äº‹åŠ¡**ï¼Œé€‚ç”¨äºé«˜å¹¶å‘çš„åœºæ™¯ã€‚**RocketMQ** å°±å¾ˆå¥½çš„æ”¯æŒäº†æ¶ˆæ¯äº‹åŠ¡ã€‚

##### æ–¹æ³•å››ï¼šæœ€å¤§åŠªåŠ›é€šçŸ¥

æœ€å¤§åŠªåŠ›é€šçŸ¥ä¹Ÿæˆä¸ºå®šæœŸæ ¡å¯¹ï¼Œæ˜¯å¯¹å¯é æ¶ˆæ¯æœåŠ¡çš„è¿›ä¸€æ­¥ä¼˜åŒ–ã€‚å®ƒå¼•å…¥äº†æœ¬åœ°æ¶ˆæ¯è¡¨æ¥è®°å½•é”™è¯¯æ¶ˆæ¯ï¼Œç„¶ååŠ å…¥å¤±è´¥æ¶ˆæ¯çš„å®šæœŸæ ¡å¯¹åŠŸèƒ½ï¼Œæ¥è¿›ä¸€æ­¥ä¿è¯æ¶ˆæ¯ä¼šè¢«ä¸‹æ¸¸æœåŠ¡æ¶ˆè´¹ã€‚

![](https://gitee.com/cbuc/picture/raw/master/20210325132356.png)

åŒæ ·çš„è¿™ä¸ªè·Ÿæ¶ˆæ¯äº‹åŠ¡ä¸€æ ·å¯ä»¥åˆ†ä¸ºä¸¤æ­¥ï¼š

**æ­¥éª¤ä¸€ï¼š** æœåŠ¡Aå‘æ¶ˆæ¯ä¸­é—´ä»¶å‘é€æ¶ˆæ¯

1. åœ¨å¤„ç†ä¸šåŠ¡çš„åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå‘æœ¬åœ°æ¶ˆæ¯è¡¨å†™å…¥ä¸€æ¡è®°å½•
2. æ¶ˆæ¯å‘é€è€…ä¸æ–­å–å‡ºæœ¬åœ°æ¶ˆæ¯è¡¨ä¸­çš„æ¶ˆæ¯å‘é€åˆ°æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå¦‚æœå‘é€å¤±è´¥åˆ™è¿›è¡Œé‡è¯•

**æ­¥éª¤äºŒï¼š** æ¶ˆæ¯ä¸­é—´ä»¶å‘æœåŠ¡BæŠ•é€’æ¶ˆæ¯

1. æ¶ˆæ¯ä¸­é—´ä»¶æ”¶åˆ°æ¶ˆæ¯åä¾¿ä¼šå°†æ¶ˆæ¯æŠ•é€’åˆ°ä¸‹æ¸¸æœåŠ¡Bï¼ŒæœåŠ¡Bæ”¶åˆ°æ¶ˆæ¯åä¾¿ä¼šæ‰§è¡Œè‡ªå·±çš„ä¸šåŠ¡
2. å½“æœåŠ¡Bä¸šåŠ¡å¤„ç†æˆåŠŸåï¼Œä¾¿ä¼šå‘æ¶ˆæ¯ä¸­é—´ä»¶è¿”å›åé¦ˆåº”ç­”ï¼Œæ¶ˆæ¯ä¸­é—´ä»¶ä¾¿å¯å°†è¯¥æ¶ˆæ¯åˆ é™¤ï¼Œè¯¥æµç¨‹ç»“æŸ
3. å¦‚æœæ¶ˆæ¯ä¸­é—´ä»¶å‘æœåŠ¡BæŠ•é€’æ¶ˆæ¯å¤±è´¥ï¼Œä¾¿ä¼šå°è¯•é‡è¯•ï¼Œå¦‚æœé‡è¯•å¤±è´¥ï¼Œä¾¿ä¼šå°†è¯¥æ¶ˆæ¯æ¥å…¥å¤±è´¥æ¶ˆæ¯è¡¨ä¸­
4. æ¶ˆæ¯ä¸­é—´ä»¶åŒæ ·éœ€è¦æä¾›æŸ¥è¯¢å¤±è´¥æ¶ˆæ¯çš„æ¥å£ï¼ŒæœåŠ¡B å®šæœŸæŸ¥è¯¢å¤±è´¥ä¿¡æ¯ï¼Œå¹¶è¿›è¡Œæ¶ˆè´¹

æœ€å¤§åŠªåŠ›é€šçŸ¥çš„æ–¹æ¡ˆå®ç°æ¯”è¾ƒç®€å•ï¼Œé€‚ç”¨äºä¸€äº›æœ€ç»ˆä¸€è‡´æ€§è¦æ±‚æ¯”è¾ƒä½çš„ä¸šåŠ¡ã€‚

### Seata

#### Seataæ¦‚å¿µ

æ—¢ç„¶åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†èµ·æ¥è¿™ä¹ˆéº»çƒ¦ï¼Œé‚£èƒ½ä¸èƒ½è®©åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†èµ·æ¥åƒæœ¬åœ°äº‹åŠ¡é‚£ä¹ˆç®€å•ã€‚å½“ç„¶è¿™æ˜¯æˆ‘ä»¬çš„æ„¿æ™¯ã€‚å½“ç„¶è¿™ä¸ªæ„¿æ™¯æ˜¯æ‰€æœ‰å¼€å‘äººå‘˜æ‰€å¸Œæœ›çš„ã€‚è€Œé˜¿é‡Œå·´å·´å›¢é˜Ÿå°±ä¸ºè¿™ä¸ªæ„¿æ™¯åšå‡ºäº†è¡ŒåŠ¨ï¼Œå‘èµ·äº†å¼€æºé¡¹ç›® **Seataï¼ˆSimple Extensible Autonomous Transaction Architectureï¼‰** ã€‚è¿™æ˜¯ä¸€å¥—åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œæ„åœ¨è§£å†³å¼€å‘äººå‘˜é‡åˆ°çš„åˆ†å¸ƒå¼äº‹åŠ¡å„æ–¹é¢çš„éš¾é¢˜ã€‚

**Seata** çš„è®¾è®¡ç›®æ ‡æ˜¯å¯¹ä¸šåŠ¡æ— ä¾µå…¥ï¼Œå› æ­¤å®ƒæ˜¯ä»ä¸šåŠ¡æ— ä¾µå…¥çš„ä¸¤é˜¶æ®µæäº¤ï¼ˆå…¨å±€äº‹åŠ¡ï¼‰ç€æ‰‹ï¼Œåœ¨ä¼ ç»Ÿçš„ä¸¤é˜¶æ®µä¸Šè¿›è¡Œæ”¹è¿›ï¼Œä»–æŠŠä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ç†è§£æˆä¸€ä¸ªåŒ…å«äº†è‹¥å¹²åˆ†æ”¯äº‹åŠ¡çš„å…¨å±€äº‹åŠ¡ã€‚è€Œå…¨å±€äº‹åŠ¡çš„èŒè´£æ˜¯åè°ƒå®ƒç®¡ç†çš„åˆ†æ”¯äº‹åŠ¡è¾¾æˆä¸€è‡´æ€§ï¼Œè¦ä¹ˆä¸€èµ·æˆåŠŸæäº¤ï¼Œè¦ä¹ˆä¸€èµ·å¤±è´¥å›æ»šã€‚ä¹Ÿå°±æ˜¯ä¸€è£ä¿±è£ä¸€æŸä¿±æŸ~

![](https://gitee.com/cbuc/picture/raw/master/typora/20210325210426.png)

#### Seata ç»„æˆ

æˆ‘ä»¬çœ‹ä¸‹ **Seata** ä¸­å­˜åœ¨å‡ ç§é‡è¦è§’è‰²ï¼š

- **TCï¼ˆTransaction Coordinatorï¼‰**ï¼šäº‹åŠ¡åè°ƒè€…ã€‚ç®¡ç†å…¨å±€çš„åˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œç”¨äºå…¨å±€æ€§äº‹åŠ¡çš„æäº¤å’Œå›æ»šã€‚
- **TMï¼ˆTransaction Managerï¼‰**ï¼šäº‹åŠ¡ç®¡ç†è€…ã€‚ç”¨äºå¼€å¯ã€æäº¤æˆ–å›æ»šäº‹åŠ¡ã€‚
- **RMï¼ˆResource Managerï¼‰**ï¼šèµ„æºç®¡ç†å™¨ã€‚ç”¨äºåˆ†æ”¯äº‹åŠ¡ä¸Šçš„èµ„æºç®¡ç†ï¼Œå‘ **TC** æ³¨å†Œåˆ†æ”¯äº‹åŠ¡ï¼Œä¸ŠæŠ¥åˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œæ¥æ”¶ **TC** çš„å‘½ä»¤æ¥æäº¤æˆ–è€…å›æ»šåˆ†æ”¯äº‹åŠ¡ã€‚

è¿™æ˜¯ä¸€ç§å¾ˆå·§å¦™çš„è®¾è®¡ï¼Œæˆ‘ä»¬æ¥çœ‹å›¾ï¼š

![](https://gitee.com/cbuc/picture/raw/master/typora/20210325212926.png)

æ‰§è¡Œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š

1.  æœåŠ¡Aä¸­çš„ **TM** å‘ **TC** ç”³è¯·å¼€å¯ä¸€ä¸ªå…¨å±€äº‹åŠ¡ï¼Œ**TC** å°±ä¼šåˆ›å»ºä¸€ä¸ªå…¨å±€äº‹åŠ¡å¹¶è¿”å›ä¸€ä¸ªå”¯ä¸€çš„ **XID**
2.  æœåŠ¡Aä¸­çš„ **RM** å‘ **TC** æ³¨å†Œåˆ†æ”¯äº‹åŠ¡ï¼Œç„¶åå°†è¿™ä¸ªåˆ†æ”¯äº‹åŠ¡çº³å…¥ **XID** å¯¹åº”çš„å…¨å±€äº‹åŠ¡ç®¡è¾–ä¸­
3.  æœåŠ¡Aå¼€å§‹æ‰§è¡Œåˆ†æ”¯äº‹åŠ¡
4.  æœåŠ¡Aå¼€å§‹è¿œç¨‹è°ƒç”¨BæœåŠ¡ï¼Œæ­¤æ—¶ **XID** ä¼šæ ¹æ®è°ƒç”¨é“¾ä¼ æ’­
5. æœåŠ¡Bä¸­çš„ **RM** ä¹Ÿå‘ **TC** æ³¨å†Œåˆ†æ”¯äº‹åŠ¡ï¼Œç„¶åå°†è¿™ä¸ªåˆ†æ”¯äº‹åŠ¡çº³å…¥ **XID** å¯¹åº”çš„å…¨å±€äº‹åŠ¡ç®¡è¾–ä¸­
6.  æœåŠ¡Bå¼€å§‹æ‰§è¡Œåˆ†æ”¯äº‹åŠ¡
7. å…¨å±€äº‹åŠ¡è°ƒç”¨å¤„ç†ç»“æŸåï¼Œ**TM** ä¼šæ ¹æ®æœ‰è¯¯å¼‚å¸¸æƒ…å†µï¼Œå‘ **TC** å‘èµ·å…¨å±€äº‹åŠ¡çš„æäº¤æˆ–å›æ»š
8.  **TC** åè°ƒå…¶ç®¡è¾–ä¹‹ä¸‹çš„æ‰€æœ‰åˆ†æ”¯äº‹åŠ¡ï¼Œå†³å®šæ˜¯æäº¤è¿˜æ˜¯å›æ»š

#### Seataä½¿ç”¨

æˆ‘ä»¬ä»ä¸Šé¢äº†è§£åˆ°äº† Seata çš„ç»„æˆå’Œæ‰§è¡Œæµç¨‹ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°±æ¥å®é™…çš„ä½¿ç”¨ä¸‹ **Seata**ã€‚

##### ç¤ºä¾‹æ¼”ç¤º

æˆ‘ä»¬ç®€å•åˆ›å»ºäº†ä¸€ä¸ªå¾®æœåŠ¡é¡¹ç›®ï¼Œå…¶ä¸­æœ‰è®¢å•æœåŠ¡å’Œåº“å­˜æœåŠ¡ã€‚

![](https://gitee.com/cbuc/picture/raw/master/20210327201901.png)

æˆ‘ä»¬è¿™é‡Œé‡‡ç”¨äº† **nacos** ä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Œåˆ†åˆ«å¯åŠ¨ä¸¤ä¸ªæœåŠ¡ï¼Œæˆ‘ä»¬åœ¨**nacos**æ§åˆ¶å°å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªå·²ç»æ³¨å†Œçš„æœåŠ¡ï¼š

![](https://gitee.com/cbuc/picture/raw/master/20210327205121.png)

> å·å¤–ï¼šå¦‚æœå¯¹**nacos**è¿˜ä¸ç†Ÿæ‚‰çš„å°ä¼™ä¼´å¯ä»¥è·³è½¬æŸ¥çœ‹ **nacosè®²è§£**ï¼š[å¾®æœåŠ¡æ–°ç§€ä¹‹Nacos](https://mp.weixin.qq.com/s/WzbLt3hS6iCgEzDInpn70g)

æˆ‘ä»¬æ¥ç€åˆ›å»ºäº†ä¸€ä¸ªæ•°æ®åº“ï¼Œå…¶ä¸­æœ‰ä¸¤å¼ è¡¨ï¼š`c_order` å’Œ `c_product`ï¼Œå…¶ä¸­å•†å“è¡¨ä¸­æœ‰ä¸€æ¡æ•°æ®ï¼Œè€Œè®¢å•è¡¨ä¸­è¿˜æœªæœ‰æ•°æ®ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†è¦å¯¹å…¶è¿›è¡Œæ“ä½œï¼

![](https://gitee.com/cbuc/picture/raw/master/20210327205802.png)

æˆ‘ä»¬ç°åœ¨æ¨¡æ‹Ÿä¸€ä¸ªä¸‹å•çš„è¿‡ç¨‹ï¼š

1.  è¯·æ±‚è¿›æ¥ï¼Œé€šè¿‡å•†å“ **pid** å¾€æ•°æ®åº“ä¸­æŸ¥å•†å“çš„ä¿¡æ¯
2.  åˆ›å»ºä¸€æ¡è¯¥å•†å“çš„è®¢å•
3.  å¯¹åº”æ‰£å‡è¯¥å•†å“çš„åº“å­˜é‡
4.  æµç¨‹ç»“æŸ

![](https://gitee.com/cbuc/picture/raw/master/20210327211028.png)

æˆ‘ä»¬æ¥ä¸‹æ¥å°±è¿›å…¥ä»£ç æ¼”ç¤ºä¸€ä¸‹ï¼š

![](https://gitee.com/cbuc/picture/raw/master/20210327221106.png)

> æ³¨æ„ï¼šè¿™é‡Œ ProductService å¹¶éæ˜¯åº“å­˜æœåŠ¡é‡Œé¢çš„ç±»ï¼Œè€Œæ˜¯åˆ©ç”¨ Feign è¿œç¨‹è°ƒç”¨åº“å­˜æœåŠ¡çš„æ¥å£
>
> ![](https://gitee.com/cbuc/picture/raw/master/20210327221453.png)

ä»£ç ä¸‰æ­¥èµ°ï¼Œæ­£å¸¸è¯·å†µä¸‹è‚¯å®šæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼š

![](https://gitee.com/cbuc/picture/raw/master/20210327221324.png)

è®¢å•ç”Ÿæˆï¼Œåº“å­˜ä¹Ÿå¯¹åº”å‡å°‘ï¼Œæ„Ÿè§‰è‡ªå·±ä»£ç å¯ä»¥ä¸Šçº¿è¿›å…¥æ­£è½¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ¥æ¨¡æ‹Ÿä¸€ä¸‹åº“å­˜ä¸­çš„å¼‚å¸¸ï¼Œåº“å­˜å•†å“æ•°é‡å½’ä¸º **100**ï¼Œè®¢å•è¡¨æ¸…ç©ºï¼š

![](https://gitee.com/cbuc/picture/raw/master/20210327221629.png)

æˆ‘ä»¬ç»§ç»­å‘é€ä¸‹å•è¯·æ±‚ï¼Œå¯ä»¥çœ‹åˆ°åº“å­˜æœåŠ¡å·²ç»æŠ›å‡ºäº†å¼‚å¸¸

![](https://gitee.com/cbuc/picture/raw/master/20210327221841.png)

æ­£å¸¸æ¥è¯´è¿™ä¸ªæ—¶å€™ï¼Œåº“å­˜è¡¨æ•°é‡ä¸åº”è¯¥å‡å°‘ï¼Œè®¢å•è¡¨ä¸åº”è¯¥æ’å…¥è®¢å•æ•°æ®ï¼Œä½†æ˜¯äº‹å®çœŸçš„æ˜¯è¿™æ ·çš„å—ï¼Ÿæˆ‘ä»¬çœ‹æ•°æ®ï¼š

![](https://gitee.com/cbuc/picture/raw/master/20210327222049.png)

åº“å­˜æ•°é‡æ²¡å‡ï¼Œä½†æ˜¯è®¢å•å´å¢åŠ äº†ã€‚å¥½äº†ï¼Œåˆ°è¿™é‡Œï¼Œä½ å°±å·²ç»è§è¯†åˆ°äº†åˆ†å¸ƒå¼äº‹åŠ¡çš„ç¾éš¾æ€§å±å®³ã€‚æ¥ä¸‹æ¥ä¸»è§’ç™»åœºï¼

![](https://gitee.com/cbuc/picture/raw/master/20210328175616.gif)

##### Seata å®‰è£…

æˆ‘ä»¬é¦–å…ˆéœ€è¦ç‚¹å‡»[ä¸‹è½½åœ°å€](https://github.com/seata/seata/releases/)è¿›è¡Œä¸‹è½½ **Seata**ã€‚

ç”±äºæˆ‘ä»¬æ˜¯ä½¿ç”¨ **nacos** ä½œä¸ºæœåŠ¡ä¸­å¿ƒå’Œé…ç½®ä¸­å¿ƒï¼Œå› æ­¤æˆ‘ä»¬ä¸‹è½½è§£å‹åéœ€è¦åšä¸€äº›ä¿®æ”¹æ“ä½œ

- è¿›å…¥ `conf` ç›®å½•ç¼–è¾‘ `registry.conf` å’Œ `file.conf` ä¸¤ä¸ªæ–‡ä»¶ï¼Œç¼–è¾‘åå†…å®¹å¦‚ä¸‹ï¼š

![](https://gitee.com/cbuc/picture/raw/master/20210328171552.png)

![](https://gitee.com/cbuc/picture/raw/master/20210327231551.png)

- ç”±äºæ–°ç‰ˆ **Seata** ä¸­æ²¡æœ‰ `nacos-conf.sh` å’Œ `config.txt` ä¸¤ä¸ªæ–‡ä»¶ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ç‹¬ç«‹ä¸‹è½½ï¼š

> [nacos-config.sh ä¸‹è½½åœ°å€](https://github.com/seata/seata/blob/develop/script/config-center/nacos/nacos-config.sh)
>
> [config.txt ä¸‹è½½åœ°å€](https://github.com/seata/seata/blob/develop/script/config-center/config.txt)

æˆ‘ä»¬éœ€è¦å°† `config.txt` æ–‡ä»¶æ”¾åˆ° **seata** ç›®å½•ä¸‹ï¼Œè€Œé **conf** ç›®å½•ä¸‹ï¼Œå¹¶ä¸”éœ€è¦ä¿®æ”¹ `config.txt` å†…å®¹

![](https://gitee.com/cbuc/picture/raw/master/20210327232033.png)

![](https://gitee.com/cbuc/picture/raw/master/20210327231912.png)

> `config.txt`å°±æ˜¯seataå„ç§è¯¦ç»†çš„é…ç½®ï¼Œæ‰§è¡Œ `nacos-config.sh` å³å¯å°†è¿™äº›é…ç½®å¯¼å…¥åˆ°**nacos**ï¼Œè¿™æ ·å°±ä¸éœ€è¦å°†`file.conf`å’Œ`registry.conf`æ”¾åˆ°æˆ‘ä»¬çš„é¡¹ç›®ä¸­äº†ï¼Œéœ€è¦ä»€ä¹ˆé…ç½®å°±ç›´æ¥ä»**nacos**ä¸­è¯»å–ã€‚

- æ‰§è¡Œå¯¼å…¥

åœ¨ **conf** ç›®å½•ä¸‹æ‰“å¼€ git bash çª—å£ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```shell
sh nacos-config.sh -h localhost -p 8848 -g SEATA_GROUP -t namespace-id(éœ€è¦æ›¿æ¢) -u nacos -w nacos
```

æ“ä½œç»“æŸåï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥åœ¨ **nacos** æ§åˆ¶å°ä¸­çœ‹åˆ°é…ç½®åˆ—è¡¨ï¼Œæ—¥åé…ç½®æœ‰éœ€è¦ä¿®æ”¹ä¾¿å¯ä»¥ç›´æ¥ä»è¿™è¾¹ä¿®æ”¹ï¼Œè€Œä¸ç”¨ä¿®æ”¹ç›®å½•æ–‡ä»¶ï¼š

![](https://gitee.com/cbuc/picture/raw/master/20210327232319.png)

- æ•°æ®åº“é…ç½®

åœ¨ **1.4.1** æœ€æ–°ç‰ˆä¸­ä¾ç„¶æ²¡æœ‰ sql æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯éœ€è¦å¦å¤–ä¸‹è½½ï¼š[sql ä¸‹è½½åœ°å€](https://github.com/seata/seata/blob/1.4.1/script/server/db/mysql.sql)

åœ¨ **seata** æ•°æ®ä¸­æ‰§è¡Œè¿™ä¸ªæ–‡ä»¶ï¼Œç”Ÿæˆä¸‰å¼ è¡¨ï¼š

![](https://gitee.com/cbuc/picture/raw/master/20210327232549.png)

åœ¨æˆ‘ä»¬çš„ä¸šåŠ¡æ•°æ®åº“ä¸­æ‰§è¡Œ **undo_log** è¿™å¼ è¡¨ï¼š

```sql
CREATE TABLE `undo_log`
(
    `id` BIGINT(20) NOT NULL AUTO_INCREMENT,
    `branch_id` BIGINT(20) NOT NULL,
    `xid` VARCHAR(100) NOT NULL,
    `context` VARCHAR(128) NOT NULL,
    `rollback_info` LONGBLOB NOT NULL,
    `log_status` INT(11) NOT NULL,
    `log_created` DATETIME NOT NULL,
    `log_modified` DATETIME NOT NULL,
    `ext` VARCHAR(100) DEFAULT NULL,
    PRIMARY KEY (`id`),
    UNIQUE KEY `ux_undo_log` (`xid`, `branch_id`)
) ENGINE = INNODB
AUTO_INCREMENT = 1
DEFAULT CHARSET = utf8;
```

-  æ·»åŠ  log æ–‡ä»¶

å¦‚æœæˆ‘ä»¬æ²¡æœ‰logè¾“å‡ºæ–‡ä»¶ï¼Œå¯åŠ¨ **seata** å¯èƒ½ä¼šæŠ¥é”™ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨ **seata** ç›®å½•ä¸‹åˆ›å»º **logs** æ–‡ä»¶å¤¹ï¼Œåœ¨ logs æ–‡ä»¶ä¸‹åˆ›å»º `seata_gc.log` æ–‡ä»¶

![](https://gitee.com/cbuc/picture/raw/master/20210327233055.png)

- å¯åŠ¨

åšå¥½äº†ä»¥ä¸Šå‡†å¤‡ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥å¯åŠ¨ **seata** äº†ï¼Œç›´æ¥åœ¨ **bin** ç›®å½•ä¸‹ cmd æ‰§è¡Œ **bat** è„šæœ¬å³å¯ï¼Œå¯åŠ¨ç»“æŸä¾¿å¯åœ¨ **nacos** ä¸­çœ‹åˆ° **seata** æœåŠ¡ï¼š

![](https://gitee.com/cbuc/picture/raw/master/20210327233230.png)

##### Seata é›†æˆ

åœ¨ Seata å®‰è£…çš„æ­¥éª¤ä¸­æˆ‘ä»¬ä¾¿å®Œæˆäº† **Seata æœåŠ¡ç«¯** çš„å¯åŠ¨å®‰è£…ï¼Œæ¥ä¸‹æ¥å°±æ˜¯åœ¨é¡¹ç›®ä¸­é›†æˆ **Seata å®¢æˆ·ç«¯**

- ç¬¬ä¸€æ­¥ï¼šæˆ‘ä»¬éœ€è¦åœ¨ **pom.xml**  æ–‡ä»¶ä¸­æ·»åŠ ä¸¤ä¸ªä¾èµ–ï¼š`seata ä¾èµ–` å’Œ `nacos é…ç½®ä¾èµ–`

```xml
<!--nacos-->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>

<!--seata-->
<dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-seata</artifactId>
            <exclusions>
                <!-- æ’é™¤ä¾èµ– æŒ‡å®šç‰ˆæœ¬å’ŒæœåŠ¡å™¨ç«¯ä¸€è‡´ -->
                <exclusion>
                    <groupId>io.seata</groupId>
                    <artifactId>seata-all</artifactId>
                </exclusion>
                <exclusion>
                    <groupId>io.seata</groupId>
                    <artifactId>seata-spring-boot-starter</artifactId>
                </exclusion>
            </exclusions>
        </dependency>

        <dependency>
            <groupId>io.seata</groupId>
            <artifactId>seata-all</artifactId>
            <version>1.4.1</version>
        </dependency>

        <dependency>
            <groupId>io.seata</groupId>
            <artifactId>seata-spring-boot-starter</artifactId>
            <version>1.4.1</version>
        </dependency>
```

**æ³¨æ„ï¼š** è¿™é‡Œéœ€è¦æ’é™¤ `spring-cloud-starter-alibaba-seata` è‡ªå¸¦çš„ **seata** ä¾èµ–ï¼Œç„¶åå¼•å…¥æˆ‘ä»¬è‡ªå·±éœ€è¦çš„ **seata** ç‰ˆæœ¬ï¼Œå¦‚æœç‰ˆæœ¬ä¸ä¸€è‡´å¯åŠ¨æ—¶å¯èƒ½ä¼šé€ æˆ `no available server to connect` é”™è¯¯ï¼

- ç¬¬äºŒæ­¥ï¼šæˆ‘ä»¬éœ€è¦æŠŠ `restry.conf` æ–‡ä»¶å¤åˆ¶åˆ°é¡¹ç›®çš„ resource ç›®å½•ä¸‹

![](https://gitee.com/cbuc/picture/raw/master/20210328175208.png)

- ç¬¬ä¸‰æ­¥ï¼šéœ€è¦è‡ªå·±é…ç½®**seata**ä»£ç†æ•°æ®æº

```java
@Configuration
public class DataSourceProxyConfig {
    @Bean
    @ConfigurationProperties(prefix = "spring.datasource")
    public DruidDataSource druidDataSource() {
        return new DruidDataSource();
    }

    @Primary
    @Bean
    public DataSourceProxy dataSource(DruidDataSource druidDataSource) {
        return new DataSourceProxy(druidDataSource);
    }
}
```

é…ç½®å®Œæ•°æ®æºæˆ‘ä»¬å¾—åœ¨å¯åŠ¨ç±»çš„ `SpringBootApplication`  ä¸Šæ’é™¤Druidæ•°æ®æºä¾èµ–ï¼Œå¦åˆ™å¯èƒ½ä¼šå‡ºç°å¾ªç¯ä¾èµ–çš„é”™è¯¯ï¼š

```java
@SpringBootApplication(exclude = {DataSourceAutoConfiguration.class})
```

- ç¬¬å››æ­¥ï¼šåœ¨ **nacos** çš„é…ç½®æ–‡ä»¶æ§åˆ¶å°ä¸­åŠ å…¥æˆ‘ä»¬æœåŠ¡çš„äº‹åŠ¡ç»„é¡¹ï¼š

```properties
service.vgroupMapping + æœåŠ¡åç§° = default
groupä¸ºï¼š SEATA_GROUP
```

![](https://gitee.com/cbuc/picture/raw/master/20210328172234.png)

- ç¬¬äº”æ­¥ï¼šé¡¹ç›®ä¸­é…ç½®ä¿®æ”¹

![](https://gitee.com/cbuc/picture/raw/master/20210328172632.png)

- ç¬¬å…­æ­¥ï¼šå¼€å¯å…¨å±€äº‹åŠ¡

è¿™æ­¥å°±æ˜¯æœ€ç»ˆä¸€æ­¥äº†ï¼Œåœ¨æˆ‘ä»¬éœ€è¦å¼€å¯äº‹åŠ¡çš„æ–¹æ³•ä¸Šæ·»åŠ  `@GlobalTransactional` æ³¨è§£ï¼Œç±»ä¼¼äºæˆ‘ä»¬å•ä½“äº‹åŠ¡æ·»åŠ çš„`@Transactional`

![](https://gitee.com/cbuc/picture/raw/master/20210328173358.png)

##### Seata æµ‹è¯•

æˆ‘ä»¬ç°åœ¨å›åˆ°é¡¹ç›®ä¸­ï¼Œåœ¨ä¸Šé¢çš„ç¤ºä¾‹æ¼”ç¤ºä¸­ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†å¦‚æœåº“å­˜æœåŠ¡å‘ç”Ÿå¼‚å¸¸ï¼Œä¼šå‡ºç°çš„æƒ…å†µæ˜¯ï¼Œåº“å­˜æ²¡æœ‰å‡å°‘ï¼Œè€Œè®¢å•ä¾ç„¶ä¼šç”Ÿæˆã€‚é‚£æˆ‘ä»¬å¦‚æœå¢åŠ äº† **Seata** æ¥ç®¡ç†å…¨å±€äº‹åŠ¡ï¼Œæƒ…å†µæ˜¯å¦ä¼šæœ‰æ‰€æ”¹å˜ï¼Ÿæˆ‘ä»¬æµ‹è¯•å¦‚ä¸‹ï¼š

**åº“å­˜æœåŠ¡å·²ç»äº†å¼‚å¸¸ï¼š**

![](https://gitee.com/cbuc/picture/raw/master/20210328174731.png)

**çœ‹ä¸‹æ•°æ®åº“æ•°æ®ï¼š**

![](https://gitee.com/cbuc/picture/raw/master/20210328174842.png)

çœ‹æ ·å­æˆ‘ä»¬å…¨å±€äº‹åŠ¡å·²ç»ç”Ÿæ•ˆäº†ï¼Œäº‹åŠ¡ä¹Ÿå·²ç»å®Œç¾çš„æ§åˆ¶ä½äº†ï¼

è€Œæˆ‘ä»¬åˆ›å»ºçš„ **undo_log** è¿™å¼ è¡¨åœ¨ç®¡ç†äº‹åŠ¡ä¸­ä¹Ÿå¯åŠ¨äº†é‡è¦çš„ä½œç”¨ï¼š

![](https://gitee.com/cbuc/picture/raw/master/20210328171354.png)

çœ‹å®Œäº†ä»¥ä¸Šæ“ä½œï¼Œæˆ‘ä»¬è¶çƒ­æ‰“é“æ¥æ¢³ç†ä¸€ä¸‹å…¶ä¸­çš„æ‰§è¡Œæµç¨‹ï¼Œè®©ä½ å°è±¡æ›´åŠ æ·±åˆ»äº›~

![](https://gitee.com/cbuc/picture/raw/master/typora/20210325222025.png)

ç›¸ä¿¡çœ‹å®Œè¿™å¼ å›¾ï¼Œä½ å¯¹ **Seata** æ‰§è¡Œäº‹åŠ¡çš„æµç¨‹ä¹Ÿæ›´åŠ ç†Ÿæ‚‰äº†å§ï¼

è¿™è¿˜æ²¡ç»“æŸï¼Œæˆ‘ä»¬æ¥ç€æ¥çœ‹çœ‹å…¶ä¸­çš„ä¸€äº›è¦ç‚¹ï¼š

1. æ¯ä¸ª **RM** éƒ½éœ€è¦ä½¿ç”¨ **DataSourceProxy** è¿æ¥æ•°æ®åº“ï¼Œè¿™æ ·æ˜¯ä¸ºäº†ä½¿ç”¨ **ConnectionProxy**ï¼Œä½¿ç”¨æ•°æ®æºå’Œæ•°æ®è¿æ¥ä»£ç†çš„ç›®çš„å°±æ˜¯åœ¨ç¬¬ä¸€é˜¶æ®µå°† **undo_log** å’Œä¸šåŠ¡æ•°æ®æ”¾åœ¨ä¸€ä¸ªæœ¬åœ°äº‹åŠ¡æäº¤ï¼Œè¿™æ ·å°±ä¿å­˜äº†åªè¦æœ‰ä¸šåŠ¡æ“ä½œå°±ä¸€å®šæœ‰ **undo_log** äº§ç”Ÿï¼
2. åœ¨ç¬¬ä¸€é˜¶æ®µçš„ **undo_log** ä¸­å­˜æ”¾äº†æ•°æ®ä¿®æ”¹å‰å’Œä¿®æ”¹åçš„å€¼ï¼Œä¸ºäº‹åŠ¡å›æ»šåšå¥½å‡†å¤‡ï¼Œæ‰€ä»¥ç¬¬ä¸€é˜¶æ®µå°±å·²ç»å°†åˆ†æ”¯äº‹åŠ¡æäº¤ï¼Œä¹Ÿå°±é‡Šæ”¾äº†é”èµ„æºï¼
3. **TM**  å¼€å¯å…¨å±€äº‹åŠ¡åï¼Œä¾¿ä¼šå°† **XID** æ”¾å…¥å…¨å±€äº‹åŠ¡çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ **feign** è°ƒç”¨ä¹Ÿä¼šå°† **XID** ä¼ å…¥ä¸‹æ¸¸æœåŠ¡ä¸­ï¼Œæ¯ä¸ªåˆ†æ”¯äº‹åŠ¡éƒ½ä¼šå°†è‡ªå·±çš„ **Branch ID** ä¸ **XID** ç›¸å…³è”ï¼
4. ç¬¬äºŒé˜¶æ®µå¦‚æœå…¨å±€äº‹åŠ¡æ˜¯æ­£å¸¸æäº¤ï¼Œé‚£ä¹ˆ**TC** ä¼šé€šçŸ¥å„åˆ†æ”¯å‚ä¸è€…æäº¤åˆ†æ”¯äº‹åŠ¡ï¼Œå„å‚ä¸è€…åªéœ€è¦åˆ é™¤å¯¹åº”çš„ **undo_log** å³å¯ï¼Œå¹¶ä¸”å¯ä»¥å¼‚æ­¥æ‰§è¡Œï¼
5. ç¬¬äºŒé˜¶æ®µå¦‚æœå…¨å±€äº‹åŠ¡éœ€è¦å›æ»šï¼Œé‚£ä¹ˆ **TC** ä¼šé€šçŸ¥å„åˆ†æ”¯äº‹åŠ¡å‚ä¸è€…å›æ»šåˆ†æ”¯äº‹åŠ¡ï¼Œé€šè¿‡ **XID** å’Œ **Branch ID** æ‰¾åˆ°ç›¸åº”çš„ **undo_log** æ—¥å¿—ï¼Œé€šè¿‡å›æ»šæ—¥å¿—ç”Ÿæˆåå‘ **SQL** å¹¶æ‰§è¡Œï¼Œå®Œæˆäº‹åŠ¡æäº¤ä¹‹å‰çš„çŠ¶æ€ï¼Œå¦‚æœå›æ»šå¤±è´¥ä¾¿ä¼šé‡è¯•å›æ»šæ“ä½œï¼

**END**

åˆ°è¿™é‡Œï¼Œä¸€ç¯‡åˆ†å¸ƒå¼äº‹åŠ¡å°±è®²å®Œäº†ï¼Œæˆ‘ä»¬å›é¡¾ä¸‹ï¼Œä»åˆ†å¸ƒå¼äº‹åŠ¡çš„äº”ç§è§£å†³æ–¹æ¡ˆåˆ°å¼•å‡º **Seata** çš„ä½¿ç”¨ï¼Œå°èœåŒå­¦çœŸæ˜¯ç”¨å¿ƒè‰¯è‹¦~  è¨€å½’æ­£ä¼ ï¼Œçœ‹å®Œåå¸æ”¶äº†å¤šå°‘ï¼ŒåŠ¨åŠ¨å°æ‰‹ï¼Œå†™å†™ä»£ç ï¼Œè®©çŸ¥è¯†ä¸ä½ æ›´äº²è¿‘~

![çœ‹å®Œä¸èµï¼Œéƒ½æ˜¯åè›‹](https://gitee.com/cbuc/picture/raw/master/typora/20210325223703.png)
> ä»Šå¤©çš„ä½ å¤šåŠªåŠ›ä¸€ç‚¹ï¼Œæ˜å¤©çš„ä½ å°±èƒ½å°‘è¯´ä¸€å¥æ±‚äººçš„è¯ï¼
>
> *æˆ‘æ˜¯å°èœï¼Œä¸€ä¸ªå’Œä½ ä¸€èµ·å­¦ä¹ çš„ç”·äººã€‚* `ğŸ’‹`
>
>
> å¾®ä¿¡å…¬ä¼—å·å·²å¼€å¯ï¼Œ**å°èœè‰¯è®°**ï¼Œæ²¡å…³æ³¨çš„åŒå­¦ä»¬è®°å¾—å…³æ³¨å“¦ï¼