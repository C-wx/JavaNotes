å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å°èœï¼Œä¸€ä¸ªæ¸´æœ›åœ¨äº’è”ç½‘è¡Œä¸šåšåˆ°è”¡ä¸èœçš„å°èœã€‚å¯æŸ”å¯åˆšï¼Œç‚¹èµåˆ™æŸ”ï¼Œç™½å«–åˆ™åˆšï¼
**æ­»é¬¼~çœ‹å®Œè®°å¾—ç»™æˆ‘æ¥ä¸ªä¸‰è¿å“¦ï¼**

![](https://mmbiz.qlogo.cn/mmbiz_jpg/P7WuIzkp9iaVqg4wKjOlo2cia6ibCCRkwD1HDVQavMXmkLTqSh5uIxcvJW4Mb7DHWm7q2b5zgbluU6vGhBsia7vGEw/0?wx_fmt=jpeg)

> æœ¬æ–‡ä¸»è¦ä»‹ç» `JVMå’ŒGCè§£æ`
> å¦‚æœ‰éœ€è¦ï¼Œå¯ä»¥å‚è€ƒ
> å¦‚æœ‰å¸®åŠ©ï¼Œä¸å¿˜ **ç‚¹èµ** â¥
>
> åˆ›ä½œä¸æ˜“ï¼Œç™½å«–æ— ä¹‰ï¼

### ä¸€ã€JVMå†…å­˜ä½“ç³»

å…¶ä¸­*æ–¹æ³•åŒº*å’Œ*å †*è¢«JVMä¸­å¤šä¸ª`çº¿ç¨‹å…±äº«`ï¼Œæ¯”å¦‚ç±»çš„é™æ€å¸¸é‡å°±è¢«å­˜æ”¾åœ¨æ–¹æ³•åŒºï¼Œä¾›ç±»å¯¹è±¡ä¹‹é—´å…±äº«ã€‚

*è™šæ‹Ÿæœºæ ˆ*ã€*æœ¬åœ°æ–¹æ³•æ ˆ*ã€*ç¨‹åºè®¡æ•°å™¨*æ˜¯æ¯ä¸ª`çº¿ç¨‹ç‹¬ç«‹`æ‹¥æœ‰çš„ï¼Œä¸ä¼šä¸å…¶ä»–çº¿ç¨‹å…±äº«ã€‚

æ‰€ä»¥Javaåœ¨é€šè¿‡newåˆ›å»ºä¸€ä¸ªç±»å¯¹è±¡å®ä¾‹çš„æ—¶å€™ï¼Œä¸€æ–¹é¢ä¼šåœ¨è™šæ‹Ÿæœºæ ˆä¸­åˆ›å»ºä¸€ä¸ªå¯¹è¯¥å¯¹è±¡çš„å¼•ç”¨ï¼Œå¦ä¸€æ–¹é¢ä¼šåœ¨å †ä¸Šåˆ›å»ºç±»å¯¹è±¡çš„å®ä¾‹ï¼Œç„¶åå°†å¯¹è±¡å¼•ç”¨æŒ‡å‘è¯¥å¯¹è±¡çš„å®ä¾‹ã€‚å¯¹è±¡å¼•ç”¨å­˜æ”¾åœ¨æ¯ä¸€ä¸ªæ–¹æ³•å¯¹åº”çš„æ ˆå¸§ä¸­ã€‚

![img](https://mmbiz.qlogo.cn/mmbiz_png/P7WuIzkp9iaVqg4wKjOlo2cia6ibCCRkwD1p69H8z8CDzbPtmYMqn0ScaAuD4EV9OtbBgoByQpcYZHqQ1Ju8IInKA/0?wx_fmt=png)

- `è™šæ‹Ÿæœºæ ˆï¼š`è™šæ‹Ÿæœºæ ˆä¸­æ‰§è¡Œæ¯ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ç”¨äºå­˜å‚¨å±€éƒ¨å˜é‡è¡¨ï¼Œæ“ä½œæ•°æ ˆï¼ŒåŠ¨æ€é“¾æ¥ï¼Œæ–¹æ³•å‡ºå£ç­‰ä¿¡æ¯ã€‚
- `æœ¬åœ°æ–¹æ³•æ ˆï¼š`ä¸è™šæ‹Ÿæœºæ ˆå‘æŒ¥çš„ä½œç”¨ç›¸ä¼¼ï¼Œç›¸æ¯”äºè™šæ‹Ÿæœºæ ˆä¸ºJavaæ–¹æ³•æœåŠ¡ï¼Œæœ¬åœ°æ–¹æ³•æ ˆä¸ºè™šæ‹Ÿæœºä½¿ç”¨çš„Nativeæ–¹æ³•æœåŠ¡ï¼Œæ‰§è¡Œæ¯ä¸ªæœ¬åœ°æ–¹æ³•çš„æ—¶å€™ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ç”¨äºå­˜å‚¨å±€éƒ¨å˜é‡è¡¨ï¼Œæ“ä½œæ•°æ ˆï¼ŒåŠ¨æ€é“¾æ¥ï¼Œæ–¹æ³•å‡ºå£ç­‰ä¿¡æ¯ã€‚
- `æ–¹æ³•åŒºï¼š`å®ƒç”¨äºå­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„*ç±»ä¿¡æ¯ï¼Œå¸¸é‡ï¼Œé™æ€å˜é‡*ï¼Œå³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ï¼Œæ–¹æ³•åŒºåœ¨JDK1.7ç‰ˆæœ¬åŠä¹‹å‰ç§°ä¸ºæ°¸ä¹…ä»£ï¼Œä»JDK1.8ä¹‹åæ°¸ä¹…ä»£è¢«ç§»é™¤ã€‚
- `å †ï¼š`å †æ˜¯Javaå¯¹è±¡çš„å­˜å‚¨åŒºåŸŸï¼Œä»»ä½•newå­—æ®µåˆ†é…çš„*Javaå¯¹è±¡å®ä¾‹å’Œæ•°ç»„*ï¼Œéƒ½è¢«åˆ†é…åœ¨äº†å †ä¸Šï¼ŒJavaå †å¯ä½¿ç”¨ `- Xms` å’Œ`-Xmx` è¿›è¡Œå†…å­˜æ§åˆ¶ï¼Œä»JDK1.7ç‰ˆæœ¬ä¹‹åï¼Œ*è¿è¡Œæ—¶å¸¸é‡æ± *ä»æ–¹æ³•åŒºç§»åˆ°äº†å †ä¸Šã€‚
- `ç¨‹åºè®¡æ•°å™¨ï¼š`æŒ‡ç¤ºJavaè™šæ‹Ÿæœºä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ã€‚

### äºŒã€JAVA8ä¹‹åçš„JVM

*ä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºJAVA8çš„JVM ç”¨å…ƒç©ºé—´å–ä»£äº†æ°¸ä¹…ä»£*

![img](https://mmbiz.qlogo.cn/mmbiz_png/P7WuIzkp9iaVqg4wKjOlo2cia6ibCCRkwD1yLQCSpYHmCuiaJwGorb251hE07cZlZvk4p5TsgAsdiaE0h84Ds2WRdDw/0?wx_fmt=png)



![img](https://mmbiz.qlogo.cn/mmbiz_png/P7WuIzkp9iaVqg4wKjOlo2cia6ibCCRkwD1WibQ4jmmK9ia6BbI0aUoibCiax8383oR7v3cCJT9Rt6ZS3qGzmwffsmLtw/0?wx_fmt=png)



![img](https://mmbiz.qlogo.cn/mmbiz_png/P7WuIzkp9iaVqg4wKjOlo2cia6ibCCRkwD19Ky786FzjyT5REWibQOia17HqPOafknfj9XZFMNIyT2DZJAuWddNToVw/0?wx_fmt=png)

### ä¸‰ã€GCä½œç”¨åŸŸ

![img](https://mmbiz.qlogo.cn/mmbiz_png/P7WuIzkp9iaVqg4wKjOlo2cia6ibCCRkwD10xNaUaLDufjIvF9YOrqII96HfJE1SPFzZnjviaE6a6LW1gv2fWFNDvQ/0?wx_fmt=png)

### å››ã€å¸¸è§åƒåœ¾å›æ”¶ç®—æ³•

#### 1ï¼‰å¼•ç”¨è®¡æ•°æ³•ï¼š

*JVMçš„å®ç°ä¸€èˆ¬ä¸é‡‡ç”¨è¿™ç§æ–¹å¼*

![img](https://mmbiz.qlogo.cn/mmbiz_png/P7WuIzkp9iaVqg4wKjOlo2cia6ibCCRkwD12icIrh6pKnK3R7vJ9HcJCf0JvSq11Y64ocUZqYQCn0fZEpqBwdy1RlA/0?wx_fmt=png)


*ç¼ºç‚¹*ï¼š

- æ¯æ¬¡å¯¹å¯¹è±¡èµ‹å€¼æ—¶å‡è¦ç»´æŠ¤å¼•ç”¨è®¡æ•°å™¨ï¼Œä¸”è®¡æ•°å™¨æœ¬èº«ä¹Ÿæœ‰ä¸€å®šçš„æ¶ˆè€—ï¼›
- è¾ƒéš¾å¤„ç†å¾ªç¯å¼•ç”¨ï¼›

#### 2ï¼‰å¤åˆ¶ç®—æ³•ï¼š

Java å †ä»GCçš„è§’åº¦å¯ä»¥ç»†åˆ†ä¸ºï¼š**æ–°ç”Ÿä»£**ï¼ˆEdenåŒºã€From SurvivoråŒº å’Œ To SurvivoråŒºï¼‰å’Œ è€å¹´ä»£ã€‚
*ç‰¹ç‚¹*ï¼š
å¤åˆ¶ç®—æ³•ä¸ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼Œä½†ä¼šå ç”¨ç©ºé—´ã€‚ç”¨äºæ–°ç”Ÿä»£ã€‚

![ ](https://mmbiz.qlogo.cn/mmbiz_png/P7WuIzkp9iaVqg4wKjOlo2cia6ibCCRkwD1EubGve4kezb4DaXGatSRMg7CYuOiaXVF7gFPLuYsxqSsrjW3ejsQ2tw/0?wx_fmt=png)


*MinorGCçš„è¿‡ç¨‹ï¼ˆå¤åˆ¶ --> æ¸…ç©º --> äº’æ¢ï¼‰*ï¼š

1. **å¤åˆ¶ï¼š** ï¼ˆEdenã€SurvivorFrom å¤åˆ¶åˆ° SurvivorToï¼Œå¹´é¾„åŠ 1ï¼‰
   é¦–å…ˆï¼Œå½“EdenåŒºæ»¡çš„æ—¶å€™ä¼šè§¦å‘ç¬¬ä¸€æ¬¡GCï¼ŒæŠŠè¿˜æ´»ç€çš„å¯¹è±¡æ‹·è´åˆ°SurvivorFromåŒºï¼Œå½“EdenåŒºå†æ¬¡è§¦å‘GCçš„æ—¶å€™ä¼šæ‰«æEdenåŒºåŸŸå’ŒFromåŒºåŸŸï¼Œå¯¹è¿™ä¸¤ä¸ªåŒºåŸŸè¿›è¡Œåƒåœ¾å›æ”¶ï¼Œç»è¿‡è¿™æ¬¡å›æ”¶åè¿˜å­˜æ´»çš„å¯¹è±¡ï¼Œåˆ™ç›´æ¥å¤åˆ¶åˆ°ToåŒºåŸŸï¼ˆå¦‚æœæœ‰å¯¹è±¡çš„å¹´é¾„å·²ç»åˆ°è¾¾äº†è€å¹´çš„æ ‡å‡†ï¼Œåˆ™å¤åˆ¶åˆ°è€å¹´ä»£åŒºï¼‰ï¼ŒåŒæ—¶æŠŠè¿™äº›å¯¹è±¡çš„å¹´é¾„åŠ 1ã€‚
2. **æ¸…ç©ºï¼š**ï¼ˆæ¸…ç©ºEdenã€SurvivorFromï¼‰
   æ¸…ç©ºEdenå’ŒSurvivorFromä¸­çš„å¯¹è±¡ï¼Œä¹Ÿå³å¤åˆ¶ä¹‹åæœ‰äº¤æ¢ï¼Œè°ç©ºè°æ˜¯toã€‚
3. **äº’æ¢ï¼š**(SurvivorToå’ŒSurvivorFrom äº’æ¢)
   æœ€åï¼ŒSurvivorToå’ŒSurvivorFrom äº’æ¢ï¼ŒåŸSurvivorToæˆä¸ºä¸‹ä¸€æ¬¡GCæ˜¯çš„SurvivorFromåŒºã€‚

#### 3ï¼‰æ ‡è®°æ¸…é™¤æ³•

ç®—æ³•åˆ†æˆ`æ ‡è®°`å’Œ`æ¸…é™¤`ä¸¤ä¸ªé˜¶æ®µï¼Œ*å…ˆæ ‡è®°å‡ºè¦å›æ”¶çš„å¯¹è±¡ï¼Œç„¶åç»Ÿä¸€å›æ”¶è¿™äº›ã€‚*
*ç‰¹ç‚¹*ï¼š
ä¸ä¼šå ç”¨é¢å¤–ç©ºé—´ï¼Œä½†ä¼šæ‰«æä¸¤æ¬¡ï¼Œè€—æ—¶ï¼Œå®¹æ˜“äº§ç”Ÿç¢ç‰‡ï¼Œç”¨äºè€å¹´ä»£

![ ](https://mmbiz.qlogo.cn/mmbiz_png/P7WuIzkp9iaVqg4wKjOlo2cia6ibCCRkwD1icpficFshU8ZicDfavAvXhnWNehKmZQibbaSgW3dWcRMkOelQQRtOS7Q2w/0?wx_fmt=png)

#### 4ï¼‰æ ‡è®°å‹ç¼©æ³•

*ä¼˜ç‚¹*ï¼š
æ²¡æœ‰å†…å­˜ç¢ç‰‡ï¼Œå¯ä»¥åˆ©ç”¨bump
*ç¼ºç‚¹*ï¼š
éœ€è¦ç§»åŠ¨å¯¹è±¡çš„æˆæœ¬ï¼Œç”¨äºè€å¹´ä»£
*åŸç†*ï¼š

æ ‡è®°ï¼šä¸æ ‡è®°æ¸…é™¤ä¸€æ ·

![ ](https://mmbiz.qlogo.cn/mmbiz_png/P7WuIzkp9iaVqg4wKjOlo2cia6ibCCRkwD1JKIMnDPtPr6LcqBzWT7Z4Dj27j7VpsibpbZgF5tnQFJnAMW3dB9ruEw/0?wx_fmt=png)


å‹ç¼©ï¼šå†æ¬¡æ‰«æï¼Œå¹¶å¾€ä¸€æ®µæ»‘åŠ¨å­˜æ´»å¯¹è±¡

![ ](https://mmbiz.qlogo.cn/mmbiz_png/P7WuIzkp9iaVqg4wKjOlo2cia6ibCCRkwD1FFNvJlEj0dBBpKjdkTfRY0tdL85fmx0k8nclP1ib0icG6EGE5ia3BNMqw/0?wx_fmt=png)

### äº”ã€åˆ¤æ–­å¯¹è±¡æ˜¯å¦å¯å›æ”¶

#### 1ï¼‰å¼•ç”¨è®¡æ•°æ³•

Javaä¸­ï¼Œ*å¼•ç”¨å’Œå¯¹è±¡æ˜¯æœ‰å…³è”çš„*ã€‚å¦‚æœè¦æ“ä½œå¯¹è±¡åˆ™å¿…é¡»ç”¨`å¼•ç”¨è¿›è¡Œ`ã€‚
å› æ­¤ï¼Œå¾ˆæ˜¾ç„¶çš„ä¸€ä¸ªæ–¹æ³•å°±æ˜¯é€šè¿‡`å¼•ç”¨è®¡æ•°`æ¥åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¯ä»¥å›æ”¶ã€‚ç®€å•æ¥è¯´å°±æ˜¯ç»™å¯¹è±¡æ·»åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ã€‚*æ¯å½“æœ‰ä¸€ä¸ªåœ°æ–¹å¼•ç”¨å®ƒï¼Œè®¡æ•°å™¨çš„å€¼åŠ 1ï¼Œæ¯å½“æœ‰ä¸€ä¸ªå¼•ç”¨å¤±æ•ˆæ—¶ï¼Œè®¡æ•°å™¨çš„å€¼å‡1ã€‚*
ä»»ä½•æ—¶åˆ»è®¡æ•°å™¨å€¼ä¸º0çš„å¯¹è±¡å°±æ˜¯ä¸å¯èƒ½å†è¢«ä½¿ç”¨çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°±æ˜¯å¯å›æ”¶å¯¹è±¡ã€‚
*ç¼ºç‚¹*ï¼š

å¾ˆéš¾è§£å†³å¯¹è±¡ä¹‹é—´ç›¸äº’å¾ªç¯å¼•ç”¨çš„é—®é¢˜

#### 2ï¼‰æšä¸¾æ ¹èŠ‚ç‚¹åšå¯è¾¾æ€§åˆ†æ(æ ¹æœç´¢è·¯å¾„)

æ‰€è°“`GC roots`æˆ–è€…è¯´`tracing GC` çš„ *æ ¹é›†åˆ* å°±æ˜¯ä¸€ç»„å¿…é¡»æ´»è·ƒçš„å¼•ç”¨ã€‚
åŸºæœ¬æ€è·¯å°±æ˜¯é€šè¿‡ä¸€ç³»åˆ—åä¸º`GC Root` çš„å¯¹è±¡ä½œä¸ºèµ·å§‹ç‚¹ï¼Œä»è¿™ä¸ªè¢«ç§°ä¸º`GC Roots`çš„å¯¹è±¡*å¼€å§‹å‘ä¸‹æœç´¢*ã€‚

*å¦‚GC Rootsæ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿æ˜¯ï¼Œåˆ™è¯´æ˜æ­¤å¯¹è±¡ä¸å¯ç”¨ã€‚ä¹Ÿå³ç»™å®šä¸€ä¸ªé›†åˆçš„å¼•ç”¨ä½œä¸ºæ ¹å‡ºå‘ï¼Œé€šè¿‡å¼•ç”¨å…³ç³»*

![ ](https://mmbiz.qlogo.cn/mmbiz_png/P7WuIzkp9iaVqg4wKjOlo2cia6ibCCRkwD1ZE94wqQju7JBcX1yWNOJoVoO3BxcmGCnklKTcJhxz4Ea8DP60LDFbQ/0?wx_fmt=png)

#### å“ªäº›å¯ä»¥åšGCRootså¯¹è±¡

- `è™šæ‹Ÿæœºæ ˆ`ï¼ˆæ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡åŒºï¼Œä¹Ÿå«åšå±€éƒ¨å˜é‡è¡¨ï¼‰
- `æ–¹æ³•åŒºä¸­çš„ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡`
- `æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡`
- `æœ¬åœ°æ–¹æ³•æ ˆä¸­Nï¼ˆNativeæ–¹æ³•ï¼‰å¼•ç”¨çš„å¯¹è±¡`

### å…­ã€JVMçš„å‚æ•°ç±»å‹

#### 1ï¼‰æ ‡é…å‚æ•°

- `java -version`

- `java -help`

  ![ ](https://mmbiz.qlogo.cn/mmbiz_png/P7WuIzkp9iaVqg4wKjOlo2cia6ibCCRkwD15usSWIz9nEj0Vv2dQ0ic8xZoQ96cd7qibVR7x8CsGyLZ6LNkedrjwdSA/0?wx_fmt=png)

#### 2ï¼‰Xå‚æ•°

- `java -Xint -version` ï¼šè§£é‡Šæ‰§è¡Œ

- `java -Xcomp -version` ï¼šç¬¬ä¸€æ¬¡ä½¿ç”¨å°±ç¼–è¯‘æˆæœ¬åœ°ä»£ç 

- `java -Xmixed` ï¼šæ··åˆæ¨¡å¼

  ![ ](https://mmbiz.qlogo.cn/mmbiz_png/P7WuIzkp9iaVqg4wKjOlo2cia6ibCCRkwD1TRTCia0T5atiasWocswS7Qn0EzYA8jrzP41ITErYvDCgnO2ib76icZBZBA/0?wx_fmt=png)

#### 3ï¼‰XXå‚æ•°

- *Booleanç±»å‹*

`-XX`ï¼š*`+` æˆ–è€… `-` æŸä¸ªå±æ€§å€¼ï¼ˆ`+`ï¼šè¡¨ç¤ºå¼€å¯ï¼Œ`-`ï¼šè¡¨ç¤ºå…³é—­ï¼‰*
***ä¾‹å­\***ï¼š
`-XX: +PrintGCDetails`ï¼š å¼€å¯æ‰“å°GCæ”¶é›†ç»†èŠ‚
`-XX: -PrintGCDetails`ï¼š å…³é—­æ‰“å°GCæ”¶é›†ç»†èŠ‚
`-XX: +UseSerialGC`ï¼š å¼€å¯ä¸²è¡Œåƒåœ¾æ”¶é›†å™¨
`-XX: -UseSerialGC`ï¼šå…³é—­ä¸²è¡Œåƒåœ¾æ”¶é›†å™¨

- *KVè®¾ç½®ç±»å‹*

`-XX`: *å±æ€§key = å±æ€§value*
***ä¾‹å­\***ï¼š
`-XX: MetaspaceSize = 128m`ï¼šè®¾ç½®å…ƒç©ºé—´å¤§å°ä¸º128m 
`-XX:MaxTenuringThreshold = 15`ï¼šæ§åˆ¶æ–°ç”Ÿä»£éœ€è¦ç»å†å¤šå°‘æ¬¡GCæ™‹å‡åˆ°è€å¹´ä»£ä¸­çš„æœ€å¤§é˜ˆå€¼

- *jinfo -æŸ¥çœ‹å½“å‰è¿è¡Œç¨‹åºçš„é…ç½®*

***å…¬å¼\***ï¼š`jinfo -flag` é…ç½®é¡¹  è¿›ç¨‹ç¼–å·
***ä¾‹å­\***ï¼š

1. æŸ¥çœ‹åˆå§‹å †å¤§å°ï¼š

   ![ ](https://mmbiz.qlogo.cn/mmbiz_png/P7WuIzkp9iaVqg4wKjOlo2cia6ibCCRkwD1jiazN0YQSDK5er6G5IAHdfPUfj5hicG0XUkNIgbgWl1pBnFuSLJ2xe5A/0?wx_fmt=png)

2. æŸ¥çœ‹å…¶ä»–å‚æ•°

   ![img](https://mmbiz.qlogo.cn/mmbiz_png/P7WuIzkp9iaVqg4wKjOlo2cia6ibCCRkwD1rLrK0fsJsIOydPEp7KI9avW9ZvFMVAebJ8epCGkKoBrLwbym2XeHicg/0?wx_fmt=png)

3. æŸ¥çœ‹ä½¿ç”¨å“ªç§åƒåœ¾å›æ”¶å™¨

   ![ ](https://mmbiz.qlogo.cn/mmbiz_png/P7WuIzkp9iaVqg4wKjOlo2cia6ibCCRkwD1uO6YTiawycTdqRxrGueyHFybFzG2ya9V7kIonRh5tibFGibGEUGRNJVoQ/0?wx_fmt=png)

```
ä¸¤ä¸ªç»å…¸å‚æ•°
```

- `-Xms` ç­‰ä»·äº `-XX: InitialHeapSize`
- `-Xmx` ç­‰ä»·äº `-XX: MaxHeapSize`

### ä¸ƒã€æŸ¥çœ‹JVMé»˜è®¤å€¼

- `-XX:+PrintFlagsInitial`ï¼š æŸ¥çœ‹é»˜è®¤åˆå§‹å€¼

- - `java -XX: +PrintFlagsInitial -version`

  - `java -XX: +PrintFlagsInitial`

    ![ ](https://mmbiz.qlogo.cn/mmbiz_png/P7WuIzkp9iaVqg4wKjOlo2cia6ibCCRkwD17lpKmGEKOFbroNYz43P7IAsKry1bANx02fic8iaCAIrw4U33Iymjbwibw/0?wx_fmt=png)

- `-XX:+PrintFlagsFinal` ï¼šæŸ¥çœ‹ä¿®æ”¹æ›´æ–°

- - `java -XX:+PrintFlagsFinal`

  - `java -XX:+PrintFlagsFinal -version`

  - `java -XX:+PrintCommandedLineFlags`

    ![ ](https://mmbiz.qlogo.cn/mmbiz_png/P7WuIzkp9iaVqg4wKjOlo2cia6ibCCRkwD1a6tf79XHhV2BG6ibGUovmc2BCYbcrfoZibVwa5BwNlFp0HQ5fwF1wibVw/0?wx_fmt=png)

### å…«ã€å¸¸ç”¨çš„é…ç½®å‚æ•°

*ç»å…¸æ¡ˆä¾‹è®¾ç½®*ï¼š
`-Xms128m -Xmx4096m -Xss1024k -XX:Metaspacesize=512m -XX:+PrintCommandLineFlags -XX:PrintGCDetails -XX:UseSerialGC`

- `-Xms`

*åˆå§‹åŒ–å¤§å°å†…å­˜ï¼Œé»˜è®¤ä¸ºç‰©ç†å†…å­˜1/64*
ç­‰ä»·äº `-XX:InitialHeapSize`

- `-Xmx`

*æœ€å¤§åˆ†é…å†…å­˜ï¼Œé»˜è®¤ä¸ºç‰©ç†å†…å­˜1/4*
ç­‰ä»·äº `-XX:MaxHeapSize`

- `-Xss`

*è®¾ç½®å•ä¸ªçº¿ç¨‹çš„å¤§å°ï¼Œä¸€èˆ¬é»˜è®¤ä¸º5112K~1024K*
ç­‰ä»·äº `-XX:ThreadStackSize`

- `-Xmn`

*è®¾ç½®å¹´è½»ä»£å¤§å°*

- `-XX:MetaspaceSize`

*è®¾ç½®å…ƒç©ºé—´å¤§å°*

å…ƒç©ºé—´çš„æœ¬è´¨å’Œæ°¸ä¹…ä»£ç±»ä¼¼ï¼Œéƒ½æ˜¯å¯¹JVMè§„èŒƒä¸­æ–¹æ³•åŒºçš„å®ç°ï¼Œä¸è¿‡å…ƒç©ºé—´ä¸æ°¸ä¹…ä»£ä¹‹é—´æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼š**å…ƒç©ºé—´å¹¶ä¸åœ¨è™šæ‹Ÿæœºä¸­ï¼Œè€Œæ˜¯ä½¿ç”¨æœ¬åœ°å†…å­˜**ã€‚å› æ­¤ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ**å…ƒç©ºé—´çš„å¤§å°ä»…å—æœ¬åœ°å†…å­˜é™åˆ¶**ã€‚

- `-XX:+PrintGCdetails`

*è¾“å‡ºè¯¦ç»†çš„GCæ”¶é›†æ—¥å¿—ä¿¡æ¯*

- `-XX:SurvivorRatio`

*è®¾ç½®æ–°ç”Ÿä»£ä¸­edenå’ŒS0/S1ç©ºé—´çš„æ¯”ä¾‹*
é»˜è®¤ï¼š
`-XX:SurvivorRatio=8` --> `Eden:S0:S1=8:1:1`
ä¿®æ”¹ï¼š
`-XX:SurvivorRatio=4` --> `Eden:S0:S1=4:1:1`
*SurvivorRatioå€¼å°±æ˜¯è®¾ç½®edenåŒºçš„æ¯”ä¾‹å å¤šå°‘ï¼ŒS0/S1ç›¸åŒ*

- `-XX:NewRatio`

*è®¾ç½®å¹´è½»ä»£ä¸è€å¹´ä»£åœ¨å †ç»“æ„çš„å æ¯”*
é»˜è®¤ï¼š
`-XX:NewRatio=2`ï¼š æ–°ç”Ÿä»£å 1ï¼Œè€å¹´ä»£å 2ï¼Œå¹´è½»ä»£å æ•´ä¸ªå †çš„1/3
ä¿®æ”¹ï¼š
`-XX:NewRatio=4`ï¼š æ–°ç”Ÿä»£å 1ï¼Œè€å¹´ä»£å 4ï¼Œå¹´è½»ä»£å æ•´ä¸ªå †çš„1/5
*NewRatioå€¼å°±æ˜¯è®¾ç½®è€å¹´ä»£çš„å æ¯”ï¼Œå‰©ä¸‹çš„1ç»™æ–°ç”Ÿä»£*

- `-XX:MaxTenuringThreshold`

*è®¾ç½®åƒåœ¾æœ€å¤§å¹´é¾„*
`-XX:MaxTenuringThreshold=0`ï¼šè®¾ç½®åƒåœ¾æœ€å¤§å¹´é¾„ã€‚

å¦‚æœè®¾ç½®ä¸º0çš„è¯ï¼Œåˆ™å¹´è½»ä»£å¯¹è±¡ä¸ç»è¿‡SurvivoråŒºï¼Œç›´æ¥è¿›å…¥è€å¹´ä»£ã€‚å¯¹äºè€å¹´ä»£æ¯”è¾ƒå¤šçš„åº”ç”¨ï¼Œå¯ä»¥æé«˜æ•ˆç‡ã€‚å¦‚æœå°†æ­¤å€¼è®¾ç½®ä¸ºä¸€ä¸ªè¾ƒå¤§å€¼ï¼Œåˆ™å¹´è½»ä»£å¯¹è±¡ä¼šåœ¨SurvivoråŒºè¿›è¡Œå¤šæ¬¡å¤åˆ¶ï¼Œè¿™æ ·å¯ä»¥å¢åŠ å¯¹è±¡åœ¨å¹´è½»ä»£çš„å­˜æ´»æ—¶é—´ï¼Œå¢åŠ å¹´è½»ä»£è¢«å›æ”¶çš„æ¦‚è®ºã€‚

### ä¹ã€å¼ºè½¯å¼±è™š

![ ](https://mmbiz.qlogo.cn/mmbiz_png/P7WuIzkp9iaVqg4wKjOlo2cia6ibCCRkwD1sTa8G0nEdm79OomicG2QkBKgC7j8m82iamHeFnsFfIdxUng7aptvKdRQ/0?wx_fmt=png)



![ ](https://mmbiz.qlogo.cn/mmbiz_png/P7WuIzkp9iaVqg4wKjOlo2cia6ibCCRkwD1rsGtiae5UwsmrEf9O56xj8js4T0yTpd2QoLj5erraXHzkW9kmm9Unkw/0?wx_fmt=png)

#### 1ï¼‰å¼ºå¼•ç”¨

- å½“å†…å­˜ä¸è¶³ï¼ŒJVMå¼€å§‹åƒåœ¾å›æ”¶ï¼Œå¯¹äºå¼ºå¼•ç”¨çš„å¯¹è±¡ï¼Œ*å°±ç®—å‡ºç°äº†OOMä¹Ÿä¸ä¼šå¯¹è¯¥å¯¹è±¡è¿›è¡Œå›æ”¶ï¼Œ`æ­»éƒ½ä¸æ”¶`*
- å¼ºå¼•ç”¨æ˜¯æˆ‘ä»¬æœ€å¸¸è§çš„æ™®é€šå¯¹è±¡å¼•ç”¨ï¼Œåªè¦è¿˜æœ‰å¼ºå¼•ç”¨æŒ‡å‘ä¸€ä¸ªå¯¹è±¡ï¼Œå°±èƒ½è¡¨åå¯¹è±¡è¿˜`æ´»ç€`ï¼Œåƒåœ¾æ”¶é›†å™¨ä¸ä¼šç¢°è¿™ç§å¯¹è±¡ã€‚åœ¨Javaä¸­æœ€å¸¸è§çš„å°±æ˜¯å¼ºå¼•ç”¨ï¼ŒæŠŠä¸€ä¸ªå¯¹è±¡èµ‹ç»™ä¸€ä¸ªå¼•ç”¨å˜é‡ï¼Œè¿™ä¸ªå¼•ç”¨å˜é‡å°±æ˜¯ä¸€ä¸ªå¼ºå¼•ç”¨ã€‚å½“ä¸€ä¸ªå¯¹è±¡è¢«å¼ºå¼•ç”¨å˜é‡å¼•ç”¨æ—¶ï¼Œå®ƒå¤„äºå¯è¾¾çŠ¶æ€ï¼Œå®ƒæ˜¯ä¸å¯èƒ½è¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶çš„ã€‚*å³ä½¿è¯¥å¯¹è±¡ä»¥åæ°¸è¿œéƒ½ä¸ä¼šè¢«ç”¨åˆ°ï¼ŒJVMä¹Ÿä¸ä¼šå›æ”¶ã€‚* **å› æ­¤å¼ºå¼•ç”¨æ˜¯é€ æˆJavaå†…å­˜æ³„æ¼çš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚**
- å¯¹äºä¸€ä¸ªæ™®é€šçš„å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–çš„å¼•ç”¨å…³ç³»ï¼Œåªè¦è¶…è¿‡äº†å¼•ç”¨çš„ä½œç”¨åŸŸæˆ–è€…æ˜¾å¼åœ°å°†ç›¸åº”ï¼ˆå¼ºï¼‰å¼•ç”¨èµ‹å€¼ä¸º**null**ï¼Œä¸€èˆ¬å°±æ˜¯è®¤ä¸ºå¯ä»¥è¢«åƒåœ¾æ”¶é›†ï¼ˆå…·ä½“çœ‹åƒåœ¾æ”¶é›†ç­–ç•¥ï¼‰

```java
public static void main(String[] args) {
        Object o1 = new Object();   //é»˜è®¤ä¸ºå¼ºå¼•ç”¨
        Object o2 = o1;     //å¼•ç”¨èµ‹å€¼
        o1 = null;          //ç½®ç©º è®©åƒåœ¾æ”¶é›†
        System.gc();
        System.out.println(o1);     // null
        System.out.println(o2);     // java.lang.Object@1540e19d
    }
```

#### 2ï¼‰è½¯å¼•ç”¨

- è½¯å¼•ç”¨å°±æ˜¯ä¸€ç§ç›¸å¯¹å¼ºå¼•ç”¨å¼±åŒ–äº†ä¸€äº›çš„å¼•ç”¨ã€‚éœ€è¦ç”¨java.lang.ref.SoftReferenceç±»æ¥å®ç°ï¼Œå¯ä»¥è®©å¯¹è±¡è±å…ä¸€äº›åƒåœ¾æ”¶é›†ã€‚
- ç³»ç»Ÿå†…å­˜`å……è¶³` -> ä¸ä¼šå›æ”¶
- ç³»ç»Ÿå†…å­˜`ä¸è¶³` -> ä¼šå›æ”¶
- è½¯å¼•ç”¨é€šå¸¸ç”¨åœ¨å¯¹å†…å­˜æ•æ„Ÿçš„ç¨‹åºä¸­ï¼Œæ¯”å¦‚é«˜é€Ÿç¼“å­˜å°±æœ‰ç”¨åˆ°è½¯å¼•ç”¨ï¼Œ*å†…å­˜å¤Ÿç”¨çš„æ—¶å€™å°±ä¿ç•™ï¼Œä¸å¤Ÿç”¨å°±å›æ”¶*

```java
    public static void main(String[] args) {
        Object o1 = new Object();
        SoftReference softReference = new SoftReference(o1);
        o1 = null;
        System.gc();
        System.out.println(o1);
        System.out.println(softReference.get());
    }
```

#### 3ï¼‰å¼±å¼•ç”¨

- å¼±å¼•ç”¨éœ€è¦ç”¨`java.lang.ref.WeakReference`ç±»æ¥å®ç°ï¼Œå®ƒæ¯”è½¯å¼•ç”¨çš„ç”Ÿå­˜æœŸæ›´çŸ­
- å¯¹äºå¼±å¼•ç”¨çš„å¯¹è±¡ï¼Œåªè¦åƒåœ¾å›æ”¶æœºåˆ¶ä¸€è¿è¡Œï¼Œä¸ç®¡JVMçš„å†…å­˜ç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼Œéƒ½ä¼šå›æ”¶è¯¥å¯¹è±¡å ç”¨çš„å†…å­˜ã€‚

```java
    public static void main(String[] args) {
        Object o1 = new Object();
        WeakReference weakReference = new WeakReference(o1);
        o1 = null;
        System.gc();
        System.out.println(o1);                     //null
        System.out.println(weakReference.get());    //null
    }
```

#### 4ï¼‰è™šå¼•ç”¨

- è™šå¼•ç”¨éœ€è¦`java.lang.ref.PhantomReference`ç±»æ¥å®ç°ã€‚
- *å½¢å¦‚è™šè®¾*ï¼Œå®ƒä¸ä¼šå†³å®šå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚
- *å¦‚æœä¸€ä¸ªå¯¹è±¡æŒæœ‰è™šå¼•ç”¨ï¼Œé‚£ä¹ˆå®ƒå°±å’Œæ²¡æœ‰ä»»ä½•ä¸€æ ·ï¼Œåœ¨ä»»ä½•æ—¶å€™éƒ½å¯èƒ½è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶*ï¼Œå®ƒä¸èƒ½å•ç‹¬ä½¿ç”¨ä¹Ÿä¸èƒ½é€šè¿‡å®ƒæ¥è®¿é—®å¯¹è±¡ï¼Œè™šå¼•ç”¨å¿…é¡»å’Œ`å¼•ç”¨é˜Ÿåˆ—ï¼ˆReferenceQueueï¼‰`è”åˆä½¿ç”¨ã€‚
- è™šå¼•ç”¨çš„ä¸»è¦ä½œç”¨æ˜¯è·Ÿè¸ªå¯¹è±¡è¢«åƒåœ¾å›æ”¶çš„çŠ¶æ€ï¼Œä»…ä»…æ˜¯æä¾›äº†ä¸€ç§ç¡®ä¿å¯¹è±¡è¢«`finalize`ä»¥åï¼ŒåšæŸäº›äº‹æƒ…çš„æœºåˆ¶ã€‚`PhantomReference`çš„`get()`æ–¹æ³•æ€»æ˜¯è¿”å›nullï¼Œå› æ­¤æ— æ³•è®¿é—®å¯¹åº”çš„å¼•ç”¨å¯¹è±¡ã€‚å…¶æ„ä¹‰åœ¨äº*è¯´æ˜ä¸€ä¸ªå¯¹è±¡å·²ç»è¿›å…¥finalizationé˜¶æ®µï¼Œå¯ä»¥è¢«gcå›æ”¶ï¼Œç”¨æ¥å®ç°æ¯”finalizationæœºåˆ¶æ›´çµæ´»çš„å›æ”¶æ“ä½œã€‚*

```java
public static void main(String[] args) {
        Object o1 = new Object();
        ReferenceQueue<Object> referenceQueue = new ReferenceQueue<>();
        PhantomReference<Object> phantomReference = new PhantomReference<>(o1,referenceQueue);
        System.out.println(o1);                         //java.lang.Object@1540e19d
        System.out.println(phantomReference.get());     //null
        System.out.println(referenceQueue.poll());      //null
    }
```

*æ‰©å±•*ï¼šè½¯å¼±å¼•ç”¨é€‚ç”¨åœºæ™¯

å‡å¦‚æœ‰ä¸€ä¸ªå¼•ç”¨éœ€è¦è¯»å–å¤§é‡çš„æœ¬åœ°å›¾ç‰‡
**å­˜åœ¨é—®é¢˜**ï¼š

1. å¦‚æœæ¯æ¬¡è¯»å–å›¾ç‰‡éƒ½ä»ç¡¬ç›˜è¯»å–åˆ™ä¼šä¸¥é‡å½±å“æ€§èƒ½ã€‚
2. å¦‚æœä¸€æ¬¡æ€§å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­æœ‰å¯èƒ½é€ æˆå†…å­˜æº¢å‡ºã€‚

**è§£å†³æ€è·¯**ï¼š
ç”¨ä¸€ä¸ªHashMapæ¥ä¿å­˜å›¾ç‰‡çš„è·¯å¾„å’Œç›¸åº”å›¾ç‰‡å¯¹è±¡å…³è”çš„è½¯å¼•ç”¨ä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œåœ¨å†…å­˜ä¸è¶³æ—¶ï¼ŒJVMä¼šè‡ªåŠ¨å›æ”¶è¿™äº›ç¼“å­˜å›¾ç‰‡å¯¹è±¡æ‰€å ç”¨çš„ç©ºé—´ï¼Œä»è€Œæœ‰æ•ˆåœ°é¿å…äº†OOMçš„é—®é¢˜ã€‚
`Map imgMap = new HashMap()`

`WeakHashMap`ï¼š

```java
public static void main(String[] args) {
        WeakHashMap<Integer,String> weakHashMap = new WeakHashMap<>();
        Integer key = new Integer(1);
        weakHashMap.put(key,"æµ‹è¯•1");
        System.out.println(weakHashMap);    //{1=æµ‹è¯•1}
        key=null;
        System.out.println(weakHashMap);    //{1=æµ‹è¯•1}
        System.gc();
        System.out.println(weakHashMap+"\t"+weakHashMap.size());    //{} 0
    }
```

![çœ‹å®Œä¸èµï¼Œéƒ½æ˜¯åè›‹](https://mmbiz.qlogo.cn/mmbiz_png/P7WuIzkp9iaVqg4wKjOlo2cia6ibCCRkwD1Rv4C3icjAnDGgz8dzqpBpjDKfE6OGiaCWI6jBR0XOfcMsJjIibRZBPicXw/0?wx_fmt=png)

> ä»Šå¤©çš„ä½ å¤šåŠªåŠ›ä¸€ç‚¹ï¼Œæ˜å¤©çš„ä½ å°±èƒ½å°‘è¯´ä¸€å¥æ±‚äººçš„è¯ï¼
>
> *æˆ‘æ˜¯å°èœï¼Œä¸€ä¸ªå’Œä½ ä¸€èµ·å­¦ä¹ çš„ç”·äººã€‚* `ğŸ’‹`