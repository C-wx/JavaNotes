å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å°èœï¼Œä¸€ä¸ªæ¸´æœ›åœ¨äº’è”ç½‘è¡Œä¸šåšåˆ°è”¡ä¸èœçš„å°èœã€‚å¯æŸ”å¯åˆšï¼Œç‚¹èµåˆ™æŸ”ï¼Œç™½å«–åˆ™åˆšï¼
**æ­»é¬¼~çœ‹å®Œè®°å¾—ç»™æˆ‘æ¥ä¸ªä¸‰è¿å“¦ï¼**


![](https://user-gold-cdn.xitu.io/2020/4/11/17169c46045528af?w=240&h=224&f=jpeg&s=7529)


>æœ¬æ–‡ä¸»è¦ä»‹ç» `ThreadLocal çš„ä½¿ç”¨`
>
>å¦‚æœ‰éœ€è¦ï¼Œå¯ä»¥å‚è€ƒ
>
>å¦‚æœ‰å¸®åŠ©ï¼Œä¸å¿˜ **ç‚¹èµ** â¥
>
>
>å¾®ä¿¡å…¬ä¼—å·å·²å¼€å¯ï¼Œ**å°èœè‰¯è®°**ï¼Œæ²¡å…³æ³¨çš„åŒå­¦ä»¬è®°å¾—å…³æ³¨å“¦ï¼

ä¹‹å‰æˆ‘ä»¬æœ‰åœ¨å¹¶å‘ç³»åˆ—ä¸­æåˆ° `ThreadLocal` ç±»å’ŒåŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼Œé‚£æˆ‘ä»¬å°±æ¥çœ‹ä¸‹ `ThreadLocal` ç©¶ç«Ÿæ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼

## ThreadLocal ç®€ä»‹

### æ¦‚å¿µ

**ThreadLocal** ç±»æ˜¯ç”¨æ¥æä¾›çº¿ç¨‹å†…éƒ¨çš„å±€éƒ¨å˜é‡ã€‚è¿™ç§å˜é‡åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è®¿é—®ï¼ˆ**get** å’Œ **set** æ–¹æ³•è®¿é—®ï¼‰æ—¶èƒ½ä¿è¯å„ä¸ªçº¿ç¨‹çš„å˜é‡ç›¸å¯¹ç‹¬ç«‹äºå…¶ä»–çº¿ç¨‹å†…çš„å˜é‡ã€‚ **ThreadLocal** å®ä¾‹é€šå¸¸æ¥è¯´éƒ½æ˜¯ **private static** ç±»å‹çš„ï¼Œç”¨äºå…³è”çº¿ç¨‹å’Œä¸Šä¸‹æ–‡ã€‚

### ä½œç”¨

- **ä¼ é€’æ•°æ®** 

æä¾›çº¿ç¨‹å†…éƒ¨çš„å±€éƒ¨å˜é‡ã€‚å¯ä»¥é€šè¿‡ **ThreadLocal** åœ¨åŒä¸€çº¿ç¨‹ï¼Œä¸åŒç»„ä»¶ä¸­ä¼ é€’å…¬å…±å˜é‡ã€‚

- **çº¿ç¨‹å¹¶å‘**

é€‚ç”¨äºå¤šçº¿ç¨‹å¹¶å‘æƒ…å†µä¸‹ã€‚

- **çº¿ç¨‹éš”ç¦»**

æ¯ä¸ªçº¿ç¨‹çš„å˜é‡éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¼šç›¸äº’å½±å“ã€‚

## ThreadLocal å®æˆ˜

### 1. å¸¸è§æ–¹æ³•

- **`ThreadLocal ()`**

**æ„é€ æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ª ThreadLocal å¯¹è±¡**

- **`void set (T value)`**

è®¾ç½®å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡

- **`T get ()`**

**è·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡**

- **`void remove ()`**

**ç§»é™¤å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡**

### 2. ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ ThreadLocal

é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹ä¸€ç»„å¹¶å‘æ¡ä»¶ä¸‹çš„ä»£ç åœºæ™¯ï¼š

```java
@Data
public class ThreadLocalTest {
    private String name;

    public static void main(String[] args) {
        ThreadLocalTest tmp = new ThreadLocalTest();
        for (int i = 0; i < 4; i++) {
            Thread thread = new Thread(() -> {
                tmp.setName(Thread.currentThread().getName());
                System.out.println(Thread.currentThread().getName() +
                                   "\t æ‹¿åˆ°æ•°æ®ï¼š" + tmp.getName());
            });
            thread.setName("Thread-" + i);
            thread.start();
        }
    }
}
```

æˆ‘ä»¬ç†æƒ³ä¸­çš„ä»£ç è¾“å‡ºç»“æœåº”è¯¥æ˜¯è¿™æ ·çš„ï¼š

```java
/** OUTPUT **/
Thread-0	 æ‹¿åˆ°æ•°æ®ï¼šThread-0
Thread-1	 æ‹¿åˆ°æ•°æ®ï¼šThread-1
Thread-2	 æ‹¿åˆ°æ•°æ®ï¼šThread-2
Thread-3	 æ‹¿åˆ°æ•°æ®ï¼šThread-3
```

ä½†æ˜¯å®é™…ä¸Šè¾“å‡ºçš„ç»“æœå´æ˜¯è¿™æ ·çš„ï¼š

```java
/** OUTPUT **/
Thread-0	 æ‹¿åˆ°æ•°æ®ï¼šThread-1
Thread-3	 æ‹¿åˆ°æ•°æ®ï¼šThread-3
Thread-1	 æ‹¿åˆ°æ•°æ®ï¼šThread-1
Thread-2	 æ‹¿åˆ°æ•°æ®ï¼šThread-2
```

é¡ºåºä¹±äº†æ²¡æœ‰å…³ç³»ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥çœ‹åˆ° **Thread-0** è¿™ä¸ªçº¿ç¨‹æ‹¿åˆ°çš„å€¼å´æ˜¯ **Thread-1**

ä»ç»“æœä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºå¤šä¸ªçº¿ç¨‹åœ¨è®¿é—®åŒä¸€ä¸ªå˜é‡çš„æ—¶å€™ä¼šå‡ºç°å¼‚å¸¸ï¼Œè¿™æ˜¯å› ä¸ºçº¿ç¨‹é—´çš„æ•°æ®æ²¡æœ‰éš”ç¦»ï¼

å¹¶å‘çº¿ç¨‹å‡ºç°çš„é—®é¢˜ï¼Ÿé‚£åŠ é”ä¸å°±å®Œäº‹äº†ï¼è¿™ä¸ªæ—¶å€™ä½ ä¸‰ä¸‹äº”é™¤äºŒçš„å†™ä¸‹äº†ä»¥ä¸‹ä»£ç ï¼š

```java
@Data
public class ThreadLocalTest {

    private String name;

    public static void main(String[] args) {
        ThreadLocalTest tmp = new ThreadLocalTest();
        for (int i = 0; i < 4; i++) {
            Thread thread = new Thread(() -> {
                synchronized (tmp) {
                    tmp.setName(Thread.currentThread().getName());
                    System.out.println(Thread.currentThread().getName() 
                                       + "\t" + tmp.getName());
                }
            });
            thread.setName("Thread-" + i);
            thread.start();
        }
    }
}
/** OUTPUT **/
Thread-2	Thread-2
Thread-3	Thread-3
Thread-1	Thread-1
Thread-0	Thread-0
```

ä»ç»“æœä¸Šçœ‹ï¼ŒåŠ é”å¥½åƒæ˜¯è§£å†³äº†ä¸Šè¿°é—®é¢˜ï¼Œä½†æ˜¯ **synchronized** å¸¸ç”¨äºå¤šçº¿ç¨‹æ•°æ®å…±äº«çš„é—®é¢˜ï¼Œè€Œéå¤šçº¿ç¨‹æ•°æ®éš”ç¦»çš„é—®é¢˜ã€‚è¿™é‡Œä½¿ç”¨ **synchronized** è™½ç„¶è§£å†³äº†é—®é¢˜ï¼Œä½†æ˜¯å¤šå°‘æœ‰äº›ä¸åˆé€‚ï¼Œå¹¶ä¸” **synchronized** å±äºé‡é‡çº§é”ï¼Œä¸ºäº†å®ç°å¤šçº¿ç¨‹æ•°æ®éš”ç¦»è´¸ç„¶çš„åŠ ä¸Š **synchronized**ï¼Œä¹Ÿä¼šå½±å“åˆ°æ€§èƒ½ã€‚

åŠ é”çš„æ–¹æ³•ä¹Ÿè¢«å¦å®šäº†ï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•è§£å†³ï¼Ÿä¸å¦‚ç”¨ **ThreadLocal** ç‰›åˆ€å°è¯•ä¸€ç•ªï¼š

```java
public class ThreadLocalTest {

    private static ThreadLocal<String> threadLocal = new ThreadLocal<>();

    public String getName() {
        return threadLocal.get();
    }

    public void setName(String name) {
        threadLocal.set(name);
    }

    public static void main(String[] args) {
        ThreadLocalTest tmp = new ThreadLocalTest();
        for (int i = 0; i < 4; i++) {
            Thread thread = new Thread(() -> {
                tmp.setName(Thread.currentThread().getName());
                System.out.println(Thread.currentThread().getName() + 
                                   "\t æ‹¿åˆ°æ•°æ®ï¼š" + tmp.getName());
            });
            thread.setName("Thread-" + i);
            thread.start();
        }
    }
}
```

åœ¨æŸ¥çœ‹è¾“å‡ºç»“æœä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä»£ç å‘ç”Ÿäº†é‚£äº›å˜åŒ–

é¦–å…ˆå¤šäº†ä¸€ä¸ª `private static` ä¿®é¥°çš„ **ThreadLocal** ï¼Œç„¶ååœ¨ `setName` çš„æ—¶å€™ï¼Œæˆ‘ä»¬å®é™…ä¸Šæ˜¯å¾€ **ThreadLocal** é‡Œé¢å­˜æ•°æ®ï¼Œåœ¨ `getName` çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ˜¯åœ¨ **ThreadLocal** é‡Œé¢å–æ•°æ®ã€‚æ„Ÿè§‰æ“ä½œä¸Šä¹Ÿæ˜¯æŒºç®€å•çš„ï¼Œä½†æ˜¯è¿™æ ·çœŸçš„èƒ½åšåˆ°çº¿ç¨‹é—´çš„æ•°æ®éš”ç¦»å—ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€çœ‹ç»“æœï¼š

```java
/** OUTPUT **/
Thread-1	 æ‹¿åˆ°æ•°æ®ï¼šThread-1
Thread-2	 æ‹¿åˆ°æ•°æ®ï¼šThread-2
Thread-0	 æ‹¿åˆ°æ•°æ®ï¼šThread-0
Thread-3	 æ‹¿åˆ°æ•°æ®ï¼šThread-3
```

ä»ç»“æœä¸Šå¯ä»¥çœ‹åˆ°æ¯ä¸ªçº¿ç¨‹éƒ½èƒ½å–åˆ°å¯¹åº”çš„æ•°æ®ã€‚**ThreadLocal** ä¹Ÿå·²ç»è§£å†³äº†å¤šçº¿ç¨‹ä¹‹é—´æ•°æ®éš”ç¦»çš„é—®é¢˜ã€‚

é‚£ä¹ˆæˆ‘ä»¬æ¥å°ç»“ä¸€ä¸‹ï¼Œ**ä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨ThreadLocalï¼Œä¸ synchronized çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ**

- **synchronized**

**åŸç†ï¼š** åŒæ­¥æœºåˆ¶é‡‡ç”¨ "ä»¥æ—¶é—´æ¢ç©ºé—´" çš„æ–¹å¼ï¼Œåªæä¾›äº†ä¸€ä»½å˜é‡ï¼Œè®©ä¸åŒçº¿ç¨‹æ’é˜Ÿè®¿é—®

**ä¾§é‡ç‚¹ï¼š** å¤šä¸ªçº¿ç¨‹ä¹‹é—´åŒæ­¥è®¿é—®èµ„æº

- **ThreadLocal**

**åŸç†ï¼š** ThreadLocal é‡‡ç”¨ "ä»¥ç©ºé—´æ¢æ—¶é—´" çš„æ–¹å¼ï¼Œä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½æä¾›äº†ä¸€ä»½å˜é‡çš„å‰¯æœ¬ï¼Œä»è€Œå®ç°åŒæ—¶è®¿é—®è€Œäº’ä¸å¹²æ‰°

**ä¾§é‡ç‚¹ï¼š** å¤šçº¿ç¨‹ä¸­è®©æ¯ä¸ªçº¿ç¨‹ä¹‹é—´çš„æ•°æ®ç›¸äº’éš”ç¦»

### 3. å†…éƒ¨ç»“æ„

ä»ä¸Šé¢çš„æ¡ˆä¾‹ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ° **ThreadLocal** çš„ä¸¤ä¸ªä¸»è¦æ–¹æ³•åˆ†åˆ«æ˜¯ `set()` å’Œ `get()`

é‚£æˆ‘ä»¬ä¸å¦¨çŒœæƒ³ä¸€ä¸‹ï¼Œå¦‚æœè®©æˆ‘ä»¬æ¥è®¾è®¡ **ThreadLocal** ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•è®¾è®¡ï¼Œæ˜¯å¦ä¼šæœ‰è¿™æ ·çš„æƒ³æ³•ï¼šæ¯ä¸ª **ThreadLocal** éƒ½åˆ›å»ºä¸€ä¸ª **Map**ï¼Œç„¶åç”¨çº¿ç¨‹ä½œä¸º **Map** çš„ **key**ï¼Œè¦å­˜å‚¨çš„å±€éƒ¨å˜é‡ä½œä¸º **Map** çš„ **value** ï¼Œè¿™æ ·å°±èƒ½è¾¾åˆ°å„ä¸ªçº¿ç¨‹çš„å±€éƒ¨å˜é‡éš”ç¦»çš„æ•ˆæœã€‚

![](https://cbucbm.club/8972894e)

è¿™ä¸ªæƒ³æ³•ä¹Ÿæ˜¯æ²¡é”™çš„ï¼Œæ—©æœŸçš„ **ThreadLocal** ä¾¿æ˜¯è¿™æ ·è®¾è®¡çš„ï¼Œä½†æ˜¯åœ¨ **JDK 8** ä¹‹åä¾¿æ›´æ”¹äº†è®¾è®¡ï¼Œå¦‚ä¸‹ï¼š

![](https://cbucbm.club/b092134b)

è®¾è®¡è¿‡ç¨‹ï¼š

1. æ¯ä¸ª **Thread** çº¿ç¨‹å†…éƒ¨éƒ½æœ‰ä¸€ä¸ª **ThreadLocalMap**

2. **ThreadLocalMap** ä¸­å­˜å‚¨ç€ä»¥ **ThreadLocal** å¯¹è±¡ä¸º **key** ï¼Œçº¿ç¨‹å˜é‡ä¸º **value**
3. **Thread** å†…éƒ¨çš„ **Map** æ˜¯ç”± **ThreadLocal** ç»´æŠ¤çš„ï¼Œç”± **ThreadLocal** è´Ÿè´£å‘ **Map** è®¾ç½®å’Œè·å–çº¿ç¨‹çš„å˜é‡å€¼
4. å¯¹äºä¸åŒçš„çº¿ç¨‹ï¼Œæ¯æ¬¡è·å–å‰¯æœ¬å€¼æ—¶ï¼Œåˆ«çš„çº¿ç¨‹å¹¶ä¸èƒ½è·å–åˆ°çº¿ç¨‹çš„å‰¯æœ¬å€¼ï¼Œè¿™æ ·å°±ä¼šå½¢æˆå‰¯æœ¬çš„éš”ç¦»ï¼Œäº’ä¸å¹²æ‰°

**æ³¨ï¼š** æ¯ä¸ªçº¿ç¨‹éƒ½è¦æœ‰è‡ªå·±çš„ä¸€ä¸ª **map**ï¼Œä½†æ˜¯è¿™ä¸ªç±»å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„ **Java** ç±»ï¼Œå¹¶æ²¡æœ‰å®ç° **Map** æ¥å£ï¼Œä½†æ˜¯å…·æœ‰ç±»ä¼¼ **Map** ç±»ä¼¼çš„åŠŸèƒ½ã€‚

![](https://cbucbm.club/986800c1)

é€šè¿‡è¿™æ ·å®ç°çœ‹èµ·æ¥è²Œä¼¼ä¼šæ¯”ä¹‹å‰æˆ‘ä»¬çŒœæƒ³çš„æ›´åŠ å¤æ‚ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

- æ¯ä¸ª **Map** å­˜å‚¨çš„ **Entry** æ•°é‡å°±ä¼šå˜å°‘ï¼Œå› ä¸ºä¹‹å‰çš„å­˜å‚¨æ•°é‡ç”± **Thread** çš„æ•°é‡å†³å®šï¼Œç°åœ¨æ˜¯ç”± **ThreadMap** çš„æ•°é‡å†³å®šï¼Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œ**ThreadLocal** çš„æ•°é‡è¦æ›´å°‘äº **Thread** çš„æ•°é‡ã€‚
- å½“ **Thread** é”€æ¯ä¹‹åï¼Œå¯¹åº”çš„ **ThreadLocalMap** ä¹Ÿä¼šéšä¹‹é”€æ¯ï¼Œèƒ½å‡å°‘å†…å­˜çš„ä½¿ç”¨

### 4. æºç åˆ†æ

![](https://cbucbm.club/66e6d553)

é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹ **ThreadLocalMap** ä¸­æœ‰å“ªäº›æˆå‘˜ï¼š

![](https://cbucbm.club/6e465eef)

å¦‚æœä½ çœ‹è¿‡ **HashMap** çš„æºç ï¼Œè‚¯å®šä¼šè§‰å¾—è¿™å‡ ä¸ªç‰¹åˆ«ç†Ÿæ‚‰ï¼Œå…¶ä¸­ï¼š

- **INITIAL_CAPACITY**ï¼šåˆå§‹å®¹é‡ï¼Œå¿…é¡»æ˜¯ 2 çš„æ•´æ¬¡å¹‚
- **table**ï¼šå­˜æ”¾æ•°æ®çš„**table**
- **size**ï¼šæ•°ç»„ä¸­ **entries** çš„ä¸ªæ•°ï¼Œç”¨äºåˆ¤æ–­ **table** å½“å‰ä½¿ç”¨é‡æ˜¯å¦è¶…è¿‡é˜ˆå€¼
- **threshold**ï¼šè¿›è¡Œæ‰©å®¹çš„é˜ˆå€¼ï¼Œè¡¨ä½¿ç”¨é‡å¤§äºå®ƒçš„æ—¶å€™ä¼šè¿›è¡Œæ‰©å®¹

#### ThreadLocals

**Thread** ç±»ä¸­æœ‰ä¸ªç±»å‹ä¸º **ThreadLocal.ThreadLocalMap** ç±»å‹çš„å˜é‡ **ThreadLocals** ï¼Œè¿™ä¸ªå°±æ˜¯ç”¨æ¥ä¿å­˜æ¯ä¸ªçº¿ç¨‹çš„ç§æœ‰æ•°æ®ã€‚

![](https://cbucbm.club/986800c1)

#### ThreadLocalMap

**ThreadLocalMap**æ˜¯**ThreadLocal**çš„å†…éƒ¨ç±»ï¼Œæ¯ä¸ªæ•°æ®ç”¨**Entry**ä¿å­˜ï¼Œå…¶ä¸­çš„**Entry**ç”¨ä¸€ä¸ªé”®å€¼å¯¹å­˜å‚¨ï¼Œé”®ä¸º**ThreadLocal**çš„å¼•ç”¨ã€‚

![](https://cbucbm.club/f4daf835)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ° **Entry** ç»§æ‰¿äº**WeakReference**ï¼Œè¿™æ˜¯å› ä¸ºå¦‚æœæ˜¯å¼ºå¼•ç”¨ï¼Œå³ä½¿æŠŠ **ThreadLocal** è®¾ç½®ä¸º **null**ï¼Œ**GC** ä¹Ÿä¸ä¼šå›æ”¶ï¼Œå› ä¸º **ThreadLocalMap** å¯¹å®ƒæœ‰å¼ºå¼•ç”¨ã€‚

åœ¨æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤è¿™ä¸ª**Entry**ä»¥åŠ**CurrentThread**ä¾ç„¶è¿è¡Œçš„å‰æä¸‹ï¼Œå§‹ç»ˆæœ‰å¼ºå¼•ç”¨é“¾ **threadRef** `->` **currentThread** `->` **threadLocalMap** `->` **entry**ï¼Œ**Entry**å°±ä¸ä¼šè¢«å›æ”¶ï¼ˆ**Entry**ä¸­åŒ…æ‹¬äº†**ThreadLocal**å®ä¾‹å’Œ**value**ï¼‰ï¼Œå¯¼è‡´**Entry**å†…å­˜æ³„æ¼ã€‚

![](https://cbucbm.club/d2d0f5f2)

é‚£æ˜¯ä¸æ˜¯å°±æ˜¯è¯´å¦‚æœä½¿ç”¨äº†**å¼±å¼•ç”¨**ï¼Œå°±ä¸ä¼šé€ æˆ**å†…å­˜æ³„éœ²** å‘¢ï¼Œè¿™ä¹Ÿæ˜¯ä¸æ­£ç¡®çš„ã€‚

å› ä¸ºå¦‚æœæˆ‘ä»¬æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤ **Entry** çš„æƒ…å†µä¸‹ï¼Œæ­¤æ—¶ **Entry** ä¸­çš„ **key == null**ï¼Œè¿™ä¸ªæ—¶å€™æ²¡æœ‰ä»»ä½•å¼ºå¼•ç”¨æŒ‡å‘ **threaLocal** å®ä¾‹ï¼Œæ‰€ä»¥ **threadLocal** å°±å¯ä»¥é¡ºåˆ©è¢« **gc** å›æ”¶ï¼Œä½†æ˜¯ **value** ä¸ä¼šè¢«å›æ”¶ï¼Œè€Œè¿™å—çš„ **value** æ°¸è¿œä¸ä¼šè¢«è®¿é—®åˆ°ï¼Œå› æ­¤ä¼šå¯¼è‡´**å†…å­˜æ³„éœ²**

![](https://cbucbm.club/c9a34cde)

æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹ **ThreadLocalMap** çš„å‡ ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼š

#### set æ–¹æ³•

é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹ä¸‹æºç ï¼š

```java
public void set(T value) {
    // è·å–å½“å‰çº¿ç¨‹å¯¹è±¡
    Thread t = Thread.currentThread();
    // è·å–æ­¤çº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤çš„ThreadLocalMapå¯¹è±¡
    ThreadLocalMap map = getMap(t);
    // åˆ¤æ–­mapæ˜¯å¦å­˜åœ¨
    if (map != null)
        // å­˜åœ¨åˆ™è°ƒç”¨map.setè®¾ç½®æ­¤å®ä½“entry
        map.set(this, value);
    else
        // å¦‚æœå½“å‰çº¿ç¨‹ä¸å­˜åœ¨ThreadLocalMapå¯¹è±¡åˆ™è°ƒç”¨createMapè¿›è¡ŒThreadLocalMapå¯¹è±¡çš„åˆå§‹åŒ–
        // å¹¶å°† t(å½“å‰çº¿ç¨‹)å’Œvalue(tå¯¹åº”çš„å€¼)ä½œä¸ºç¬¬ä¸€ä¸ªentryå­˜æ”¾è‡³ThreadLocalMapä¸­
        createMap(t, value);
}

ThreadLocalMap getMap(Thread t) {
    return t.threadLocals;
}

void createMap(Thread t, T firstValue) {
    //è¿™é‡Œçš„thisæ˜¯è°ƒç”¨æ­¤æ–¹æ³•çš„threadLocal
    t.threadLocals = new ThreadLocalMap(this, firstValue);
}
```

æ‰§è¡Œæµç¨‹ï¼š

- é¦–å…ˆè·å–å½“å‰çº¿ç¨‹ï¼Œå¹¶æ ¹æ®å½“å‰çº¿ç¨‹è·å–ä¸€ä¸ª **map**
- å¦‚æœè·å–çš„ **map** ä¸ä¸ºç©ºï¼Œåˆ™å°†å‚æ•°è®¾ç½®åˆ° **map** ä¸­ï¼ˆå½“å‰ **ThreadLocal** çš„å¼•ç”¨ä½œä¸º **key** ï¼‰

- å¦‚æœ **Map** ä¸ºç©ºï¼Œåˆ™ç»™è¯¥çº¿ç¨‹åˆ›å»º **map** ï¼Œå¹¶è®¾ç½®åˆå§‹å€¼

#### get æ–¹æ³•

æºç å¦‚ä¸‹ï¼š

```java
public T get() {
    // è·å–å½“å‰çº¿ç¨‹å¯¹è±¡
    Thread t = Thread.currentThread();
    // è·å–æ­¤çº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤çš„ThreadLocalMapå¯¹è±¡
    ThreadLocalMap map = getMap(t);
    // å¦‚æœæ­¤mapå­˜åœ¨
    if (map != null) {
        // ä»¥å½“å‰çš„ThreadLocal ä¸º keyï¼Œè°ƒç”¨getEntryè·å–å¯¹åº”çš„å­˜å‚¨å®ä½“e
        ThreadLocalMap.Entry e = map.getEntry(this);
        // å¯¹eè¿›è¡Œåˆ¤ç©º 
        if (e != null) {
            @SuppressWarnings("unchecked")
            // è·å–å­˜å‚¨å®ä½“ e å¯¹åº”çš„ valueå€¼
            // å³ä¸ºæˆ‘ä»¬æƒ³è¦çš„å½“å‰çº¿ç¨‹å¯¹åº”æ­¤ThreadLocalçš„å€¼
            T result = (T)e.value;
            return result;
        }
    }
    return setInitialValue();
}

private T setInitialValue() {
    // è°ƒç”¨initialValueè·å–åˆå§‹åŒ–çš„å€¼
    // æ­¤æ–¹æ³•å¯ä»¥è¢«å­ç±»é‡å†™, å¦‚æœä¸é‡å†™é»˜è®¤è¿”å›null
    T value = initialValue();
    // è·å–å½“å‰çº¿ç¨‹å¯¹è±¡
    Thread t = Thread.currentThread();
    // è·å–æ­¤çº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤çš„ThreadLocalMapå¯¹è±¡
    ThreadLocalMap map = getMap(t);
    // åˆ¤æ–­mapæ˜¯å¦å­˜åœ¨
    if (map != null)
        // å­˜åœ¨åˆ™è°ƒç”¨map.setè®¾ç½®æ­¤å®ä½“entry
        map.set(this, value);
    else
        // å¦‚æœå½“å‰çº¿ç¨‹ä¸å­˜åœ¨ThreadLocalMapå¯¹è±¡åˆ™è°ƒç”¨createMapè¿›è¡ŒThreadLocalMapå¯¹è±¡çš„åˆå§‹åŒ–
        // å¹¶å°† t(å½“å‰çº¿ç¨‹)å’Œvalue(tå¯¹åº”çš„å€¼)ä½œä¸ºç¬¬ä¸€ä¸ªentryå­˜æ”¾è‡³ThreadLocalMapä¸­
        createMap(t, value);
    // è¿”å›è®¾ç½®çš„å€¼value
    return value;
}
```

æ‰§è¡Œæµç¨‹ï¼š

- é¦–å…ˆè·å–å½“å‰çº¿ç¨‹ï¼Œæ ¹æ®å½“å‰çº¿ç¨‹è·å–ä¸€ä¸ª **map**
- å¦‚æœè·å–çš„ **map** ä¸ä¸ºç©ºï¼Œåˆ™åœ¨ **map** ä¸­ä»¥ **ThreadLocal** çš„å¼•ç”¨ä½œä¸º **key** æ¥åœ¨ **map** ä¸­è·å–å¯¹åº”çš„ **Entry entry**  ï¼Œå¦åˆ™è·³è½¬åˆ°**ç¬¬å››æ­¥**
- å¦‚æœ **Entry entry** ä¸ä¸ºç©º ï¼Œåˆ™è¿”å› **entry.value** ï¼Œå¦åˆ™è·³è½¬åˆ°**ç¬¬å››æ­¥**
- **map** ä¸ºç©ºæˆ–è€… **entry** ä¸ºç©ºï¼Œåˆ™é€šè¿‡ **initialValue** å‡½æ•°è·å–åˆå§‹å€¼ **value** ï¼Œç„¶åç”¨ **ThreadLocal** çš„å¼•ç”¨å’Œ **value** ä½œä¸º **firstKey** å’Œ **firstValue** åˆ›å»ºä¸€ä¸ªæ–°çš„ **map**

#### remove æ–¹æ³•

æºç å¦‚ä¸‹ï¼š

```java

public void remove() {
    // è·å–å½“å‰çº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤çš„ThreadLocalMapå¯¹è±¡
    ThreadLocalMap m = getMap(Thread.currentThread());
    // å¦‚æœæ­¤mapå­˜åœ¨
    if (m != null)
        // å­˜åœ¨åˆ™è°ƒç”¨map.remove
        m.remove(this);
}
// ä»¥å½“å‰ThreadLocalä¸ºkeyåˆ é™¤å¯¹åº”çš„å®ä½“entry
private void remove(ThreadLocal<?> key) {
    Entry[] tab = table;
    int len = tab.length;
    int i = key.threadLocalHashCode & (len-1);
    for (Entry e = tab[i];
         e != null;
         e = tab[i = nextIndex(i, len)]) {
        if (e.get() == key) {
            e.clear();
            expungeStaleEntry(i);
            return;
        }
    }
}
```

æ‰§è¡Œæµç¨‹ï¼š

- é¦–å…ˆè·å–å½“å‰çº¿ç¨‹ï¼Œå¹¶æ ¹æ®å½“å‰çº¿ç¨‹è·å–ä¸€ä¸ª **map**
- å¦‚æœè·å¾—çš„**map** ä¸ä¸ºç©ºï¼Œåˆ™ç§»é™¤å½“å‰ **ThreadLocal** å¯¹è±¡å¯¹åº”çš„ **entry**

#### initialValue æ–¹æ³•

æºç å¦‚ä¸‹ï¼š

```java
protected T initialValue() {
    return null;
}
```

åœ¨æºç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•ä»…ä»…ç®€å•çš„è¿”å›äº† **null** ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯åœ¨çº¿ç¨‹ç¬¬ä¸€æ¬¡é€šè¿‡ **get ()** æ–¹æ³•è®¿é—®è¯¥çº¿ç¨‹çš„ **ThreadLocal** æ—¶è°ƒç”¨çš„ï¼Œåªæœ‰åœ¨çº¿ç¨‹å…ˆè°ƒç”¨äº† **set ()** æ–¹æ³•æ‰ä¸ä¼šè°ƒç”¨ **initialValue ()** æ–¹æ³•ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œè¿™ä¸ªæ–¹æ³•æœ€å¤šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚

å¦‚æœä»¬æƒ³è¦ **ThreadLocal** çº¿ç¨‹å±€éƒ¨å˜é‡æœ‰ä¸€ä¸ªé™¤ **null** ä»¥å¤–çš„åˆå§‹å€¼ï¼Œé‚£ä¹ˆå°±å¿…é¡»é€šè¿‡å­ç±»**ç»§æ‰¿** **ThreadLocal** æ¥é‡å†™æ­¤æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡åŒ¿åå†…éƒ¨ç±»å®ç°ã€‚



**ã€ENDã€‘**

è¿™ç¯‡ **ThreadLocal** å°±ä»‹ç»åˆ°è¿™é‡Œå•¦ï¼Œå¸Œæœ›è¯»åˆ°è¿™é‡Œçš„å°ä¼™ä¼´èƒ½å¤Ÿæœ‰æ‰€æ”¶è·ã€‚

è·¯æ¼«æ¼«ï¼Œå°èœä¸ä½ ä¸€åŒæ±‚ç´¢ï¼

![çœ‹å®Œä¸èµï¼Œéƒ½æ˜¯åè›‹](https://imgconvert.csdnimg.cn/aHR0cHM6Ly93d3cuNTJkb3V0dS5jbi9zdGF0aWMvdGVtcC9waWMvOWJkNjhkMTUwZjA3ODdjNTYwYTQzOWRhMzU5YTU4MGEucG5n?x-oss-process=image/format,png#pic_center)
> ä»Šå¤©çš„ä½ å¤šåŠªåŠ›ä¸€ç‚¹ï¼Œæ˜å¤©çš„ä½ å°±èƒ½å°‘è¯´ä¸€å¥æ±‚äººçš„è¯ï¼
>
> *æˆ‘æ˜¯å°èœï¼Œä¸€ä¸ªå’Œä½ ä¸€èµ·å­¦ä¹ çš„ç”·äººã€‚* `ğŸ’‹`
>
>
> å¾®ä¿¡å…¬ä¼—å·å·²å¼€å¯ï¼Œ**å°èœè‰¯è®°**ï¼Œæ²¡å…³æ³¨çš„åŒå­¦ä»¬è®°å¾—å…³æ³¨å“¦ï¼