å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å°èœï¼Œä¸€ä¸ªæ¸´æœ›åœ¨äº’è”ç½‘è¡Œä¸šåšåˆ°è”¡ä¸èœçš„å°èœã€‚å¯æŸ”å¯åˆšï¼Œç‚¹èµåˆ™æŸ”ï¼Œç™½å«–åˆ™åˆšï¼
**æ­»é¬¼~çœ‹å®Œè®°å¾—ç»™æˆ‘æ¥ä¸ªä¸‰è¿å“¦ï¼**

![](https://user-gold-cdn.xitu.io/2020/4/11/17169c46045528af?w=240&h=224&f=jpeg&s=7529)

> æœ¬æ–‡ä¸»è¦ä»‹ç» `Javaä¸­çš„ JUC å’Œé«˜å¹¶å‘`
> å¦‚æœ‰éœ€è¦ï¼Œå¯ä»¥å‚è€ƒ
> å¦‚æœ‰å¸®åŠ©ï¼Œä¸å¿˜ **ç‚¹èµ** â¥

### ä¸€ã€Volatile

*volatile æ˜¯Javaè™šæ‹Ÿæœºæä¾›çš„è½»é‡çº§çš„åŒæ­¥æœºåˆ¶*

#### 1ï¼‰ä¿è¯å¯è§æ€§

`JMMæ¨¡å‹çš„çº¿ç¨‹å·¥ä½œï¼š`
å„ä¸ªçº¿ç¨‹å¯¹ä¸»å†…å­˜ä¸­å…±äº«å˜é‡Xçš„æ“ä½œéƒ½æ˜¯å„ä¸ªçº¿ç¨‹å„è‡ªæ‹·è´åˆ°è‡ªå·±çš„å·¥ä½œå†…å­˜æ“ä½œåå†åä¼šä¸»å†…å­˜ä¸­ã€‚

`å­˜åœ¨çš„é—®é¢˜ï¼š`
å¦‚æœä¸€ä¸ªçº¿ç¨‹A ä¿®æ”¹äº†å…±äº«å˜é‡Xçš„å€¼è¿˜æœªå†™å›ä¸»å†…å­˜ï¼Œè¿™æ˜¯å¦å¤–ä¸€ä¸ªçº¿ç¨‹Båˆå¯¹å†…å­˜ä¸­çš„ä¸€ä¸ªå…±äº«å˜é‡Xè¿›è¡Œæ“ä½œï¼Œä½†æ˜¯æ­¤æ—¶çº¿ç¨‹Aå·¥ä½œå†…å­˜ä¸­çš„å…±äº«å˜é‡å¯¹çº¿ç¨‹Bæ¥è¯´äº‹å¹¶ä¸å¯è§çš„ã€‚è¿™ç§å·¥ä½œå†…å­˜ä¸ä¸»å†…å­˜å»¶è¿Ÿçš„ç°è±¡å°±ä¼šé€ æˆäº†å¯è§æ€§çš„é—®é¢˜ã€‚

`è§£å†³ï¼ˆvolatileï¼‰ï¼š`
å½“å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå˜é‡æ—¶ï¼Œä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³çœ‹åˆ°ä¿®æ”¹çš„å€¼

![](https://ae01.alicdn.com/kf/H6160adf020be43eaa148a256b9931c98j.jpg)

#### 2ï¼‰ä¸ä¿è¯åŸå­æ€§

`åŸå­æ€§ï¼š` 
ä¸å¯åˆ†å‰²ã€å®Œæ•´æ€§ï¼Œå³æŸä¸ªçº¿ç¨‹æ­£åœ¨åšæŸä¸ªå…·ä½“ä¸šåŠ¡æ—¶ï¼Œä¸­é—´ä¸å¯ä»¥è¢«åŠ å¡æˆ–è€…è¢«åˆ†å‰²ï¼Œéœ€è¦æ•´ä½“å®Œæ•´ï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥

`è§£å†³æ–¹æ³•ï¼š` 

- **åŠ å…¥synchronized**

- **ä½¿ç”¨JUCä¸‹çš„AtomicInteger**

![](https://ae01.alicdn.com/kf/H4aff1b2c93814ba5abe139293a37b4adz.jpg)

#### 3ï¼‰ç¦æ­¢æŒ‡ä»¤é‡æ’

`æŒ‡ä»¤é‡æ’ï¼š` 
å¤šçº¿ç¨‹ç¯å¢ƒä¸­çº¿ç¨‹äº¤æ›¿æ‰§è¡Œï¼Œç”±äºç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’çš„å­˜åœ¨ï¼Œä¸¤ä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨çš„å˜é‡èƒ½å¦ä¿è¯ä¸€è‡´æ€§æ˜¯æ— æ³•ç¡®å®šçš„ï¼Œç»“æœæ— æ³•é¢„æµ‹ã€‚

`æŒ‡ä»¤é‡æ’è¿‡ç¨‹ï¼š`
æºä»£ç  -> ç¼–è¾‘å™¨ä¼˜åŒ–çš„é‡æ’ -> æŒ‡ä»¤å¹¶è¡Œçš„é‡æ’ -> å†…å­˜ç³»ç»Ÿçš„é‡æ’ ->æœ€ç»ˆæ‰§è¡Œçš„æŒ‡ä»¤

`å†…å­˜å±éšœä½œç”¨:` 

- ä¿è¯ç‰¹å®šæ“ä½œçš„æ‰§è¡Œé¡ºåº
- ä¿è¯æŸäº›å˜é‡çš„å†…å­˜å¯è§æ€§ï¼ˆåˆ©ç”¨è¯¥ç‰¹æ€§å®ç°volatileçš„å†…å­˜å¯è§æ€§ï¼‰

### äºŒã€CAS
#### 1ï¼‰ä»€ä¹ˆæ˜¯CAS

- CAS å…¨ç§°ï¼š Compare-And-Set , **å®ƒæ˜¯ä¸€æ¡CPUå¹¶å‘æºè¯­**

- å®ƒçš„åŠŸèƒ½å°±æ˜¯*åˆ¤æ–­å†…å­˜æŸä¸ªä½ç½®çš„å€¼æ˜¯å¦ä¸ºé¢„æœŸå€¼ï¼Œå¦‚æœæ˜¯åˆ™æ›´æ–°ä¸ºæ–°çš„å€¼*ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯**åŸå­**çš„ã€‚

- CASå¹¶å‘æºè¯­ä½“ç°åœ¨Javaè¯­è¨€ä¸­å°±æ˜¯*sun.miscUnSafe*ç±»ä¸­çš„å„ä¸ªæ–¹æ³•ï¼Œè°ƒç”¨UnSafeç±»ä¸­çš„CASæ–¹æ³•ï¼ŒJVMä¼šå¸®æˆ‘å®ç°CASæ±‡ç¼–æŒ‡ä»¤ï¼Œè¿™æ˜¯ä¸€ç§å®Œå…¨ä¾èµ–äº`ç¡¬ä»¶`åŠŸèƒ½ï¼Œé€šè¿‡å®ƒå®ç°äº†åŸå­æ“ä½œï¼Œå†æ¬¡å¼ºè°ƒï¼Œç”±äºCASæ˜¯ä¸€ç§ç³»ç»Ÿæºè¯­ï¼Œæºè¯­å±äºæ“ä½œç³»ç»Ÿç”¨äºèŒƒç•´ï¼Œæ˜¯ç”±è‹¥å¹²ä¸ªæŒ‡ä»¤ç»„æˆï¼Œç”¨äºå®ŒæˆæŸä¸ªåŠŸèƒ½çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œå¹¶ä¸”æºè¯­çš„æ‰§è¡Œå¿…é¡»æ˜¯è¿ç»­çš„ï¼Œåœ¨**æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å…è®¸ä¸­æ–­ï¼Œä¹Ÿå³æ˜¯è¯´CASæ˜¯ä¸€æ¡åŸå­æŒ‡ä»¤ï¼Œä¸ä¼šé€ æˆæ‰€è°“çš„æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜**

```java
public class CASDemo{
	public static void main(String[] args) {
        AtomicInteger atomicInteger = new AtomicInteger();
        System.out.println(atomicInteger.compareAndSet(0,5));       //true
        System.out.println(atomicInteger.compareAndSet(0,2));       //false
        System.out.println(atomicInteger);                          //5
    }
}
```
#### 2ï¼‰CASåŸç†

```java
	public final int getAndIncrement() {
        return unsafe.getAndAddInt(this, valueOffset, 1); //å¼•å‡ºé—®é¢˜ --> ä½•ä¸ºunsafe
    }
```
#### 3ï¼‰ä½•ä¸ºUnSafe

- UnSafeæ˜¯*CASçš„æ ¸å¿ƒç±»*ï¼Œç”±äºJavaæ–¹æ³•æ— æ³•ç›´æ¥è®¿é—®åº•å±‚ï¼Œéœ€è¦é€šè¿‡æœ¬åœ°ï¼ˆnativeï¼‰æ–¹æ³•æ¥è®¿é—®ï¼ŒUnSafeç›¸å½“äºä¸€ä¸ªåé¢ï¼ŒåŸºäºè¯¥ç±»å¯ä»¥ç›´æ¥æ“ä½œé¢å®šçš„å†…å­˜æ•°æ®ã€‚UnSafeç±»åœ¨äº*sun.misc*åŒ…ä¸­ã€‚å…¶ä¸­å†…éƒ¨æ–¹æ³•å¯ä»¥å‘Cçš„æŒ‡é’ˆä¸€æ ·ç›´æ¥æ“ä½œå†…å­˜ï¼Œå› ä¸ºJavaä¸­CASæ“ä½œçš„ä¸»è¦ä¾èµ–äºUnSafeç±»çš„æ–¹æ³•

- å˜é‡ **ValueOffset** ï¼Œ æ˜¯è¯¥å˜é‡åœ¨å†…å­˜ä¸­åç§»åœ°å€ï¼Œå› ä¸º*UnSafeå°±æ˜¯æ ¹æ®å†…å­˜åç§»åœ°å€æ¥è·å–æ•°æ®çš„*ã€‚

- å˜é‡ value ç”± **volatile** ä¿®é¥°ï¼Œä¿è¯äº†å¤šçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§ã€‚

#### 4ï¼‰CASç¼ºç‚¹

1. **å¾ªç¯æ—¶é—´å¼€é”€å¾ˆå¤§**

![](https://ae01.alicdn.com/kf/H8d082a94d76f492d920ff6e099a3485d4.jpg)

2. **åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ€§**
å½“å¯¹ä¸€ä¸ªå…±äº«å˜é‡æ‰§è¡Œæ“ä½œçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¾ªç¯CASçš„æ–¹å¼æ¥ä¿è¯åŸå­æ“ä½œï¼Œä½†æ˜¯å¯¹å¤šä¸ªå…±äº«å˜é‡æ“ä½œæ—¶ï¼Œå¾ªç¯CASå°±æ— æ³•ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç”¨é”æ¥ä¿è¯åŸå­æ€§ã€‚
3. **å­˜åœ¨ABAé—®é¢˜**
#### 5ï¼‰ABAé—®é¢˜

*ä½•ä¸ºABAé—®é¢˜*ï¼š
åœ¨ä¸€ä¸ªæ—¶é—´å·®çš„æ—¶æ®µå†…ä¼šé€ æˆæ•°æ®çš„å˜åŒ–ã€‚æ¯”å¦‚è¯´ä¸€ä¸ªçº¿ç¨‹AAä»å†…å­˜ä¸­å–èµ°Aï¼Œè¿™ä¸ªæ—¶å€™å¦ä¸€ä¸ªçº¿ç¨‹BBä¹Ÿä»å†…å­˜ä¸­å–èµ°Aï¼Œè¿™ä¸ªæ—¶å€™Açš„å€¼ä¸ºXï¼Œç„¶åçº¿ç¨‹BBå°†Açš„å€¼æ”¹ä¸ºYï¼Œè¿‡ä¸€ä¼šåˆå°†Açš„å€¼æ”¹ä¸ºXï¼Œè¿™ä¸ªæ—¶å€™çº¿ç¨‹AAå›æ¥è¿›è¡ŒCASæ“ä½œå‘ç°å†…å­˜ä¸­Açš„å€¼ä»ç„¶æ˜¯Xï¼Œå› æ­¤çº¿ç¨‹AAæ“ä½œæˆåŠŸã€‚**ä½†æ˜¯å°½ç®¡çº¿ç¨‹AAçš„CASæ“ä½œæˆåŠŸï¼Œä½†æ˜¯ä¸ä»£è¡¨è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯æ²¡é—®é¢˜çš„**

*åŸå­å¼•ç”¨*ï¼š

![](https://ae01.alicdn.com/kf/H7f9969d4269140dd823a8511e3be618bF.jpg)

*è§£å†³*ï¼šï¼ˆ**æ—¶é—´æˆ³åŸå­å¼•ç”¨ï¼š`AtomicStampedReference`**ï¼‰

![](https://ae01.alicdn.com/kf/H700c879ddcb0491dbd60e206a3dd9b672.jpg)

### ä¸‰ã€é›†åˆç±»ä¸å®‰å…¨é—®é¢˜

#### 1ï¼‰æ•…éšœç°è±¡

å‡ºç°`java.util.ConcurrentModificationException`å¼‚å¸¸
![](https://user-gold-cdn.xitu.io/2020/4/5/1714a475d714129e?w=834&h=183&f=png&s=9658)

#### 2) å¯¼è‡´åŸå› 

**å¹¶å‘äº‰æŠ¢ä¿®æ”¹å¯¼è‡´**

```java
public static void main(String[] args) {
    List<String> stringList = new ArrayList<>();
    for (int i = 0; i < 30; i++) {
        new Thread(()->{
            stringList.add(UUID.randomUUID().toString().substring(0,8));
            System.out.println(stringList);
        },"çº¿ç¨‹"+i).start();
    }
}
```
#### 3ï¼‰è§£å†³æ–¹æ³•

- **Vector** ï¼šçº¿ç¨‹å®‰å…¨
- **Collections.synchronizedList(new ArrayList<>())**
-  **new CopyOnWriteArrayList<>()**
   + Listçº¿ç¨‹ï¼š`new CopyOnWriteArrayList<>();`
   + Setçº¿ç¨‹ï¼š`new CopyOnWriteArraySet<>();`
   + Setçº¿ç¨‹ï¼š`ConcurrentHashMap();`
### å››ã€é”

#### 1ï¼‰å…¬å¹³é”/éå…¬å¹³é”

*å®šä¹‰*ï¼š

**å…¬å¹³é”ï¼š** æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºæ¥è·å–é”ï¼Œç±»ä¼¼äºæ’é˜Ÿï¼ŒFIFOè§„åˆ™
**éå…¬å¹³é”ï¼š** æ˜¯æŒ‡åœ¨å¤šçº¿ç¨‹è·å–é”çš„é¡ºåºå¹¶ä¸æ˜¯æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºï¼Œæœ‰å¯èƒ½åç”³è¯·çš„çº¿ç¨‹æ¯”å…ˆç”³è¯·çš„çº¿ç¨‹ä¼˜å…ˆè·åˆ°é”ï¼Œåœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œæœ‰å¯èƒ½é€ æˆä¼˜å…ˆçº§åè½¬æˆ–è€…é¥¥é¥¿ç°è±¡ã€‚

*ä¸¤è€…çš„åŒºåˆ«*ï¼š

>å¹¶å‘åŒ…ReentrantLockçš„åˆ›å»ºå¯ä»¥æŒ‡å®šå‡½æ•°çš„booleanç±»å‹æ¥å¾—åˆ°å…¬å¹³é”æˆ–è€…éå…¬å¹³é”ï¼Œé»˜è®¤æ˜¯éå…¬å¹³é”

**å…¬å¹³é”ï¼š** å°±æ˜¯å¾ˆå…¬å¹³ï¼Œåœ¨å¹¶å‘ç¯å¢ƒä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹åœ¨è·å–é”æ—¶ä¼šå…ˆæŸ¥çœ‹æ­¤é”ç»´æŠ¤çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œå¦‚æœä¸ºç©ºï¼Œæˆ–è€…å½“å‰çº¿ç¨‹æ˜¯ç­‰å¾…é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªï¼Œå°±å æœ‰é”ï¼Œå¦åˆ™å°±ä¼šåŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œä»¥åä¼šæŒ‰ç…§FIFOçš„è§„åˆ™ä»é˜Ÿåˆ—ä¸­æŠ½å–åˆ°è‡ªå·±ã€‚
**éå…¬å¹³é”ï¼š** éå…¬å¹³é”æ¯”è¾ƒç²—é²ï¼Œä¸Šæ¥å°±ç›´æ¥å°è¯•å æœ‰é”ï¼Œå¦‚æœå°è¯•å¤±è´¥ï¼Œå°±å†é‡‡ç”¨ç±»ä¼¼å…¬å¹³é”çš„é‚£ç§æ–¹å¼ã€‚

*å°± Java ReentrantLock è€Œè¨€ï¼Œé€šè¿‡æ„é€ å‡½æ•°æŒ‡å®šè¯¥é”æ˜¯å¦æ˜¯å…¬å¹³é”ï¼Œ é»˜è®¤ **éå…¬å¹³é”** ï¼Œéå…¬å¹³é”çš„ä¼˜ç‚¹åœ¨äºååé‡æ¯”å…¬å¹³é”å¤§ï¼Œå°± synchronized è€Œè¨€ï¼Œå®ƒæ˜¯ä¸€ç§éå…¬å¹³é”ã€‚*

#### 2ï¼‰å¯é‡å…¥é”ï¼ˆé€’å½’é”ï¼‰
å¯é‡å…¥é”ä¹Ÿç§°ä¹‹ä¸º`é€’å½’é”`ï¼ŒæŒ‡å®šæ˜¯åŒä¸€ä¸ªçº¿ç¨‹å¤–å±‚å‡½æ•°è·å¾—é”ä¹‹åï¼Œå†…å±‚é€’å½’å‡½æ•°ä»ç„¶èƒ½è·å–è¯¥é”çš„ä»£ç ï¼Œåœ¨åŒä¸€ä¸ªçº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–é”çš„æ—¶å€™ï¼Œåœ¨è¿›å…¥å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ **çº¿ç¨‹å¯ä»¥è¿›å…¥ä»»ä½•ä¸€ä¸ªå®ƒå·²ç»æ‹¥æœ‰çš„é”æ‰€åŒæ­¥ç€çš„ä»£ç å—**

`ReentrantLock å’Œ syschronized` å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„å¯é‡å…¥é”

*ReentrantLock ä¸¾ä¾‹*ï¼š![](https://ae01.alicdn.com/kf/H3d03dd6933194272b102b632fe309c49Q.jpg)

*syschronized ä¸¾ä¾‹*ï¼š![](https://ae01.alicdn.com/kf/He82fcabd6a9846b9bf10b1ab40a08887V.jpg)

#### 3ï¼‰è‡ªæ—‹é”
æ˜¯æŒ‡å°è¯•è·å–é”çš„çº¿ç¨‹ä¸ä¼šç«‹å³é˜»å¡ï¼Œè€Œæ˜¯é‡‡ç”¨**å¾ªç¯**çš„æ–¹å¼å»å°è¯•è·å–é”ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯å‡å°‘çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¶ˆè€—ï¼Œç¼ºç‚¹æ˜¯å¾ªç¯ä¼šæ¶ˆè€—CPUã€‚

*ä¸Šé¢çš„CASé—®é¢˜ä¸­çš„unsafe ç”¨åˆ°çš„å°±æ˜¯è‡ªæ—‹é”ã€‚*

```java
public final int getAndAddInt(Object var1, long var2, int var4) {
    int var5;
    do {
        var5 = this.getIntVolatile(var1, var2);
    } while(!this.compareAndSwapInt(var1, var2, var5, var5 + var4));
    return var5;
}
```
*ä¾‹å­*ï¼š![](https://ae01.alicdn.com/kf/H4ea5ea30e44d40ad9adad21ad1b5f7127.jpg)

#### 4ï¼‰ç‹¬å é”(å†™)/å…±äº«é”(è¯»)/äº’æ–¥é”
- **ç‹¬å é”ï¼š**  æŒ‡è¯¥é”ä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æ‰€æŒæœ‰ã€‚å¯¹ReentrantLockå’ŒSynchronizeè€Œè¨€éƒ½æ˜¯ç‹¬å é”ã€‚
- **å…±äº«é”ï¼š** æŒ‡è¯¥é”å¯è¢«å¤šä¸ªçº¿ç¨‹æ‰€æŒæœ‰ã€‚

*å¯¹ReentrantReadWriteLockè€Œè¨€ï¼Œå…¶è¯»é”æ˜¯å…±äº«é”ï¼Œå…¶å†™é”æ˜¯ç‹¬å é”ã€‚è¯»é”çš„å…±äº«é”å¯ä»¥ä¿è¯å¹¶å‘åº¦æ˜¯éå¸¸é«˜æ•ˆçš„ã€‚è¯»å†™ï¼Œå†™è¯»ï¼Œå†™å†™çš„è¿‡ç¨‹æ˜¯äº’æ–¥çš„ã€‚*

*ä¾‹å­*ï¼š

![](https://ae01.alicdn.com/kf/H225e1fe74b564b5eada660bba006ab5ef.jpg)

#### 5ï¼‰CountDownLatch
- è®©ä¸€äº›çº¿ç¨‹é˜»å¡ç›´åˆ°å¦å¤–ä¸€äº›çº¿ç¨‹å®Œæˆåæ‰åˆ«å”¤é†’

- CountDownLatchä¸»è¦æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œå½“ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹è°ƒç”¨**await** æ–¹æ³•æ—¶ï¼Œè°ƒç”¨çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œå…¶ä»–çº¿ç¨‹è°ƒç”¨**countDown** æ–¹æ³•è®¡æ•°å™¨å‡1ï¼ˆè°ƒç”¨**countDown** æ–¹æ³•æ—¶çº¿ç¨‹ä¸ä¼šé˜»å¡ï¼‰ï¼Œå½“è®¡æ•°å™¨çš„å€¼å˜ä¸º0ï¼Œå› è°ƒç”¨**await** æ–¹æ³•è¢«é˜»å¡çš„çº¿ç¨‹ä¼šè¢«å”¤é†’ï¼Œè¿›è€Œç»§ç»­æ‰§è¡Œã€‚

  *å…³é”®æ–¹æ³•*ï¼š
  1ï¼‰**await()**  æ–¹æ³• 
  2ï¼‰ **countDown()**  æ–¹æ³•

  *ä¾‹å­*ï¼š

  ä¸€ä¸ªæ•™å®¤æœ‰1ä¸ªç­é•¿å’Œè‹¥å¹²ä¸ªå­¦ç”Ÿï¼Œç­é•¿è¦ç­‰æ‰€æœ‰å­¦ç”Ÿéƒ½èµ°äº†æ‰èƒ½å…³é—¨ï¼Œé‚£ä¹ˆè¦å¦‚ä½•å®ç°ã€‚

![](https://ae01.alicdn.com/kf/H68dee3e70d67446eb902c2811f149c27N.jpg)

#### 6ï¼‰CyclicBarrier
- CyclicBarrier çš„å­—é¢æ„æ€æ˜¯å¯å¾ªç¯(Cyclic)ä½¿ç”¨çš„å±éšœ(Barrier)ã€‚å®ƒè¦åšçš„äº‹æƒ…æ˜¯ï¼Œè®©ä¸€ç»„çº¿ç¨‹åˆ°è¾¾ä¸€ä¸ªå±éšœï¼ˆä¹Ÿå¯ä»¥å«åšåŒæ­¥ç‚¹ï¼‰æ—¶è¢«é˜»å¡ï¼ŒçŸ¥é“æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œå±éšœæ‰ä¼šå¼€é—¨ï¼Œæ‰€æœ‰è¢«å±éšœæ‹¦æˆªçš„çº¿ç¨‹æ‰ä¼šç»§ç»­å¹²æ´»ï¼Œçº¿ç¨‹è¿›å…¥å±éšœé€šè¿‡CyclicBarrierçš„await()æ–¹æ³•ã€‚

  *ä¾‹å­*ï¼š

  è·Ÿä¸Šé¢ä¸€æ ·ï¼Œä¸€ä¸ªç­çº§æœ‰å…­ä¸ªå­¦ç”Ÿï¼Œè¦ç­‰å­¦ç”Ÿéƒ½ç¦»å¼€åç­é•¿æ‰èƒ½å…³é—¨ã€‚

![](https://ae01.alicdn.com/kf/Hcae5d9a562ee432cb1378887df98f6ccE.jpg)

*CountDownLatch å’Œ CyclicBarrier å…¶å®æ˜¯ç›¸åçš„æ“ä½œï¼Œä¸€ä¸ªæ˜¯ç›¸å‡åˆ°0å¼€å§‹æ‰§è¡Œï¼Œä¸€ä¸ªæ˜¯ç›¸åŠ åˆ°æŒ‡å®šå€¼å¼€å§‹æ‰§è¡Œ*

#### 7ï¼‰Semaphore
- ä¿¡å·é‡çš„ä¸»è¦ç”¨æˆ·ä¸¤ä¸ªç›®çš„ï¼Œä¸€ä¸ªæ˜¯ç”¨äº**å…±äº«èµ„æºçš„ç›¸äº’æ’æ–¥ä½¿ç”¨** ï¼Œå¦ä¸€ä¸ªæ˜¯ç”¨äº**å¹¶å‘èµ„æºæ•°çš„æ§åˆ¶**ã€‚
- ä¾‹å­ï¼šæŠ¢è½¦ä½é—®é¢˜ï¼Œæ­¤æ—¶æœ‰å…­éƒ¨è½¦è¾†ï¼Œä½†æ˜¯åªæœ‰ä¸‰ä¸ªè½¦ä½çš„é—®é¢˜ã€‚

![](https://ae01.alicdn.com/kf/H83961d6421ba476695882e17a827deafg.jpg)

### äº”ã€é˜»å¡é˜Ÿåˆ—

`æ¦‚å¿µ:` é˜»å¡é˜Ÿåˆ—ï¼Œæ‹†åˆ†ä¸ºâ€œé˜»å¡â€å’Œâ€œé˜Ÿåˆ—â€ï¼Œæ‰€è°“é˜»å¡ï¼Œåœ¨å¤šçº¿ç¨‹é¢†åŸŸï¼ŒæŸäº›æƒ…å†µä¸‹ä¼šåˆ®èµ·çº¿ç¨‹ï¼ˆå³çº¿ç¨‹é˜»å¡ï¼‰ï¼Œä¸€æ—¦æ¡ä»¶æ»¡è¶³ï¼Œè¢«æŒ‚èµ·çš„çº¿ç¨‹ä¼˜å…ˆè¢«è‡ªåŠ¨å”¤é†’ã€‚
![](https://user-gold-cdn.xitu.io/2020/4/5/1714a475d7e0c027?w=461&h=176&f=png&s=54561)**Tread 1 å¾€é˜»å¡é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ ï¼ŒThread 2 å¾€é˜»å¡é˜Ÿåˆ—ä¸­ç§»é™¤å…ƒç´ **

1. å½“é˜»å¡é˜Ÿåˆ—æ˜¯ç©ºæ—¶ï¼Œä»é˜Ÿåˆ—ä¸­**è·å–**å…ƒç´ çš„æ“ä½œå°†ä¼šè¢«é˜»å¡ã€‚
 2. å½“é˜»å¡é˜Ÿåˆ—æ˜¯æ»¡æ—¶ï¼Œä»é˜Ÿåˆ—ä¸­**æ·»åŠ **å…ƒç´ çš„æ“ä½œå°†ä¼šè¢«é˜»å¡ã€‚
#### 1ï¼‰ ç§ç±»
1. **ArrayBlockingQueueï¼š** æ˜¯ä¸€ä¸ªåŸºäº**æ•°ç»„ç»“æ„** çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œæ­¤é˜Ÿåˆ—æŒ‰ç…§FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰è§„åˆ™æ’åºã€‚
2. **LinkedBlockingQueueï¼š** æ˜¯ä¸€ä¸ªåŸºäº**é“¾è¡¨ç»“æ„**çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼ˆå¤§å°é»˜è®¤å€¼ä¸ºInteger.MAX_VALUEï¼‰ï¼Œæ­¤é˜Ÿåˆ—æŒ‰ç…§FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰å¯¹å…ƒç´ è¿›è¡Œæ’åºï¼Œååé‡é€šå¸¸è¦é«˜äºArrayBlockingQueueã€‚
3. **SynchronusQueueï¼š** æ˜¯ä¸€ä¸ª**ä¸å‚¨å­˜å…ƒç´ **çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰åˆ°å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ç§»é™¤æ“ä½œï¼Œå¦åˆ™æ’å…¥æ“ä½œä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ï¼Œååé‡é€šå¸¸è¦é«˜äºLinkedBlockingQueueã€‚
4. PriorityBlockingQueueï¼šæ”¯æŒä¼˜å…ˆçº§æ’åºçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—
5. DelayQueueï¼šä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°çš„å»¶è¿Ÿæ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚
6. LinkedTransferQueueï¼šç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚

*ååé‡*ï¼š`SynchronusQueue` > `LinkedBlockingQueue` > `ArrayBlockingQueue`

#### 2ï¼‰ ä½¿ç”¨å¥½å¤„

æˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒä»€ä¹ˆæ—¶å€™èƒ¡éœ€è¦é˜»å¡çº¿ç¨‹ï¼Œä»€ä¹ˆæ—¶å€™éœ€è¦å”¤é†’çº¿ç¨‹ï¼Œå› ä¸ºBlockingQueureéƒ½ä¸€æ‰‹ç»™ä½ åŠå¥½äº†ã€‚åœ¨concurrentåŒ…ï¼Œå‘å¸ƒä»¥å‰ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œ**æˆ‘ä»¬å¿…é¡»è‡ªå·±å»æ§åˆ¶è¿™äº›ç»†èŠ‚ï¼Œå°¤å…¶è¿˜è¦å…¼é¡¾æ•ˆç‡å’Œçº¿ç¨‹å®‰å…¨ï¼Œ** è€Œè¿™ä¼šç»™æˆ‘ä»¬çš„ç¨‹åºå¸¦æ¥ä¸å°çš„å¤æ‚åº¦

#### 3ï¼‰ æ ¸å¿ƒæ–¹æ³•
| æ–¹æ³•ç±»å‹ | æŠ›å¼‚å¸¸    | ç‰¹æ®Šå€¼   | é˜»å¡   | è¶…æ—¶                        |
| -------- | --------- | -------- | ------ | --------------------------- |
| æ’å…¥æ–¹æ³• | add(o)    | offer(o) | put(o) | offer(o, timeout, timeunit) |
| ç§»é™¤æ–¹æ³• | remove(o) | poll()   | take() | poll(timeout, timeunit)     |
| æ£€æŸ¥æ–¹æ³• | element() | peek() | ä¸å¯ç”¨|ä¸å¯ç”¨

- æŠ›å¼‚å¸¸ï¼šå¦‚æœæ“ä½œä¸èƒ½é©¬ä¸Šè¿›è¡Œï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
- ç‰¹æ®Šå€¼ï¼šå¦‚æœæ“ä½œä¸èƒ½é©¬ä¸Šè¿›è¡Œï¼Œå°†ä¼šè¿”å›ä¸€ä¸ªç‰¹æ®Šçš„å€¼ï¼Œä¸€èˆ¬æ˜¯ true æˆ–è€… false
- ä¸€ç›´é˜»å¡ï¼šå¦‚æœæ“ä½œä¸èƒ½é©¬ä¸Šè¿›è¡Œï¼Œæ“ä½œä¼šè¢«é˜»å¡
- è¶…æ—¶é€€å‡ºï¼šå¦‚æœæ“ä½œä¸èƒ½é©¬ä¸Šè¿›è¡Œï¼Œæ“ä½œä¼šè¢«é˜»å¡æŒ‡å®šçš„æ—¶é—´ï¼Œå¦‚æœæŒ‡å®šæ—¶é—´æ²¡æ‰§è¡Œï¼Œåˆ™è¿”å›ä¸€ä¸ªç‰¹æ®Šå€¼ï¼Œä¸€èˆ¬æ˜¯ true æˆ–è€… false
#### 4ï¼‰ç”¨å¤„
- ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼
- çº¿ç¨‹æ± 
- æ¶ˆæ¯ä¸­é—´ä»¶

*ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼--ä¼ ç»Ÿç‰ˆ*ï¼š

![](https://ae01.alicdn.com/kf/H06e5bba9eef949b8aaade6dfd417261de.jpg)

*ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼--é˜»å¡é˜Ÿåˆ—ç‰ˆ*ï¼š

![](https://ae01.alicdn.com/kf/H177cf083c6724a028d3aa2de1527b466z.jpg)

### å…­ã€çº¿ç¨‹æ± 
`æ¦‚å¿µï¼š` çº¿ç¨‹æ± åšçš„å·¥ä½œä¸»è¦æ˜¯æ§åˆ¶è¿è¡Œçš„çº¿ç¨‹çš„æ•°é‡ï¼Œ**å¤„ç†è¿‡ç¨‹ä¸­å°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—**ï¼Œç„¶ååœ¨çº¿ç¨‹åˆ›å»ºåå¯åŠ¨è¿™äº›ä»»åŠ¡ï¼Œ**å¦‚æœçº¿ç¨‹è¶…è¿‡äº†æœ€å¤§æ•°é‡ï¼Œè¶…å‡ºçš„çº¿ç¨‹å°†æ’é˜Ÿç­‰å€™**ï¼Œç­‰å…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œå†ä»é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡æ¥æ‰§è¡Œã€‚
`ç‰¹ç‚¹ï¼š` 

- çº¿ç¨‹å¤ç”¨
- æ§åˆ¶æœ€å¤§å¹¶å‘æ•°
- ç®¡ç†çº¿ç¨‹

`ä¼˜ç‚¹ï¼š`

- é™ä½èµ„æºæ¶ˆè€—ï¼Œé€šè¿‡é‡å¤åˆ©ç”¨è‡ªå·±åˆ›å»ºçš„çº¿ç¨‹å‡ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„æ¶ˆè€—ã€‚
- æé«˜å“åº”é€Ÿåº¦ï¼Œå½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä¸éœ€è¦ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚
- æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§ï¼Œçº¿ç¨‹æ˜¯ç¨€ç¼ºè¥¿è‹‘ï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ä½“ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹å¯ä»¥è¿›è¡Œç»Ÿä¸€åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§ã€‚

#### 1ï¼‰çº¿ç¨‹åˆ›å»ºå‡ ç§æ–¹æ³•
1ï¼‰*ç»§æ‰¿Thead*

```java
class ThreadDemo extends Thread{
    @Override
    public void run() {
        System.out.println("ThreadDemo è¿è¡Œä¸­...");
    }
    public static void main(String[] args) {
        ThreadDemo threadDemo = new ThreadDemo();
        threadDemo.start();
    }
}
```
2ï¼‰*å®ç° Runnable æ¥å£*

```java
class RunnableDemo{
    public static void main(String[] args) {
        new Thread(new Runnable() {
            @Override
            public void run() {
                System.out.println("RunnableDemo è¿è¡Œä¸­...");
            }
        }).start();
    }
}
```
3ï¼‰*å®ç° Callable*

```java
public static void main(String[] args) throws ExecutionException, InterruptedException {
        FutureTask<Integer> futureTask = new FutureTask<>(new Callable<Integer>() {
            @Override
            public Integer call() throws Exception {
                return 1;
            }
        });
        new Thread(futureTask).start();
        System.out.println(futureTask.get());
    }
```
#### 2ï¼‰æ¶æ„è¯´æ˜
Javaä¸­çš„çº¿ç¨‹æ± ä½¿ç”¨è¿‡Excutoræ¡†æ¶å®ç°çš„ï¼Œè¯¥æ¡†æ¶ä¸­ç”¨åˆ°äº†`Executor`ï¼Œ`Executors`ï¼Œ`ExecutorService`ï¼Œ`ThreadPoolExecutor`è¿™å‡ ä¸ªç±»ã€‚

![](https://user-gold-cdn.xitu.io/2020/4/5/1714a475e4d5f336?w=413&h=426&f=png&s=19977)
#### 3ï¼‰é‡ç‚¹äº†è§£
- `Executors.newFixedThreadPool()`
	
	**ç‰¹ç‚¹ï¼š**
	1. åˆ›å»ºä¸€ä¸ªå®šé•¿çº¿ç¨‹æ± ï¼Œå¯æ§åˆ¶çº¿ç¨‹çš„æœ€å¤§å¹¶å‘æ•°ï¼Œè¶…å‡ºçš„çº¿ç¨‹ä¼šåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ã€‚
	2. newFixedThreadPool åˆ›å»ºçš„çº¿ç¨‹æ± CorePoolSizeå’ŒMaximumPoolSizeæ˜¯ç›¸ç­‰çš„ï¼Œå®ƒä½¿ç”¨çš„æ˜¯**LinkedBlockingQueue** ã€‚
	```java
	public static ExecutorService newFixedThreadPool(int nThreads) {
	        return new ThreadPoolExecutor(nThreads, nThreads, 0, 
	                TimeUnit.MICROSECONDS, new LinkedBlockingDeque<Runnable>());
	    }
	```
- `Executors.newSingleThreadExecutor()`
	
	**ç‰¹ç‚¹ï¼š**
	1. åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹åŒ–çš„çº¿ç¨‹æ± ï¼Œå®ƒåªä¼šç”¨å”¯ä¸€çš„å·¥ä½œçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œä¿è¯æ‰€æœ‰ä»»åŠ¡éƒ½æŒ‰ç…§æŒ‡å®šçš„é¡ºåºæ‰§è¡Œã€‚
	2. newSingleThreadExecutorå°†corePoolSizeå’ŒMaximumPoolSizeéƒ½è®¾ç½®ä¸º1ï¼Œå®ƒä½¿ç”¨çš„æ˜¯**LinedBlockingQueue** ã€‚
	```java
  public static ExecutorService newSingleThreadExecutor() {
        return new ThreadPoolExecutor(1, 1, 0,
                TimeUnit.MICROSECONDS, new LinkedBlockingDeque<Runnable>());
	  }
	```
- `Executors.newCachedThreadPool()`
	
	**ç‰¹ç‚¹ï¼š**
	1. åˆ›å»ºä¸€ä¸ªå¯ç¼“å­˜çº¿ç¨‹æ± ï¼Œå¦‚æœçº¿ç¨‹æ± é•¿åº¦è¶…è¿‡å¤„ç†éœ€è¦ï¼Œå¯çµæ´»å›æ”¶ç©ºé—²çº¿ç¨‹ï¼Œè‹¥æ— å¯å›æ”¶ï¼Œåˆ™åˆ›å»ºæ–°çº¿ç¨‹ã€‚
	2. newCacheThreadPoolå°†corePoolsizeè®¾ç½®ä¸º0ï¼ŒMaximumPoolSizeè®¾ç½®ä¸ºInteger.MAX_VALUEï¼Œå®ƒä½¿ç”¨çš„æ˜¯**SynchronousQueue** ï¼Œä¹Ÿå°±æ˜¯è¯´æ¥äº†ä»»åŠ¡å°±åˆ›å»ºçº¿ç¨‹è¿è¡Œï¼Œå¦‚æœçº¿ç¨‹ç©ºé—²è¶…è¿‡60ç§’ï¼Œå°±é”€æ¯çº¿ç¨‹
	```java
  public static ExecutorService newCachedThreadPool() {
        return new ThreadPoolExecutor(0, Integer.MAX_VALUE, 60,
	              TimeUnit.SECONDS, new SynchronousQueue<>());
	 	}
	```
#### 4ï¼‰ä¸ƒå¤§å‚æ•°

|å‚æ•°|	ä½œç”¨|
|--|--|
|corePoolSize|	çº¿ç¨‹æ± ä¸­å¸¸é©»æ ¸å¿ƒçº¿ç¨‹æ•°|
|maximumPoolSize	| çº¿ç¨‹æ± èƒ½å¤Ÿå®¹çº³åŒæ—¶æ‰§è¡Œçš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œéœ€å¤§äº1|
|keepAliveTime	|å¤šä½™ç©ºé—²çº¿ç¨‹çš„å­˜æ´»æ—¶é—´ï¼Œå½“ç©ºé—´æ—¶é—´è¾¾åˆ°keepAliveTimeå€¼æ—¶ï¼Œå¤šä½™çš„çº¿ç¨‹ä¼šè¢«é”€æ¯ç›´åˆ°åªå‰©ä¸‹corePoolSizeä¸ªçº¿ç¨‹ä¸ºæ­¢|
|TimeUnit|	keepAliveTime| æ—¶é—´å•ä½|
|workQueue|	é˜»å¡ä»»åŠ¡é˜Ÿåˆ—|
|threadFactory|	è¡¨ç¤ºç”Ÿæˆçº¿ç¨‹æ± ä¸­å·¥ä½œçº¿ç¨‹çš„çº¿ç¨‹å·¥å‚ï¼Œç”¨æˆ·åˆ›å»ºæ–°çº¿ç¨‹ï¼Œä¸€èˆ¬ç”¨é»˜è®¤å³å¯|
|RejectedExecutionHandler| æ‹’ç»ç­–ç•¥ï¼Œè¡¨ç¤ºå½“çº¿ç¨‹é˜Ÿåˆ—æ»¡äº†å¹¶ä¸”å·¥ä½œçº¿ç¨‹å¤§äºçº¿ç¨‹æ± çš„æœ€å¤§æ˜¾ç¤ºæ•°ï¼ˆmaximumPoolSizeï¼‰æ—¶å¦‚ä½•æ¥æ‹’ç»|

![](https://ae01.alicdn.com/kf/Hf641046bf73f45a4b8d24275b6e0ac78v.jpg)

#### 5ï¼‰çº¿ç¨‹æ± å·¥ä½œåŸç†

![image](https://user-gold-cdn.xitu.io/2020/4/5/1714a475d8bb9142?w=526&h=393&f=png&s=135619)
![image](https://user-gold-cdn.xitu.io/2020/4/5/1714a475db6ae0ce?w=571&h=372&f=png&s=63290)
![image](https://user-gold-cdn.xitu.io/2020/4/5/1714a475dd8527eb?w=1124&h=325&f=png&s=370372)
*ä¾‹å­ï¼š*

å‡è®¾ä¸€å®¶é“¶è¡Œæ€»å…±æœ‰å…­ä¸ªçª—å£ï¼ˆ`maximumPoolSize`ï¼‰ï¼Œå‘¨æœ«å¼€äº†ä¸‰ä¸ªçª—å£æä¾›ä¸šåŠ¡åŠç†ï¼ˆ`corePoolSize`ï¼‰ï¼Œä¸Šç­æœŸé—´æ¥äº†3ä¸ªäººåŠç†ä¸šåŠ¡ï¼Œä¸‰ä¸ªçª—å£èƒ½å¤Ÿåº”ä»˜çš„è¿‡æ¥ï¼Œè¿™ä¸ªæ—¶å€™åˆæ¥äº†1ä¸ªï¼Œä¸‰ä¸ªçª—å£ä¾¿å¿™ä¸è¿‡æ¥äº†ï¼Œï¼Œåªå¥½è®©æ–°æ¥çš„å®¢æˆ·å»ç­‰å¾…åŒºï¼ˆ`workQueue`ï¼‰ç­‰å¾…ï¼Œæ¥ä¸‹æ¥å¦‚æœè¿˜æœ‰æ¥å®¢æˆ·çš„è¯ä¾¿è®©å®¢æˆ·å»ç­‰å¾…åŒºï¼ˆ`workQueue`ï¼‰ç­‰å¾…ã€‚ä½†æ˜¯å¦‚æœç­‰å¾…åŒºä¹Ÿåæ»¡äº†ã€‚ä¸šåŠ¡ç»ç†ï¼ˆ`threadFactory`ï¼‰ä¾¿é€šçŸ¥å‰©ä¸‹çš„çª—å£å¼€å¯æ¥è¿›è¡Œä¸šåŠ¡åŠç†ï¼Œä½†æ˜¯å¦‚æœå…­ä¸ªçª—å£éƒ½å æ»¡äº†ï¼Œè€Œä¸”ç­‰å¾…åŒºä¹Ÿåä¸ä¸‹äº†ã€‚è¿™ä¸ªæ—¶å€™é“¶è¡Œä¾¿è¦è€ƒè™‘é‡‡ç”¨ä»€ä¹ˆæ–¹å¼ï¼ˆ`RejectedExecutionHandler`ï¼‰æ¥æ‹’ç»å®¢æˆ·ã€‚æ—¶é—´æ…¢æ…¢çš„è¿‡å»äº†ï¼ŒåŠç†ä¸šåŠ¡çš„å®¢æˆ·ä¹Ÿå·®ä¸å¤šèµ°äº†ï¼Œåªå‰©ä¸‹3ä¸ªå®¢æˆ·åœ¨åŠç†ã€‚è¿™ä¸ªæ—¶å€™ç©ºé—²äº†3ä¸ªæ–°å¢çš„çª—å£ï¼Œä»–ä»¬ä¾¿å¼€å§‹ç­‰å¾…ï¼ˆ`keepAliveTime`ï¼‰ä¸€å®šæ—¶é—´ï¼Œå¦‚æœæ—¶é—´åˆ°äº†è¿˜æ²¡æœ‰å®¢æˆ·æ¥åŠç†ä¸šåŠ¡çš„è¯ï¼Œè¿™3ä¸ªæ–°å¢çª—å£ä¾¿å¯ä»¥å…³é—­ï¼Œå›å»ä¼‘æ¯ã€‚ä½†æ˜¯åŸæ¥çš„ä¸‰ä¸ªçª—å£ï¼ˆ`corePoolSize`ï¼‰è¿˜å¾—ç»§ç»­å¼€ç€ã€‚

#### 6ï¼‰æ‹’ç»ç­–ç•¥
ç­‰å¾…é˜Ÿåˆ—å·²ç»æ’æ»¡ï¼Œå†ä¹Ÿå¡ä¸ä¸‹æ–°çš„ä»»åŠ¡ï¼Œè€Œä¸”ä¹Ÿè¾¾åˆ°äº† **maximumPoolSize** æ•°é‡ï¼Œæ— æ³•ç»§ç»­ä¸ºæ–°ä»»åŠ¡æœåŠ¡ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬ä¾¿è¦é‡‡å–æ‹’ç»ç­–ç•¥æœºåˆ¶åˆç†çš„å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚
*ä»¥ä¸‹å†…ç½®æ‹’ç»ç­–ç•¥å‡å®ç°äº†RejectExecutionHandleræ¥å£*

- `AbortPolicyï¼ˆé»˜è®¤ï¼‰`ï¼š

ç›´æ¥æŠ›å‡ºRejectedExceptionå¼‚å¸¸æ¥é˜»æ­¢ç³»ç»Ÿæ­£å¸¸è¿è¡Œã€‚

- `CallerRunPolicy`ï¼š

â€œè°ƒç”¨è€…è¿è¡Œâ€ ä¸€ç§è°ƒèŠ‚æœºåˆ¶ï¼Œè¯¥ç­–ç•¥æ—¢ä¸ä¼šæŠ›å¼ƒä»»åŠ¡ï¼Œä¹Ÿä¸ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚çº¿ç¨‹è°ƒç”¨è¿è¡Œè¯¥ä»»åŠ¡çš„ execute æœ¬èº«ã€‚æ­¤ç­–ç•¥æä¾›ç®€å•çš„åé¦ˆæ§åˆ¶æœºåˆ¶ï¼Œèƒ½å¤Ÿå‡ç¼“æ–°ä»»åŠ¡çš„æäº¤é€Ÿåº¦ã€‚

- `DiscardOldestPolicy`ï¼š

æŠ›å¼ƒé˜Ÿåˆ—ä¸­ç­‰å¾…æœ€ä¹…çš„ä»»åŠ¡ï¼Œç„¶åæŠŠå½“å‰ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ä¸­å°è¯•å†æ¬¡æäº¤ï¼ˆå¦‚æœå†æ¬¡å¤±è´¥ï¼Œåˆ™é‡å¤æ­¤è¿‡ç¨‹ï¼‰ã€‚

- `DiscardPolicy`ï¼š

ç›´æ¥ä¸¢å¼ƒä»»åŠ¡ï¼Œä¸äºˆä»»ä½•å¤„ç†ä¹Ÿä¸æŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœå…è®¸ä»»åŠ¡ä¸¢å¤±ï¼Œè¿™æ˜¯æœ€å¥½çš„æ‹’ç»ç­–ç•¥ã€‚

#### 7ï¼‰ä¸ºä½•ä¸ç”¨JDKåˆ›å»ºçº¿ç¨‹æ± çš„æ–¹æ³•
>é˜¿é‡Œå·´å·´ java å¼€å‘æ‰‹å†Œ
>`ã€å¼ºåˆ¶ã€‘`çº¿ç¨‹èµ„æºå¿…é¡»é€šè¿‡çº¿ç¨‹æ± æä¾›ï¼Œä¸å…è®¸åœ¨åº”ç”¨ä¸­è‡ªè¡Œæ˜¾ç¤ºåˆ›å»ºçº¿ç¨‹ã€‚è¯´æ˜ï¼šä½¿ç”¨çº¿ç¨‹æ± çš„å¥½å¤„æ˜¯**å‡å°‘åœ¨åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ä¸Šæ‰€æ¶ˆè€—çš„æ—¶é—´ä»¥åŠç³»ç»Ÿèµ„æºçš„å¼€é”€ï¼Œè§£å†³èµ„æºä¸è¶³çš„é—®é¢˜ã€‚å¦‚æœä¸ä½¿ç”¨çº¿ç¨‹æ± ï¼Œæœ‰å¯èƒ½é€ æˆç³»ç»Ÿåˆ›å»ºå¤§é‡åŒç±»çº¿ç¨‹è€Œå¯¼è‡´æ¶ˆè€—å®Œå†…å­˜æˆ–è€…â€œè¿‡åº¦åˆ‡æ¢â€çš„é—®é¢˜ã€‚**
>`ã€å¼ºåˆ¶ã€‘` çº¿ç¨‹æ± ä¸å…è®¸ä½¿ç”¨Executorså»åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡ThreadPoolExecutorçš„æ–¹å¼ï¼Œè¿™æ ·çš„å¤„ç†æ–¹å¼è®©å†™çš„åŒå­¦æ›´åŠ æ˜ç¡®çº¿ç¨‹æ± çš„è¿è¡Œè§„åˆ™ï¼Œè§„é¿èµ„æºè€—å°½çš„é£é™©ã€‚
>
> 1.  `FixedThreadPool` å’Œ `SingleThreadPool`ï¼šå…è®¸çš„è¯·æ±‚é˜Ÿåˆ—é•¿åº¦ä¸ºInteger.MAX_VALUEï¼Œå¯èƒ½ä¼šå †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´OOMã€‚
>  2.  `CacheThreadPool` å’Œ `ScheduledThreadPool` ï¼šå…è®¸åˆ›å»ºçº¿ç¨‹çš„æ•°é‡ä¸ºInteger.MAX_VALUEï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çš„çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´OOMã€‚
*ä¾‹å­ï¼š*

![](https://ae01.alicdn.com/kf/H5860d60cef174628b8a7a84a5533e6564.jpg)

#### 8ï¼‰åˆç†é…ç½®çº¿ç¨‹æ± 
*CPUå¯†é›†å‹*ï¼š

+  æŸ¥çœ‹æœ¬æœºCPUæ ¸æ•°ï¼š`Runtime.getRuntime().availableProcessors() `
+ CPUå¯†é›†çš„æ„æ€æ˜¯è¯¥ä»»åŠ¡éœ€è¦å¤§é‡çš„è¿ç®—ï¼Œè€Œæ²¡æœ‰é˜»å¡ï¼ŒCPUéœ€ä¸€ç›´å…¨é€Ÿè¿è¡Œã€‚
+ CPUå¯†é›†ä»»åŠ¡åªæœ‰åœ¨çœŸæ­£çš„å¤šæ ¸CPUä¸Šæ‰å¯èƒ½å¾—åˆ°åŠ é€Ÿï¼ˆé€šè¿‡å¤šçº¿ç¨‹ï¼‰
+ CPUå¯†é›†å‹ä»»åŠ¡é…ç½®å°½å¯èƒ½å°‘çš„çº¿ç¨‹æ•°é‡ => å…¬å¼ï¼šCPUæ ¸æ•°+1ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± 

*IOå¯†é›†å‹*ï¼š

+ ç”±äºIOå¯†é›†å‹ä»»åŠ¡çº¿ç¨‹å¹¶ä¸æ˜¯ä¸€ç›´åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œåˆ™åº”é…ç½®å°½å¯èƒ½å¤šçš„çº¿ç¨‹ï¼Œå¦‚CPUæ ¸æ•° * 2 
+ IOå¯†é›†å‹ï¼Œæ˜¯è¯´æ˜è¯¥ä»»åŠ¡éœ€è¦å¤§é‡çš„IOï¼Œå³å¤§é‡çš„é˜»å¡ã€‚æ‰€ä»¥åœ¨å•çº¿ç¨‹ä¸Šè¿è¡ŒIOå¯†é›†å‹çš„ä»»åŠ¡ä¼šå¯¼è‡´æµªè´¹å¤§é‡çš„CPUè¿ç®—èƒ½åŠ›æµªè´¹åœ¨ç­‰å¾…ä¸Šï¼Œæ‰€ä»¥è¦ä½¿ç”¨å¤šçº¿ç¨‹å¯ä»¥å¤§å¤§çš„åŠ é€Ÿç¨‹åºè¿è¡Œï¼Œå³ä½¿åœ¨å•æ ¸CPUä¸Šï¼Œè¿™ç§åŠ é€Ÿä¸»è¦å°±æ˜¯åˆ©ç”¨äº†è¢«æµªè´¹æ‰çš„é˜»å¡æ—¶é—´ã€‚
+ é…ç½®çº¿ç¨‹å…¬å¼ï¼šCPUæ ¸æ•° / 1-é˜»å¡ç³»æ•°ï¼ˆ0.8~0.9ï¼‰ =>å¦‚8æ ¸CPUï¼š8 / 1 - 0.9 = 80ä¸ªçº¿ç¨‹æ•°

### ä¸ƒã€æ­»é”ç¼–ç åŠå®šä½åˆ†æ

#### 1ï¼‰ä»€ä¹ˆæ˜¯æ­»é”

>æ­»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå› äº‰å¤ºèµ„æºè€Œé€ æˆçš„ä¸€ç§äº’ç›¸ç­‰å¾…çš„ç°è±¡ï¼Œå¦‚æœæ— å¤–åŠ›çš„å¹²æ¶‰é‚£ä¹ˆå®ƒä»¬å°†æ— æ³•æ¨è¿›ä¸‹å»ï¼Œå¦‚æœç³»ç»Ÿçš„èµ„æºå……è¶³ï¼Œè¿›ç¨‹çš„èµ„æºè¯·æ±‚éƒ½èƒ½å¤Ÿå¾—åˆ°æ»¡è¶³ï¼Œæ­»é”å‡ºç°çš„å¯èƒ½æ€§å°±å¾ˆä½ï¼Œå¦åˆ™ä¼šå› äº‰å¤ºæœ‰é™çš„èµ„æºè€Œé™·å…¥æ­»é”ã€‚

![](https://user-gold-cdn.xitu.io/2020/4/5/1714a4760baaec9c?w=672&h=354&f=png&s=106295)
#### 2)é€ æˆåŸå› 
 - `èµ„æºç³»ç»Ÿä¸è¶³`
 - `è¿›ç¨‹è¿è¡Œæ¨è¿›çš„é¡ºåºä¸åˆé€‚`
 - `èµ„æºåˆ†é…ä¸å½“`

*ä¾‹å­*ï¼š

![](https://ae01.alicdn.com/kf/H996717b4120e46568341e500ea5a6d30k.jpg)

**æ‰“å°ç»“æœ**
é™·å…¥æ­»é”çŠ¶æ€ï¼š
![](https://user-gold-cdn.xitu.io/2020/4/5/1714a4761335004e?w=657&h=91&f=png&s=4228)
#### 3)è§£å†³æ–¹æ³•
 - ##### `jps` å‘½ä»¤å®šä½è¿›ç¨‹ç¼–å·

  ![](https://user-gold-cdn.xitu.io/2020/4/5/1714a476178f7296?w=437&h=148&f=png&s=3806)
 - ##### `jstack` æ‰¾åˆ°æ­»é”æŸ¥çœ‹

  ![](https://user-gold-cdn.xitu.io/2020/4/5/1714a4761e446b53?w=1002&h=543&f=png&s=86313)

![çœ‹å®Œä¸èµï¼Œéƒ½æ˜¯åè›‹](https://imgconvert.csdnimg.cn/aHR0cHM6Ly93d3cuNTJkb3V0dS5jbi9zdGF0aWMvdGVtcC9waWMvOWJkNjhkMTUwZjA3ODdjNTYwYTQzOWRhMzU5YTU4MGEucG5n?x-oss-process=image/format,png#pic_center)

> ä»Šå¤©çš„ä½ å¤šåŠªåŠ›ä¸€ç‚¹ï¼Œæ˜å¤©çš„ä½ å°±èƒ½å°‘è¯´ä¸€å¥æ±‚äººçš„è¯ï¼
>
> *æˆ‘æ˜¯å°èœï¼Œä¸€ä¸ªå’Œä½ ä¸€èµ·å­¦ä¹ çš„ç”·äººã€‚* `ğŸ’‹`